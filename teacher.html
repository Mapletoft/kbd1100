<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KBD1100 ‚Äì Teacher Dashboard</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Firebase SDKs (compat) + your config -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
        padding: 20px;
        margin: 0;
    }
    
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #003d7a 0%, #0056b3 100%);
        color: white;
        padding: 25px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .dashboard-header h1 {
        margin: 0;
        font-size: 24px;
    }
    
    .dashboard-content {
        padding: 30px;
    }
    
    .toolbar {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    
    .toolbar input {
        flex: 1;
        max-width: 400px;
        padding: 10px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
    }
    
    .toolbar button {
        padding: 10px 20px;
        background: #0056b3;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
    }
    
    .toolbar button:hover {
        background: #003d7a;
    }
    
    #signOut {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        padding: 8px 20px;
        border-radius: 20px;
    }
    
    #signOut:hover {
        background: rgba(255,255,255,0.3);
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    
    th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
    }
    
    td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    tr:hover {
        background: #f9f9f9;
    }
    
    .pill {
        background: #0056b3;
        color: white;
        font-size: 14px;
        border-radius: 20px;
        padding: 5px 15px;
        display: inline-block;
    }
    
    .table-container {
        overflow-x: auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
</style>
</head>
  
<body>
  <div class="dashboard-container">
    <div class="dashboard-header">
      <div>
        <h1>üë®‚Äçüè´ Teacher Dashboard - KBD1100</h1>
        <span id="me" class="pill" style="margin-top: 10px;"></span>
      </div>
      <button id="signOut">Sign Out</button>
    </div>

    <div class="dashboard-content">
      <div class="toolbar">
        <input id="filterText" type="text" placeholder="Filter by email, name, or exercise..." />
        <button id="refresh">üîÑ Refresh</button>
        <span id="count" class="pill"></span>
      </div>

      <div class="table-container">
        <table id="progressTable">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Exercise</th>
              <th>Status</th>
              <th>Best WPM</th>
              <th>Best Accuracy</th>
              <th>Attempts</th>
              <th>Last Attempt</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    
    const TEACHER_UID = "CVBEuoweirfSPLhjfm499puLrcn2";

    // Gate access: only the teacher UID may view
    auth.onAuthStateChanged(async (user) => {
      if (!user) { location.href = 'index.html'; return; }
      document.getElementById('me').textContent = user.email;
      if (user.uid !== TEACHER_UID) {
        // If a student somehow navigates here, kick them to the student app
        location.href = 'typing.html';
        return;
      }
      await loadProgress();
    });

    document.getElementById('signOut').onclick = () => auth.signOut().then(() => location.href='index.html');
    document.getElementById('refresh').onclick = () => loadProgress();
    document.getElementById('filterText').addEventListener('input', () => renderRows(window.__rows || []));

    async function loadProgress() {
      // Query ALL progress documents across users (rules allow only teacher)
      const snap = await db.collectionGroup('progress').get();

      // Collect all UIDs to fetch profile docs (for email/name)
      const rows = snap.docs.map(d => {
        const data = d.data();
        const pathParts = d.ref.path.split('/'); // users/{uid}/progress/{exerciseId}
        const uid = pathParts[1];
        return {
          uid,
          exerciseId: d.id,
          status: data.status || '',
          bestWPM: data.bestWPM ?? '',
          bestAccuracy: data.bestAccuracy ?? '',
          attempts: data.attempts ?? '',
          lastAttemptAt: data.lastAttemptAt?.toDate ? data.lastAttemptAt.toDate() : null
        };
      });

      // Fetch profiles in parallel
      const uniqueUids = [...new Set(rows.map(r => r.uid))];
      const profiles = {};
      await Promise.all(uniqueUids.map(async uid => {
        const p = await db.collection('users').doc(uid).get();
        profiles[uid] = p.exists ? p.data() : {};
      }));

      // Enrich rows
      rows.forEach(r => {
        const p = profiles[r.uid] || {};
        r.email = p.email || '';
        const fn = (p.firstName || '').trim();
        const ln = (p.lastName || '').trim();
        r.name = (fn || ln) ? `${fn} ${ln}`.trim() : '';
      });

      window.__rows = rows;
      renderRows(rows);
    }

function renderRows(rows) {
    const tbody = document.querySelector('#progressTable tbody');
    tbody.innerHTML = '';
    const q = document.getElementById('filterText').value.toLowerCase().trim();

    const filtered = rows.filter(r => {
        if (!q) return true;
        // Convert exercise ID to readable format for filtering
        const exerciseName = formatExercise(r.exerciseId);
        return (
            (r.email||'').toLowerCase().includes(q) ||
            (r.name||'').toLowerCase().includes(q) ||
            exerciseName.toLowerCase().includes(q) ||
            (r.status||'').toLowerCase().includes(q)
        );
    });

    filtered.sort((a,b) => (b.lastAttemptAt?.getTime?.()||0) - (a.lastAttemptAt?.getTime?.()||0));

    for (const r of filtered) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${escapeHtml(r.email || '')}</td>
            <td>${escapeHtml(r.name || 'Not Set')}</td>
            <td>${formatExercise(r.exerciseId)}</td>
            <td>${formatStatus(r.status || '')}</td>
            <td>${r.bestWPM ?? ''}</td>
            <td>${r.bestAccuracy ? r.bestAccuracy + '%' : ''}</td>
            <td>${r.attempts ?? ''}</td>
            <td>${r.lastAttemptAt ? r.lastAttemptAt.toLocaleString() : ''}</td>
        `;
        tbody.appendChild(tr);
    }

    document.getElementById('count').textContent = `${filtered.length} rows`;
}

// Add these helper functions right after renderRows
function formatExercise(exerciseId) {
    // Convert "lesson-1-stage-3" to "Lesson 1 - Stage 3"
    if (!exerciseId) return '';
    const match = exerciseId.match(/lesson-(\d+)-stage-(\d+)/);
    if (match) {
        const lessonNames = {
            1: "Home Row",
            2: "Top Row",
            3: "Bottom Row",
            4: "Numbers",
            5: "Shift Keys",
            6: "Caps Lock",
            7: "Symbols L1",
            8: "Symbols L2",
            9: "Mixed Practice",
            10: "Speed Builder",
            11: "Accuracy Focus",
            12: "Numeric Keypad"
        };
        const lessonNum = match[1];
        const stageNum = match[2];
        const lessonName = lessonNames[lessonNum] || `Lesson ${lessonNum}`;
        return `${lessonName} - Stage ${stageNum}`;
    }
    return exerciseId;
}

function formatStatus(status) {
    if (status === 'completed') return '‚úÖ Completed';
    if (status === 'in_progress') return 'üîÑ In Progress';
    return status;
}

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }
  </script>
</body>

</html>


