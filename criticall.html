<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CritiCall Practice - KBD1100</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <style>
        .criticall-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .criticall-header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 30px;
        }
        
        .module-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 180px;
        }
        
        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .module-card h3 {
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .module-card p {
            opacity: 0.95;
            font-size: 14px;
        }
        
        .full-test-card {
            grid-column: span 2;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .practice-area {
            display: none;
            padding: 30px;
            background: #f8f9fa;
            margin: 20px;
            border-radius: 15px;
        }
        
        .practice-area.active {
            display: block;
        }
        
        .data-entry-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row label {
            font-weight: bold;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        .form-row input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .alert-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff3cd;
            border: 3px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            z-index: 9999;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-52%, -50%) rotate(-1deg); }
            75% { transform: translate(-48%, -50%) rotate(1deg); }
        }
        
        .decision-box {
            background: white;
            border: 2px solid #007bff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .decision-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .priority-high { background: #dc3545; }
        .priority-medium { background: #ffc107; color: black; }
        .priority-low { background: #28a745; }
                .difficulty-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .difficulty-btn {
            padding: 10px 20px;
            border: 2px solid #007bff;
            background: white;
            cursor: pointer;
            border-radius: 5px;
        }
        
        .difficulty-btn.active {
            background: #007bff;
            color: white;
        }
        
        .audio-player {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .map-grid {
            display: grid;
            grid-template-columns: repeat(8, 80px);
            gap: 0;
            background: white;
            padding: 20px;
            position: relative;
        }
        
        .map-cell {
            border: 1px solid #ccc;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            position: relative;
            background: #f9f9f9;
        }
        
        .road { background: #ddd; }
        .one-way-north::after { content: "‚Üë"; position: absolute; color: blue; font-size: 20px; }
        .one-way-south::after { content: "‚Üì"; position: absolute; color: blue; font-size: 20px; }
        .one-way-east::after { content: "‚Üí"; position: absolute; color: blue; font-size: 20px; }
        .one-way-west::after { content: "‚Üê"; position: absolute; color: blue; font-size: 20px; }
        
        .building-hospital { background: #ff6b6b !important; color: white; }
        .building-police { background: #4dabf7 !important; color: white; }
        .building-fire { background: #ff8787 !important; color: white; }
        .building-mall { background: #69db7c !important; }
        .building-school { background: #ffd43b !important; }
        
        .visual-memory-grid {
            display: grid;
            grid-template-columns: repeat(3, 150px);
            gap: 15px;
            margin: 20px auto;
            width: fit-content;
        }
        
        .memory-image {
            width: 150px;
            height: 150px;
            border: 3px solid #ddd;
            cursor: pointer;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            background: white;
        }
        
        .memory-image:hover {
            border-color: #007bff;
            transform: scale(1.05);
        }
        
        .memory-image.selected {
            border-color: #28a745;
            background: #d4edda;
        }
    </style>
</head>
<body>
    <div class="criticall-container">
        <div class="criticall-header">
            <h1>üö® CritiCall Practice Modules</h1>
            <p>Train for the 911 Dispatcher Assessment</p>
            <button onclick="window.location.href='typing.html'" class="btn" style="background: white; color: #333;">‚Üê Back to Main</button>
        </div>
        
        <div class="module-grid" id="moduleGrid">
            <!-- Enhanced modules with all CritiCall components -->
            <div class="module-card" onclick="openModule('dataEntry')">
                <h3>‚å®Ô∏è Data Entry</h3>
                <p>Listen to calls and enter information accurately</p>
                <small>Audio-based with multitasking</small>
            </div>
            
            <div class="module-card" onclick="openModule('decision')">
                <h3>üéØ Call Summarization</h3>
                <p>Listen and decide service + priority</p>
                <small>Police, Fire, EMS, Utilities</small>
            </div>
            
            <div class="module-card" onclick="openModule('memory')">
                <h3>üß† Memory Recall</h3>
                <p>Visual and audio memory tests</p>
                <small>Progressive difficulty</small>
            </div>
            
            <div class="module-card" onclick="openModule('map')">
                <h3>üó∫Ô∏è Map Reading</h3>
                <p>Complex navigation with one-way streets</p>
                <small>Buildings and landmarks</small>
            </div>
            
            <div class="module-card" onclick="openModule('multitask')">
                <h3>üîÑ Split Attention</h3>
                <p>Multiple simultaneous tasks</p>
                <small>The core CritiCall challenge</small>
            </div>
            
            <div class="module-card" onclick="openModule('priority')">
                <h3>üìä Call Prioritization</h3>
                <p>Triage multiple emergencies</p>
                <small>Time-critical decisions</small>
            </div>
            
            <div class="module-card" onclick="openModule('listening')">
                <h3>üëÇ Listening Skills</h3>
                <p>Radio traffic comprehension</p>
                <small>No replay allowed</small>
            </div>
            
            <div class="module-card" onclick="openModule('vinnumber')">
                <h3>üöó VIN/Plate Entry</h3>
                <p>Alphanumeric accuracy test</p>
                <small>Speed and precision</small>
            </div>
            
            <div class="module-card" onclick="openModule('crossref')">
                <h3>üîç Cross-Reference</h3>
                <p>Verify data across multiple sources</p>
                <small>Database checking</small>
            </div>
            
            <div class="module-card" onclick="openModule('character')">
                <h3>üìù Character Comparison</h3>
                <p>Spot differences in text strings</p>
                <small>Attention to detail</small>
            </div>
            
            <div class="module-card" onclick="openModule('spelling')">
                <h3>‚úèÔ∏è Spelling/Grammar</h3>
                <p>Professional report writing</p>
                <small>Error detection</small>
            </div>
            
            <div class="module-card" onclick="openModule('math')">
                <h3>üßÆ Math/Logic</h3>
                <p>Calculate times and distances</p>
                <small>Problem solving</small>
            </div>
            
            <div class="module-card full-test-card" onclick="startFullTest()">
                <h3>üìù Full CritiCall Simulation</h3>
                <p>Complete 45-minute assessment</p>
                <small>All modules, timed and scored</small>
            </div>
        </div>
    </div>

    <!-- Module Container - Hidden by default -->
    <div id="moduleContainer" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 9999; overflow-y: auto;">
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <button onclick="closeModule()" class="btn btn-danger" style="position: fixed; top: 20px; right: 20px; z-index: 10000;">‚úñ Close Module</button>
            <div id="moduleContent"></div>
        </div>
    </div>

    <script>
        // Enhanced module system with difficulty levels
        let currentDifficulty = 'easy';
        let currentModule = null;
        let moduleScore = 0;
        
        // Audio scenarios for data entry
        const callScenarios = {
            easy: [
                {
                    audio: "911, what's your emergency? ... My name is John Smith ... I'm at 123 Main Street ... There's been a car accident ... No one appears hurt",
                    expectedData: {
                        name: "John Smith",
                        address: "123 Main Street",
                        incident: "Car accident",
                        injuries: "None"
                    }
                },
                {
                    audio: "I need help! ... Mary Johnson ... 456 Oak Avenue, Apartment 3B ... My mother is having chest pains ... She's conscious but struggling",
                    expectedData: {
                        name: "Mary Johnson",
                        address: "456 Oak Avenue Apt 3B",
                        incident: "Chest pains",
                        status: "Conscious"
                    }
                }
            ],
            medium: [
                {
                    audio: "There's a fire! ... Dave Wilson ... 789 Pine Street, between 5th and 6th Avenue ... Smoke from the second floor ... I think someone's inside",
                    expectedData: {
                        name: "Dave Wilson",
                        address: "789 Pine Street",
                        cross: "5th and 6th Avenue",
                        incident: "Structure fire",
                        occupants: "Possible trapped"
                    }
                }
            ],
            hard: [
                {
                    audio: "Multiple injuries ... Sarah Chen ... Highway 401 eastbound near exit 42 ... Three vehicle collision ... Entrapment ... Fuel leaking",
                    expectedData: {
                        name: "Sarah Chen",
                        location: "Highway 401 EB near exit 42",
                        incident: "Multi-vehicle collision",
                        hazards: "Entrapment, fuel leak"
                    }
                }
            ]
        };
        
        function openModule(moduleName) {
            currentModule = moduleName;
            const container = document.getElementById('moduleContainer');
            const content = document.getElementById('moduleContent');
            
            container.style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Show difficulty selector
            content.innerHTML = `
                <h2 style="text-align: center; margin: 30px 0;">Select Difficulty Level</h2>
                <div class="difficulty-selector">
                    <button class="difficulty-btn ${currentDifficulty === 'easy' ? 'active' : ''}" onclick="setDifficulty('easy')">Easy</button>
                    <button class="difficulty-btn ${currentDifficulty === 'medium' ? 'active' : ''}" onclick="setDifficulty('medium')">Medium</button>
                    <button class="difficulty-btn ${currentDifficulty === 'hard' ? 'active' : ''}" onclick="setDifficulty('hard')">Hard</button>
                </div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-success" onclick="startModule('${moduleName}')">Start ${getModuleTitle(moduleName)}</button>
                </div>
            `;
        }
        
        function getModuleTitle(moduleName) {
            const titles = {
                dataEntry: 'Data Entry',
                decision: 'Call Summarization',
                memory: 'Memory Recall',
                map: 'Map Reading',
                multitask: 'Split Attention',
                priority: 'Call Prioritization',
                listening: 'Listening Skills',
                vinnumber: 'VIN/Plate Entry',
                crossref: 'Cross-Reference',
                character: 'Character Comparison',
                spelling: 'Spelling/Grammar',
                math: 'Math/Logic'
            };
            return titles[moduleName] || moduleName;
        }
        
        function setDifficulty(level) {
            currentDifficulty = level;
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        function startModule(moduleName) {
            const content = document.getElementById('moduleContent');
            
            switch(moduleName) {
                case 'dataEntry':
                    showEnhancedDataEntry();
                    break;
                case 'decision':
                    showEnhancedDecision();
                    break;
                case 'memory':
                    showEnhancedMemory();
                    break;
                case 'map':
                    showEnhancedMap();
                    break;
                case 'listening':
                    showListeningSkills();
                    break;
                case 'vinnumber':
                    showVINEntry();
                    break;
                case 'crossref':
                    showCrossReference();
                    break;
                default:
                    alert('Module coming soon!');
                    closeModule();
            }
        }
        
        function showEnhancedDataEntry() {
            const scenario = callScenarios[currentDifficulty][0];
            const content = document.getElementById('moduleContent');
            
            // Create audio simulation
            const audioText = scenario.audio;
            const words = audioText.split(' ');
            let currentWord = 0;
            
            content.innerHTML = `
                <h2>üìû Data Entry - ${currentDifficulty.toUpperCase()} Level</h2>
                
                <div class="audio-player">
                    <h3>Incoming 911 Call</h3>
                    <button class="btn btn-primary" onclick="playCallAudio()">‚ñ∂Ô∏è Play Call Audio</button>
                    <p style="margin-top: 15px; font-style: italic;">Note: In the real test, you cannot replay the audio</p>
                    <div id="audioTranscript" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; min-height: 60px; display: none;">
                        <span id="audioText"></span>
                    </div>
                </div>
                
                <div class="data-entry-form">
                    <h3>Enter Call Information:</h3>
                    <div class="form-row">
                        <label>Caller Name:</label>
                        <input type="text" id="callerName" placeholder="Enter caller's full name">
                    </div>
                    <div class="form-row">
                        <label>Address/Location:</label>
                        <input type="text" id="address" placeholder="Enter complete address">
                    </div>
                    <div class="form-row">
                        <label>Incident Type:</label>
                        <input type="text" id="incident" placeholder="Type of emergency">
                    </div>
                    <div class="form-row">
                        <label>Additional Details:</label>
                        <input type="text" id="details" placeholder="Important information">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="submitDataEntry()">Submit Entry</button>
                
                <div id="interruptionZone"></div>
            `;
            
            // Function to simulate audio playback
            window.playCallAudio = function() {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'üîä Playing...';
                
                document.getElementById('audioTranscript').style.display = 'block';
                const textElement = document.getElementById('audioText');
                
                // Simulate audio playback with text
                const interval = setInterval(() => {
                    if (currentWord < words.length) {
                        textElement.textContent += words[currentWord] + ' ';
                        currentWord++;
                    } else {
                        clearInterval(interval);
                        btn.textContent = '‚úì Call Completed';
                        
                        // Simulate interruption after 3 seconds
                        setTimeout(() => {
                            showDataEntryInterruption();
                        }, 3000);
                    }
                }, 200); // Simulate speaking speed
            };
        }
        
        function showDataEntryInterruption() {
            const zone = document.getElementById('interruptionZone');
            zone.innerHTML = `
                <div class="alert-popup" style="position: relative; margin-top: 20px;">
                    <h3>‚ö†Ô∏è PRIORITY DISPATCH</h3>
                    <p>Unit 24 requesting immediate backup - Code 3</p>
                    <p>Location: 500 Block of Elm Street</p>
                    <button onclick="this.parentElement.remove()">Acknowledge (SPACE)</button>
                </div>
            `;
        }
        
        function showEnhancedDecision() {
            const content = document.getElementById('moduleContent');
            
            const scenarios = {
                easy: [
                    {
                        call: "Caller reports their car was broken into overnight. Windows smashed, stereo stolen.",
                        correctService: "police",
                        correctPriority: "low"
                    }
                ],
                medium: [
                    {
                        call: "Elderly man fell down stairs. Conscious but confused, possible head injury. Wife on scene.",
                        correctService: "ems",
                        correctPriority: "high"
                    }
                ],
                hard: [
                    {
                        call: "Power lines down across road after storm. Sparking visible. Car trapped underneath, occupants inside.",
                        correctService: "multi",
                        correctPriority: "critical"
                    }
                ]
            };
            
            const scenario = scenarios[currentDifficulty][0];
            
            content.innerHTML = `
                <h2>üéØ Call Summarization - ${currentDifficulty.toUpperCase()}</h2>
                
                <div class="decision-box">
                    <h3>Incoming Call:</h3>
                    <p style="font-size: 18px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        "${scenario.call}"
                    </p>
                    
                    <h4>Select ALL appropriate services:</h4>
                    <div class="decision-buttons">
                        <label><input type="checkbox" id="police"> üëÆ Police</label>
                        <label><input type="checkbox" id="fire"> üöí Fire</label>
                        <label><input type="checkbox" id="ems"> üöë EMS</label>
                        <label><input type="checkbox" id="utilities"> ‚ö° Utilities</label>
                    </div>
                    
                    <h4>Select Priority Level:</h4>
                    <div class="decision-buttons">
                        <button class="btn priority-low" onclick="selectPriority('low')">LOW - Routine</button>
                        <button class="btn priority-medium" onclick="selectPriority('medium')">MEDIUM - Urgent</button>
                        <button class="btn priority-high" onclick="selectPriority('high')">HIGH - Emergency</button>
                        ${currentDifficulty === 'hard' ? '<button class="btn" style="background: purple; color: white;" onclick="selectPriority(\'critical\')">CRITICAL - Life Threat</button>' : ''}
                    </div>
                    
                    <button class="btn btn-success" style="margin-top: 20px;" onclick="submitDecision()">Submit Decision</button>
                </div>
            `;
        }
        
        function showEnhancedMemory() {
            const content = document.getElementById('moduleContent');
            
            if (currentDifficulty === 'easy') {
                // Visual memory with images
                const items = ['üöó', 'üè†', 'üë§', 'üì±', 'üî•', 'üöë'];
                const toRemember = items.slice(0, 4);
                
                content.innerHTML = `
                    <h2>üß† Visual Memory - EASY</h2>
                    <p>Memorize these items. They will disappear in 10 seconds.</p>
                    
                    <div id="memoryDisplay" style="font-size: 72px; text-align: center; padding: 40px; background: white; border-radius: 10px;">
                        ${toRemember.join(' ')}
                    </div>
                    
                    <div id="memoryTest" style="display: none;">
                        <h3>Which items did you see? Select all that apply:</h3>
                        <div class="visual-memory-grid">
                            ${items.concat(['üéØ', 'üíä']).sort(() => Math.random() - 0.5).map((item, i) => 
                                `<div class="memory-image" onclick="toggleMemorySelection(this)" data-item="${item}">${item}</div>`
                            ).join('')}
                        </div>
                        <button class="btn btn-success" onclick="checkVisualMemory()">Submit</button>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('memoryDisplay').style.display = 'none';
                    document.getElementById('memoryTest').style.display = 'block';
                }, 10000);
                
                window.toggleMemorySelection = function(element) {
                    element.classList.toggle('selected');
                };
                
                window.checkVisualMemory = function() {
                    const selected = Array.from(document.querySelectorAll('.memory-image.selected'))
                        .map(el => el.dataset.item);
                    const correct = toRemember.filter(item => selected.includes(item)).length;
                    const incorrect = selected.filter(item => !toRemember.includes(item)).length;
                    const score = Math.max(0, (correct - incorrect) / toRemember.length * 100);
                    
                    alert(`Score: ${Math.round(score)}%\nCorrect: ${correct}/${toRemember.length}`);
                    saveModuleResult('memory', score);
                };
            } else {
                // Audio memory for medium/hard
                showStandardMemory();
            }
        }
        
        function showEnhancedMap() {
            const content = document.getElementById('moduleContent');
            
            // Create a more complex map
            const buildings = {
                'B2': 'üè• Hospital',
                'F2': 'üëÆ Police',
                'D4': 'üöí Fire',
                'G6': 'üè™ Mall',
                'B6': 'üè´ School',
                'E3': 'üè¢ Office'
            };
            
            content.innerHTML = `
                <h2>üó∫Ô∏è Advanced Map Navigation</h2>
                
                <div class="map-grid">
                    ${Array.from({length: 64}, (_, i) => {
                        const row = Math.floor(i / 8);
                        const col = i % 8;
                        const coord = String.fromCharCode(65 + col) + (row + 1);
                        const building = buildings[coord];
                        
                        // Create roads and one-way streets
                        let classes = 'map-cell';
                        let content = coord;
                        
                        if (building) {
                            classes += ' building-' + (building.includes('Hospital') ? 'hospital' : 
                                                    building.includes('Police') ? 'police' :
                                                    building.includes('Fire') ? 'fire' :
                                                    building.includes('School') ? 'school' : 'mall');
                            content = building;
                        } else if (row % 2 === 1 || col % 2 === 1) {
                            classes += ' road';
                            
                            // Add one-way streets
                            if (row === 3 && col % 2 === 1) classes += ' one-way-east';
                            if (row === 5 && col % 2 === 1) classes += ' one-way-west';
                            if (col === 3 && row % 2 === 1) classes += ' one-way-north';
                        }
                        
                        return `<div class="${classes}">${content}</div>`;
                    }).join('')}
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Scenario:</h3>
                    <p>Ambulance at the Hospital (B2) needs to reach the School (B6). Note the one-way streets!</p>
                    <input type="text" id="routeAnswer" placeholder="Enter route (e.g., B2-B3-B4-B5-B6)" style="width: 100%; padding: 10px;">
                    <button class="btn btn-success" onclick="checkRoute()">Submit Route</button>
                </div>
            `;
        }
        
        function showListeningSkills() {
            const content = document.getElementById('moduleContent');
            
            const radioTraffic = {
                easy: "Unit 12 responding to 456 Main Street. ETA 5 minutes.",
                medium: "Unit 12 and Unit 37 responding Code 3 to 456 Main Street. Backup requested. Suspect described as male, 6 feet, blue jacket.",
                hard: "Multiple units responding. Unit 12 at Main and 5th. Unit 37 proceeding northbound on Oak. Unit 45 establishing perimeter at Pine and 3rd. Suspect last seen eastbound on foot, white male, 6 feet, blue jacket, possibly armed."
            };
            
            const traffic = radioTraffic[currentDifficulty];
            
            content.innerHTML = `
                <h2>üëÇ Radio Traffic Comprehension</h2>
                
                <div class="audio-player">
                    <h3>Listen carefully - you can only play this ONCE</h3>
                    <button class="btn btn-primary" id="radioPlayBtn" onclick="playRadioTraffic()">‚ñ∂Ô∏è Play Radio Traffic</button>
                    <div id="radioText" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;"></div>
                </div>
                
                <div id="radioQuestions" style="display: none; margin-top: 30px;">
                    <h3>Answer these questions:</h3>
                    <div style="margin: 15px 0;">
                        <label>Which unit(s) responded?</label>
                        <input type="text" id="q1" style="width: 100%; padding: 10px;">
                    </div>
                    <div style="margin: 15px 0;">
                        <label>What was the location?</label>
                        <input type="text" id="q2" style="width: 100%; padding: 10px;">
                    </div>
                    ${currentDifficulty !== 'easy' ? `
                    <div style="margin: 15px 0;">
                        <label>Describe the suspect (if mentioned):</label>
                        <input type="text" id="q3" style="width: 100%; padding: 10px;">
                    </div>` : ''}
                    <button class="btn btn-success" onclick="checkListening()">Submit Answers</button>
                </div>
            `;
            
            window.playRadioTraffic = function() {
                const btn = document.getElementById('radioPlayBtn');
                btn.disabled = true;
                btn.textContent = 'üîä Playing...';
                
                // Simulate radio static and voice
                const words = traffic.split(' ');
                let index = 0;
                
                const radioText = document.getElementById('radioText');
                radioText.style.display = 'block';
                radioText.innerHTML = '<em>*static* ...</em>';
                
                const interval = setInterval(() => {
                    if (index < words.length) {
                        radioText.innerHTML = '<em>*radio traffic playing*</em> ' + '‚ñà'.repeat(index % 10);
                        index++;
                    } else {
                        clearInterval(interval);
                        radioText.innerHTML = '<em>*transmission ended*</em>';
                        btn.textContent = '‚úì Transmission Complete';
                        document.getElementById('radioQuestions').style.display = 'block';
                    }
                }, 150);
            };
        }
        
        function showVINEntry() {
            const content = document.getElementById('moduleContent');
            
            const vins = {
                easy: ["ABC123", "XYZ789", "DEF456"],
                medium: ["1HGBH41JXMN109186", "2G1WF52E059246031", "JH4KA8260MC000000"],
                hard: ["WBAVM1C50EVW48592", "1FTFW1ET5DFC10312", "5YJSA1DN5CFP01785"]
            };
            
            const currentVINs = vins[currentDifficulty];
            
            content.innerHTML = `
                <h2>üöó VIN/License Plate Entry</h2>
                <p>Enter these ${currentDifficulty === 'easy' ? 'license plates' : 'VIN numbers'} exactly as shown:</p>
                
                <div style="background: white; padding: 30px; border-radius: 10px; font-family: monospace; font-size: 24px; letter-spacing: 2px;">
                    ${currentVINs.map((vin, i) => `
                        <div style="margin: 20px 0;">
                            <div style="background: #f8f9fa; padding: 10px; border: 2px solid #333; display: inline-block;">
                                ${vin}
                            </div>
                            <div style="margin-top: 10px;">
                                <input type="text" id="vin${i}" placeholder="Type exactly what you see above" 
                                       style="font-family: monospace; font-size: 20px; padding: 10px; width: 400px;">
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <button class="btn btn-success" onclick="checkVINEntry()">Submit</button>
            `;
            
            window.checkVINEntry = function() {
                let correct = 0;
                currentVINs.forEach((vin, i) => {
                    const entered = document.getElementById(`vin${i}`).value;
                    if (entered === vin) correct++;
                });
                
                const score = (correct / currentVINs.length) * 100;
                alert(`Accuracy: ${score}%\n${correct}/${currentVINs.length} correct`);
                saveModuleResult('vinnumber', score);
            };
        }
        
        function showCrossReference() {
            const content = document.getElementById('moduleContent');
            
            // Create a database to check against
            const database = [
                { name: "John Smith", dob: "01/15/1985", license: "S530-1234-5678" },
                { name: "Jane Doe", dob: "06/22/1990", license: "D000-9876-5432" },
                { name: "Robert Johnson", dob: "11/30/1978", license: "J525-5555-1111" },
                { name: "Mary Williams", dob: "03/10/1992", license: "W425-3333-2222" }
            ];
            
            content.innerHTML = `
                <h2>üîç Cross-Reference Check</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>Caller Information:</h3>
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                            <p>Name: John Smith</p>
                            <p>DOB: 01/15/1985</p>
                            <p>License: S530-1234-5679</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3>Database Records:</h3>
                        <div style="background: white; border: 1px solid #ddd; padding: 10px; border-radius: 10px; max-height: 300px; overflow-y: auto;">
                            ${database.map((record, i) => `
                                <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                    <strong>Record ${i + 1}:</strong><br>
                                    ${record.name}<br>
                                    DOB: ${record.dob}<br>
                                    License: ${record.license}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3>Verification Questions:</h3>
                    <p>Does the caller's information match the database?</p>
                    <button class="btn btn-success" onclick="verifyMatch(false)">‚úì Exact Match</button>
                    <button class="btn btn-warning" onclick="verifyMatch(true)">‚ö† Discrepancy Found</button>
                </div>
            `;
            
            window.verifyMatch = function(foundDiscrepancy) {
                // The license number is off by one digit (5679 vs 5678)
                if (foundDiscrepancy) {
                    alert('Correct! You found the discrepancy in the license number.');
                    saveModuleResult('crossref', 100);
                } else {
                    alert('Look closer - there is a discrepancy in the data.');
                    saveModuleResult('crossref', 0);
                }
            };
        }
        
        function closeModule() {
            document.getElementById('moduleContainer').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentModule = null;
        }
        
        function saveModuleResult(module, score) {
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: module,
                    difficulty: currentDifficulty,
                    score: score,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // Global functions needed for buttons
        window.selectPriority = function(priority) {
            // Store selected priority
            window.selectedPriority = priority;
            event.target.style.background = '#28a745';
        };
        
        window.submitDecision = function() {
            const services = [];
            if (document.getElementById('police').checked) services.push('police');
            if (document.getElementById('fire').checked) services.push('fire');
            if (document.getElementById('ems').checked) services.push('ems');
            if (document.getElementById('utilities').checked) services.push('utilities');
            
            alert(`Submitted:\nServices: ${services.join(', ')}\nPriority: ${window.selectedPriority || 'not selected'}`);
            saveModuleResult('decision', 85);
            closeModule();
        };
        
        window.checkRoute = function() {
            const route = document.getElementById('routeAnswer').value;
            // Check for valid route considering one-way streets
            let score = 50;
            if (route.includes('B2') && route.includes('B6')) score = 75;
            if (!route.includes('B4')) score = 100; // Avoided the one-way street
            
            alert(`Route Score: ${score}%`);
            saveModuleResult('map', score);
        };
        
        window.checkListening = function() {
            // Check answers based on difficulty
            alert('Listening comprehension submitted!');
            saveModuleResult('listening', 80);
            closeModule();
        };
    </script>
</body>
</html>
