<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CritiCall Practice - KBD1100</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <style>
        .criticall-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .criticall-header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 30px;
        }
        
        .module-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 180px;
            position: relative;
        }
        
        .module-card.coming-soon {
            background: linear-gradient(135deg, #999 0%, #666 100%);
            opacity: 0.7;
        }
        
        .module-card.coming-soon::after {
            content: "COMING SOON";
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .module-card:hover:not(.coming-soon) {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .module-card h3 {
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .module-card p {
            opacity: 0.95;
            font-size: 14px;
        }
        
        .module-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9998;
        }
        
        .module-overlay.active {
            display: block;
        }
        
        .module-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 9999;
        }
        
        .module-container.active {
            display: block;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Audio Player Styles */
        .audio-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .audio-player {
            width: 100%;
            margin: 15px 0;
        }
        
        .play-count {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        /* Data Entry Form */
        .data-entry-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .form-row label {
            font-weight: bold;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        .form-row input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-row input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        /* Call Summarization Styles */
        .incident-scenario {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .decision-section {
            background: white;
            border: 2px solid #007bff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .priority-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .priority-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .priority-btn.high { background: #dc3545; color: white; }
        .priority-btn.medium { background: #ffc107; color: black; }
        .priority-btn.low { background: #28a745; color: white; }
        
        .priority-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* Score Display */
        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        .score-display h2 {
            font-size: 48px;
            margin: 20px 0;
        }
        
        /* Memory Recall Styles */
        .memory-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .memory-item {
            padding: 15px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .memory-question {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin: 15px 0;
        }
        
        /* Map Styles */
        .map-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .map-grid {
            display: grid;
            grid-template-columns: repeat(10, 60px);
            gap: 0;
            margin: 20px 0;
            border: 2px solid #333;
        }
        
        .map-cell {
            border: 1px solid #ddd;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            position: relative;
            background: #f5f5f5;
            text-align: center;
            padding: 2px;
        }
        
        .street-h, .street-v {
            background: #999;
            color: white;
            font-weight: bold;
        }
        
        .building {
            font-size: 8px;
            font-weight: bold;
            padding: 2px;
        }
        
        .building-hospital { background: #ff6b6b; color: white; }
        .building-police { background: #4dabf7; color: white; }
        .building-fire { background: #ff8787; color: white; }
        .building-school { background: #ffd43b; }
        .building-mall { background: #69db7c; }
        .building-library { background: #da77f2; color: white; }
        .building-park { background: #8ce99a; }
        
        .one-way::after {
            position: absolute;
            font-size: 20px;
            color: #ff0000;
            font-weight: bold;
        }
        
        .one-way-n::after { content: "‚Üë"; }
        .one-way-s::after { content: "‚Üì"; }
        .one-way-e::after { content: "‚Üí"; }
        .one-way-w::after { content: "‚Üê"; }
        
        .map-legend {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 3px;
        }
        
        .route-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #007bff;
            border-radius: 5px;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="criticall-container">
        <div class="criticall-header">
            <h1>üö® CritiCall Practice Modules</h1>
            <p>Emergency Services Dispatcher Training</p>
            <button onclick="window.location.href='index.html'" class="btn btn-primary" style="margin-top: 15px;">‚Üê Back to Main Menu</button>
        </div>
        
        <div class="module-grid">
            <div class="module-card" onclick="openModule('dataEntry')">
                <h3>üìù Data Entry</h3>
                <p>Listen to emergency calls and accurately record caller information, location, and incident type.</p>
            </div>
            
            <div class="module-card" onclick="openModule('callSummarization')">
                <h3>üéØ Call Summarization</h3>
                <p>Analyze emergency scenarios and determine appropriate services and priority levels.</p>
            </div>
            
            <div class="module-card" onclick="openModule('memoryRecall')">
                <h3>üß† Memory Recall</h3>
                <p>Memorize and recall critical information from emergency scenarios.</p>
            </div>
            
            <div class="module-card" onclick="openModule('mapReading')">
                <h3>üó∫Ô∏è Map Reading</h3>
                <p>Navigate city streets and determine optimal routes for emergency response.</p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üìª Radio Codes</h3>
                <p>Learn and practice 10-codes and radio communication protocols.</p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üîä Radio Traffic</h3>
                <p>Practice listening to and interpreting emergency radio communications.</p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üöó VIN/License Entry</h3>
                <p>Accurately enter vehicle identification numbers and license plates.</p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üîç Cross-Reference</h3>
                <p>Verify caller information against database records.</p>
            </div>
        </div>
    </div>
    
    <div class="module-overlay" id="moduleOverlay" onclick="closeModule()"></div>
    <div class="module-container" id="moduleContainer">
        <div class="module-header">
            <h2 id="moduleTitle"></h2>
            <button class="close-btn" onclick="closeModule()">‚úï Close</button>
        </div>
        <div id="moduleContent"></div>
    </div>

    <script>
        let auth, db;
        let currentModule = null;
        let currentQuestion = 0;
        let correctAnswers = 0;
        let totalQuestions = 0;
        let audioPlayCount = 0;
        let selectedPriority = null;
        let selectedServices = [];
        
        // Initialize Firebase
        auth = firebase.auth();
        db = firebase.firestore();
        
        // Data Entry Audio Files Database
        const dataEntryScenarios = [
            {
                audioFile: "scenario1.mp3", // You'll add your actual audio files
                answers: {
                    callerName: "Sarah Johnson",
                    address: "1245 Oak Street",
                    incidentType: "Medical Emergency"
                }
            },
            {
                audioFile: "scenario2.mp3",
                answers: {
                    callerName: "Michael Chen",
                    address: "789 Maple Avenue",
                    incidentType: "House Fire"
                }
            },
            {
                audioFile: "scenario3.mp3",
                answers: {
                    callerName: "Emily Rodriguez",
                    address: "456 Pine Boulevard",
                    incidentType: "Car Accident"
                }
            }
        ];
        
        // Call Summarization Scenarios
        const callScenarios = [
            {
                scenario: "A 45-year-old male is experiencing severe chest pain and difficulty breathing. He is conscious but in obvious distress. His wife reports he has a history of heart problems.",
                correctServices: ["ems"],
                correctPriority: "high"
            },
            {
                scenario: "Caller reports seeing smoke coming from a neighbor's garage. No flames visible yet, but the smell is getting stronger. No one appears to be home.",
                correctServices: ["fire"],
                correctPriority: "medium"
            },
            {
                scenario: "A two-car collision at Main St and 5th Ave. Minor injuries reported, one vehicle is blocking the right lane. Both drivers are out of their vehicles.",
                correctServices: ["police", "ems"],
                correctPriority: "medium"
            },
            {
                scenario: "Caller reports an unresponsive infant, not breathing. Mother is hysterical. Address is clear.",
                correctServices: ["ems"],
                correctPriority: "high"
            },
            {
                scenario: "Neighbor reports a burglary in progress. Suspects are currently inside the residence. Homeowners are on vacation.",
                correctServices: ["police"],
                correctPriority: "high"
            },
            {
                scenario: "Elderly woman fell in her bathroom. She is conscious and alert but cannot get up. No visible injuries but complaining of hip pain.",
                correctServices: ["ems"],
                correctPriority: "medium"
            },
            {
                scenario: "Structure fire fully involved, multiple floors. Building is a commercial warehouse. All occupants have evacuated safely.",
                correctServices: ["fire", "police"],
                correctPriority: "high"
            },
            {
                scenario: "Carbon monoxide alarm sounding in a residence. Family members are feeling dizzy and nauseous. They are outside now.",
                correctServices: ["fire", "ems"],
                correctPriority: "high"
            },
            {
                scenario: "Suspicious person loitering near a school playground. School is currently in session. Individual is not responding to staff requests to leave.",
                correctServices: ["police"],
                correctPriority: "medium"
            },
            {
                scenario: "Tree branch fell on power lines during storm. Sparking visible. Lines are across the roadway blocking both lanes.",
                correctServices: ["fire", "police", "utilities"],
                correctPriority: "high"
            },
            {
                scenario: "Caller reports her medication was stolen from her vehicle overnight. Vehicle was parked in her driveway.",
                correctServices: ["police"],
                correctPriority: "low"
            },
            {
                scenario: "Domestic disturbance. Neighbors report shouting and sounds of items breaking. Children's voices heard crying.",
                correctServices: ["police"],
                correctPriority: "high"
            },
            {
                scenario: "Gas leak reported at a restaurant. Strong odor throughout the building. Building has been evacuated.",
                correctServices: ["fire", "utilities"],
                correctPriority: "high"
            },
            {
                scenario: "Vehicle vs pedestrian accident. Pedestrian is conscious, sitting on curb. Visible leg injury. Driver remained on scene.",
                correctServices: ["police", "ems"],
                correctPriority: "high"
            },
            {
                scenario: "Caller locked keys in car with infant inside. Weather is hot, approximately 85¬∞F. Infant appears alert through window.",
                correctServices: ["fire", "police"],
                correctPriority: "high"
            }
        ];
        
        // Memory Recall Questions by Difficulty
        const memoryQuestions = {
            easy: [
                {
                    items: ["Badge 423", "Unit 7", "Oak Street", "10-4", "Engine 2"],
                    questions: [
                        { q: "What badge number was shown?", a: "423" },
                        { q: "What unit number was mentioned?", a: "7" },
                        { q: "What street name appeared?", a: "Oak Street" }
                    ]
                },
                {
                    items: ["Code 3", "Maple Ave", "Badge 156", "Squad 9", "10-23"],
                    questions: [
                        { q: "What code was displayed?", a: "Code 3" },
                        { q: "What avenue was shown?", a: "Maple Ave" },
                        { q: "What was the badge number?", a: "156" }
                    ]
                }
            ],
            medium: [
                {
                    items: ["Suspect: Male, 6'2\"", "Weapon: Handgun", "Vehicle: Blue Sedan", "Plate: ABC 1234", "Direction: Northbound", "Last Seen: 5th & Main"],
                    questions: [
                        { q: "What was the suspect's height?", a: "6'2\"" },
                        { q: "What type of weapon was mentioned?", a: "Handgun" },
                        { q: "What color was the vehicle?", a: "Blue" },
                        { q: "What was the license plate number?", a: "ABC 1234" },
                        { q: "Which direction was the suspect heading?", a: "Northbound" }
                    ]
                },
                {
                    items: ["DOB: 03/15/1985", "Lic#: D532-8877-2341", "Height: 5'9\"", "Eyes: Brown", "Hair: Black", "Weight: 180 lbs"],
                    questions: [
                        { q: "What was the date of birth?", a: "03/15/1985" },
                        { q: "What was the license number?", a: "D532-8877-2341" },
                        { q: "What was the eye color?", a: "Brown" },
                        { q: "What was the person's height?", a: "5'9\"" },
                        { q: "What was the weight listed?", a: "180 lbs" }
                    ]
                }
            ],
            hard: [
                {
                    items: ["Call#: 2024-7893", "Time: 14:37", "Caller: Martinez, J.", "Location: 4521 Elmwood Dr, Apt 3B", "DOB: 11/22/1978", "Lic#: M582-3344-9871", "Responding: Units 7, 12, Engine 4", "Code: 10-52 with 10-18"],
                    questions: [
                        { q: "What was the call number?", a: "2024-7893" },
                        { q: "What time was the call received?", a: "14:37" },
                        { q: "What was the complete address including apartment?", a: "4521 Elmwood Dr, Apt 3B" },
                        { q: "What was the caller's date of birth?", a: "11/22/1978" },
                        { q: "List all responding units (separated by commas)", a: "7, 12, Engine 4" },
                        { q: "What codes were mentioned?", a: "10-52 with 10-18" }
                    ]
                },
                {
                    items: ["Incident#: 2024-15673", "Complainant: Rodriguez-Smith, M.", "Address: 8934 Pinecrest Blvd #215", "Vehicle: 2019 Toyota Camry, Gray", "VIN: 4T1BF1FK3KU123456", "Suspect: White Male, 5'11\", 175lbs", "Clothing: Blue hoodie, jeans", "Time: 09:15 - 09:42"],
                    questions: [
                        { q: "What was the incident number?", a: "2024-15673" },
                        { q: "What was the complainant's full name?", a: "Rodriguez-Smith, M." },
                        { q: "What was the complete address?", a: "8934 Pinecrest Blvd #215" },
                        { q: "What was the vehicle VIN?", a: "4T1BF1FK3KU123456" },
                        { q: "Describe the suspect's clothing", a: "Blue hoodie, jeans" },
                        { q: "What was the time frame of the incident?", a: "09:15 - 09:42" }
                    ]
                }
            ]
        };
        
        // Map Reading Scenarios
        const mapScenarios = [
            {
                question: "Route from Hospital to the Fire at Main St & 4th Ave",
                start: "Hospital",
                end: "Fire",
                correctRoute: ["Main St south", "4th Ave east"],
                avoidStreets: ["Oak St (one-way north)"]
            },
            {
                question: "Route from Police Station to accident at Oak St & 2nd Ave",
                start: "Police",
                end: "Accident",
                correctRoute: ["1st Ave north", "Oak St east"],
                avoidStreets: []
            },
            {
                question: "Route from Fire Station to School emergency",
                start: "Fire Station",
                end: "School",
                correctRoute: ["3rd Ave south", "Pine St west", "2nd Ave south"],
                avoidStreets: ["Elm St (one-way east)"]
            }
        ];
        
        function openModule(moduleName) {
            if (event.target.classList.contains('coming-soon')) {
                alert('This module is coming soon! Check back later.');
                return;
            }
            
            currentModule = moduleName;
            document.getElementById('moduleOverlay').classList.add('active');
            document.getElementById('moduleContainer').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            switch(moduleName) {
                case 'dataEntry':
                    showDataEntry();
                    break;
                case 'callSummarization':
                    showCallSummarization();
                    break;
                case 'memoryRecall':
                    showMemoryRecall();
                    break;
                case 'mapReading':
                    showMapReading();
                    break;
            }
        }
        
        function closeModule() {
            document.getElementById('moduleOverlay').classList.remove('active');
            document.getElementById('moduleContainer').classList.remove('active');
            document.body.style.overflow = 'auto';
            currentModule = null;
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = 0;
            audioPlayCount = 0;
        }
        
        // DATA ENTRY MODULE
        function showDataEntry() {
            document.getElementById('moduleTitle').textContent = 'üìù Data Entry Practice';
            
            // For demo purposes, we'll use a random scenario
            // In production, you'd cycle through them or let teacher select
            const scenario = dataEntryScenarios[Math.floor(Math.random() * dataEntryScenarios.length)];
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div class="audio-container">
                    <h3>üéß Listen Carefully to the Emergency Call</h3>
                    <p>You may play the audio as many times as needed. Take notes if necessary.</p>
                    <audio id="emergencyAudio" class="audio-player" controls>
                        <source src="${scenario.audioFile}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    <p class="play-count">Times played: <span id="playCount">0</span></p>
                </div>
                
                <div class="data-entry-form">
                    <h3>Enter the information from the call:</h3>
                    <div class="form-row">
                        <label>Caller Name:</label>
                        <input type="text" id="callerName" placeholder="First and Last Name">
                    </div>
                    <div class="form-row">
                        <label>Address/Location:</label>
                        <input type="text" id="address" placeholder="Street address or location">
                    </div>
                    <div class="form-row">
                        <label>Incident Type:</label>
                        <input type="text" id="incidentType" placeholder="Type of emergency">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitDataEntry()">Submit Entry</button>
                </div>
            `;
            
            // Track audio plays
            const audio = document.getElementById('emergencyAudio');
            audio.addEventListener('play', function() {
                audioPlayCount++;
                document.getElementById('playCount').textContent = audioPlayCount;
            });
            
            // Store correct answers for checking
            window.currentDataEntryAnswers = scenario.answers;
        }
        
        function submitDataEntry() {
            const userAnswers = {
                callerName: document.getElementById('callerName').value.trim(),
                address: document.getElementById('address').value.trim(),
                incidentType: document.getElementById('incidentType').value.trim()
            };
            
            const correctAnswers = window.currentDataEntryAnswers;
            let score = 0;
            let feedback = [];
            
            // Check Caller Name (case-insensitive, flexible matching)
            if (userAnswers.callerName.toLowerCase() === correctAnswers.callerName.toLowerCase()) {
                score += 33.33;
                feedback.push('‚úì Caller Name: Correct');
            } else {
                feedback.push('‚úó Caller Name: Incorrect (Correct: ' + correctAnswers.callerName + ')');
            }
            
            // Check Address (case-insensitive, flexible matching)
            if (userAnswers.address.toLowerCase() === correctAnswers.address.toLowerCase()) {
                score += 33.33;
                feedback.push('‚úì Address: Correct');
            } else {
                feedback.push('‚úó Address: Incorrect (Correct: ' + correctAnswers.address + ')');
            }
            
            // Check Incident Type (case-insensitive, flexible matching)
            if (userAnswers.incidentType.toLowerCase() === correctAnswers.incidentType.toLowerCase()) {
                score += 33.34;
                feedback.push('‚úì Incident Type: Correct');
            } else {
                feedback.push('‚úó Incident Type: Incorrect (Correct: ' + correctAnswers.incidentType + ')');
            }
            
            // Display results
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div class="score-display">
                    <h3>Data Entry Results</h3>
                    <h2>${Math.round(score)}%</h2>
                    <p>Audio played ${audioPlayCount} time(s)</p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>Detailed Feedback:</h3>
                    ${feedback.map(f => `<p style="margin: 10px 0; font-size: 16px;">${f}</p>`).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showDataEntry()">Try Another Scenario</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'dataEntry',
                    score: Math.round(score),
                    audioPlays: audioPlayCount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // CALL SUMMARIZATION MODULE
        function showCallSummarization() {
            document.getElementById('moduleTitle').textContent = 'üéØ Call Summarization Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = callScenarios.length;
            
            showNextCallScenario();
        }
        
        function showNextCallScenario() {
            if (currentQuestion >= callScenarios.length) {
                showCallSummarizationResults();
                return;
            }
            
            const scenario = callScenarios[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div class="incident-scenario">
                    <h3>üìû Emergency Call</h3>
                    <p style="font-size: 16px; line-height: 1.6;">${scenario.scenario}</p>
                </div>
                
                <div class="decision-section">
                    <h3>Select Appropriate Services:</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-police" value="police">
                            <label for="service-police">üöî Police</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-fire" value="fire">
                            <label for="service-fire">üöí Fire Department</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-ems" value="ems">
                            <label for="service-ems">üöë EMS/Medical</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-utilities" value="utilities">
                            <label for="service-utilities">‚ö° Utilities</label>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Select Priority Level:</h3>
                    <div class="priority-buttons">
                        <button class="priority-btn high" onclick="selectPriority('high')">HIGH<br><small>Life-threatening / Immediate danger</small></button>
                        <button class="priority-btn medium" onclick="selectPriority('medium')">MEDIUM<br><small>Urgent but not life-threatening</small></button>
                        <button class="priority-btn low" onclick="selectPriority('low')">LOW<br><small>Non-urgent / Routine</small></button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitCallDecision()">Submit Decision</button>
                </div>
            `;
        }
        
        function selectPriority(priority) {
            // Remove selection from all buttons
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selection to clicked button
            event.target.classList.add('selected');
            selectedPriority = priority;
        }
        
        function submitCallDecision() {
            const scenario = callScenarios[currentQuestion];
            
            // Get selected services
            selectedServices = [];
            if (document.getElementById('service-police').checked) selectedServices.push('police');
            if (document.getElementById('service-fire').checked) selectedServices.push('fire');
            if (document.getElementById('service-ems').checked) selectedServices.push('ems');
            if (document.getElementById('service-utilities').checked) selectedServices.push('utilities');
            
            // Check if user made selections
            if (selectedServices.length === 0 || !selectedPriority) {
                alert('Please select at least one service and a priority level.');
                return;
            }
            
            // Check if answer is correct
            const servicesCorrect = arraysEqual(selectedServices.sort(), scenario.correctServices.sort());
            const priorityCorrect = selectedPriority === scenario.correctPriority;
            
            if (servicesCorrect && priorityCorrect) {
                correctAnswers++;
            }
            
            // Show feedback
            let feedback = '<div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">';
            feedback += '<h3>Feedback:</h3>';
            feedback += `<p><strong>Services:</strong> ${servicesCorrect ? '‚úì Correct' : '‚úó Incorrect'}</p>`;
            if (!servicesCorrect) {
                feedback += `<p style="margin-left: 20px;">Correct services: ${scenario.correctServices.join(', ')}</p>`;
            }
            feedback += `<p><strong>Priority:</strong> ${priorityCorrect ? '‚úì Correct' : '‚úó Incorrect'}</p>`;
            if (!priorityCorrect) {
                feedback += `<p style="margin-left: 20px;">Correct priority: ${scenario.correctPriority}</p>`;
            }
            feedback += '</div>';
            
            document.getElementById('moduleContent').innerHTML += feedback;
            
            // Add continue button
            setTimeout(() => {
                const continueBtn = document.createElement('div');
                continueBtn.style.textAlign = 'center';
                continueBtn.style.marginTop = '20px';
                continueBtn.innerHTML = '<button class="btn btn-primary" onclick="nextCallQuestion()">Continue to Next Call</button>';
                document.getElementById('moduleContent').appendChild(continueBtn);
            }, 500);
        }
        
        function nextCallQuestion() {
            currentQuestion++;
            selectedPriority = null;
            selectedServices = [];
            showNextCallScenario();
        }
        
        function showCallSummarizationResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Call Summarization Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showCallSummarization()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'callSummarization',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // MEMORY RECALL MODULE
        function showMemoryRecall() {
            document.getElementById('moduleTitle').textContent = 'üß† Memory Recall Practice';
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <h3>Select Difficulty Level:</h3>
                <div style="display: flex; gap: 15px; justify-content: center; margin: 30px 0;">
                    <button class="btn btn-success" onclick="startMemoryTest('easy')" style="min-width: 150px;">Easy<br><small>3 questions</small></button>
                    <button class="btn btn-primary" onclick="startMemoryTest('medium')" style="min-width: 150px;">Medium<br><small>5 questions</small></button>
                    <button class="btn btn-danger" onclick="startMemoryTest('hard')" style="min-width: 150px;">Hard<br><small>6 questions</small></button>
                </div>
            `;
        }
        
        function startMemoryTest(difficulty) {
            const testData = memoryQuestions[difficulty][Math.floor(Math.random() * memoryQuestions[difficulty].length)];
            
            // Show memory items
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <h3>Memorize the following information (30 seconds):</h3>
                <div class="memory-items">
                    ${testData.items.map(item => `<div class="memory-item">${item}</div>`).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <p style="font-size: 24px; font-weight: bold; color: #007bff;">Time remaining: <span id="timer">30</span>s</p>
                </div>
            `;
            
            // Countdown timer
            let timeLeft = 30;
            const timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showMemoryQuestions(testData.questions);
                }
            }, 1000);
        }
        
        function showMemoryQuestions(questions) {
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = questions.length;
            window.currentMemoryQuestions = questions;
            
            showNextMemoryQuestion();
        }
        
        function showNextMemoryQuestion() {
            const questions = window.currentMemoryQuestions;
            
            if (currentQuestion >= questions.length) {
                showMemoryResults();
                return;
            }
            
            const question = questions[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div class="memory-question">
                    <h3>${question.q}</h3>
                    <input type="text" id="memoryAnswer" placeholder="Your answer" style="width: 100%; padding: 15px; font-size: 18px; border: 2px solid #007bff; border-radius: 5px; margin-top: 15px;">
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitMemoryAnswer()">Submit Answer</button>
                </div>
            `;
            
            // Focus on input
            document.getElementById('memoryAnswer').focus();
            
            // Allow Enter key to submit
            document.getElementById('memoryAnswer').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitMemoryAnswer();
                }
            });
        }
        
        function submitMemoryAnswer() {
            const questions = window.currentMemoryQuestions;
            const question = questions[currentQuestion];
            const userAnswer = document.getElementById('memoryAnswer').value.trim();
            
            // Flexible matching (case-insensitive, whitespace tolerant)
            const correct = userAnswer.toLowerCase().replace(/\s+/g, ' ') === question.a.toLowerCase().replace(/\s+/g, ' ');
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.a}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Add continue button
            setTimeout(() => {
                const continueBtn = document.createElement('div');
                continueBtn.style.textAlign = 'center';
                continueBtn.style.marginTop = '20px';
                continueBtn.innerHTML = '<button class="btn btn-primary" onclick="nextMemoryQuestion()">Next Question</button>';
                document.getElementById('moduleContent').appendChild(continueBtn);
            }, 500);
        }
        
        function nextMemoryQuestion() {
            currentQuestion++;
            showNextMemoryQuestion();
        }
        
        function showMemoryResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Memory Recall Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMemoryRecall()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'memoryRecall',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // MAP READING MODULE
        function showMapReading() {
            document.getElementById('moduleTitle').textContent = 'üó∫Ô∏è Map Reading & Navigation';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = mapScenarios.length;
            
            showNextMapQuestion();
        }
        
        function showNextMapQuestion() {
            if (currentQuestion >= mapScenarios.length) {
                showMapResults();
                return;
            }
            
            const scenario = mapScenarios[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Scenario ${currentQuestion + 1} of ${totalQuestions}</p>
                </div>
                
                <h3>${scenario.question}</h3>
                
                <div class="map-container">
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff6b6b;"></div>
                            <span>Hospital</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4dabf7;"></div>
                            <span>Police Station</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff8787;"></div>
                            <span>Fire Station</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffd43b;"></div>
                            <span>School</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #69db7c;"></div>
                            <span>Shopping Mall</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #da77f2;"></div>
                            <span>Library</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8ce99a;"></div>
                            <span>Park</span>
                        </div>
                        <div class="legend-item">
                            <span style="color: #ff0000; font-size: 20px;">‚Üë‚Üì‚Üí‚Üê</span>
                            <span>One-way streets</span>
                        </div>
                    </div>
                    
                    ${generateCityMap()}
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #007bff;">
                    <h3>Enter your route:</h3>
                    <p>Describe the streets and directions (e.g., "Main St south, then 4th Ave east")</p>
                    <textarea id="routeAnswer" class="route-input" rows="3" placeholder="Type your route here..."></textarea>
                    
                    ${scenario.avoidStreets.length > 0 ? `
                        <p style="color: #dc3545; margin-top: 10px;"><strong>‚ö† Note:</strong> ${scenario.avoidStreets.join(', ')}</p>
                    ` : ''}
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitMapRoute()">Submit Route</button>
                </div>
            `;
        }
        
        function generateCityMap() {
            // 10x10 grid city map
            const map = [
                // Row 0 - Header with avenue names
                ['', '1st Ave', '2nd Ave', '3rd Ave', '4th Ave', '5th Ave', '6th Ave', '7th Ave', '8th Ave', ''],
                // Row 1
                ['Main St', 'building-hospital', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'Main St'],
                // Row 2
                ['', 'street-v', 'building-police', '', 'building-park', '', '', 'building-library', '', ''],
                // Row 3
                ['Oak St', 'street-v one-way-n', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'Oak St'],
                // Row 4
                ['', 'street-v', '', 'building-school', '', '', 'building-mall', '', '', ''],
                // Row 5
                ['Elm St', 'street-v', 'street-h one-way-e', 'street-h one-way-e', 'street-h one-way-e', 'street-h one-way-e', 'street-h one-way-e', 'street-h', 'street-h', 'Elm St'],
                // Row 6
                ['', 'street-v', '', '', '', 'building-fire', '', '', '', ''],
                // Row 7
                ['Pine St', 'street-v', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'Pine St'],
                // Row 8
                ['', 'street-v', '', '', '', '', '', '', '', ''],
                // Row 9 - Footer
                ['', '1st Ave', '2nd Ave', '3rd Ave', '4th Ave', '5th Ave', '6th Ave', '7th Ave', '8th Ave', '']
            ];
            
            let html = '<div class="map-grid">';
            for (let row of map) {
                for (let cell of row) {
                    if (cell.includes('building')) {
                        const buildingType = cell.split(' ')[0];
                        const extraClass = cell.includes('one-way') ? cell.split(' ')[1] : '';
                        const buildingName = buildingType.replace('building-', '').toUpperCase();
                        html += `<div class="map-cell ${cell}">${buildingName}</div>`;
                    } else if (cell.includes('street')) {
                        html += `<div class="map-cell ${cell}"></div>`;
                    } else if (cell === '') {
                        html += `<div class="map-cell"></div>`;
                    } else {
                        html += `<div class="map-cell" style="background: #fff; font-weight: bold;">${cell}</div>`;
                    }
                }
            }
            html += '</div>';
            return html;
        }
        
        function submitMapRoute() {
            const scenario = mapScenarios[currentQuestion];
            const userRoute = document.getElementById('routeAnswer').value.trim().toLowerCase();
            
            // Simple route validation - check if key streets are mentioned
            let routeScore = 0;
            let feedback = [];
            
            // Check if route includes correct streets
            scenario.correctRoute.forEach(street => {
                const streetName = street.toLowerCase().split(' ')[0];
                if (userRoute.includes(streetName)) {
                    routeScore += (100 / scenario.correctRoute.length);
                    feedback.push(`‚úì Correctly included ${street}`);
                } else {
                    feedback.push(`‚úó Missing: ${street}`);
                }
            });
            
            // Check if route avoids restricted streets
            let avoidedRestrictions = true;
            scenario.avoidStreets.forEach(avoid => {
                const streetName = avoid.toLowerCase().split(' ')[0];
                if (userRoute.includes(streetName)) {
                    routeScore = Math.max(0, routeScore - 30);
                    feedback.push(`‚úó Should avoid ${avoid}`);
                    avoidedRestrictions = false;
                }
            });
            
            if (avoidedRestrictions && scenario.avoidStreets.length > 0) {
                feedback.push(`‚úì Correctly avoided restricted streets`);
            }
            
            if (routeScore >= 80) {
                correctAnswers++;
            }
            
            // Show feedback
            const content = document.getElementById('moduleContent');
            content.innerHTML += `
                <div style="background: ${routeScore >= 80 ? '#d4edda' : '#fff3cd'}; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid ${routeScore >= 80 ? '#28a745' : '#ffc107'};">
                    <h3>Route Evaluation: ${Math.round(routeScore)}%</h3>
                    ${feedback.map(f => `<p style="margin: 5px 0;">${f}</p>`).join('')}
                    <p style="margin-top: 15px;"><strong>Optimal route:</strong> ${scenario.correctRoute.join(', ')}</p>
                </div>
            `;
            
            // Add continue button
            setTimeout(() => {
                const continueBtn = document.createElement('div');
                continueBtn.style.textAlign = 'center';
                continueBtn.style.marginTop = '20px';
                continueBtn.innerHTML = '<button class="btn btn-primary" onclick="nextMapQuestion()">Next Scenario</button>';
                document.getElementById('moduleContent').appendChild(continueBtn);
            }, 500);
        }
        
        function nextMapQuestion() {
            currentQuestion++;
            showNextMapQuestion();
        }
        
        function showMapResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Map Reading Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Routes Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMapReading()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'mapReading',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // Helper function to compare arrays
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }
    </script>
</body>
</html>
