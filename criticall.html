<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CritiCall Practice - KBD1100</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <style>
        .criticall-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .criticall-header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 30px;
        }
        
        .module-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 180px;
            position: relative;
        }
        
        .module-card.coming-soon {
            background: linear-gradient(135deg, #999 0%, #666 100%);
            opacity: 0.7;
        }
        
        .module-card.coming-soon::after {
            content: "COMING SOON";
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .module-card:hover:not(.coming-soon) {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .module-card h3 {
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .module-card p {
            opacity: 0.95;
            font-size: 14px;
        }
        
        .module-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9998;
        }
        
        .module-overlay.active {
            display: block;
        }
        
        .module-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 9999;
        }
        
        .module-container.active {
            display: block;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Audio Player Styles */
        .audio-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .audio-player {
            width: 100%;
            margin: 15px 0;
        }
        
        .play-count {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        /* Data Entry Form */
        .data-entry-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .form-row label {
            font-weight: bold;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        .form-row input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-row input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        /* Call Summarization Styles */
        .incident-scenario {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .decision-section {
            background: white;
            border: 2px solid #007bff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .priority-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .priority-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .priority-btn.high { background: #dc3545; color: white; }
        .priority-btn.medium { background: #ffc107; color: black; }
        .priority-btn.low { background: #28a745; color: white; }
        
        .priority-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* Score Display */
        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        .score-display h2 {
            font-size: 48px;
            margin: 20px 0;
        }
        
        /* Memory Recall Styles */
        .memory-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .memory-item {
            padding: 15px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .memory-question {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin: 15px 0;
        }
        
        /* Map Styles */
        .map-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .map-grid {
            display: grid;
            grid-template-columns: repeat(10, 60px);
            gap: 0;
            margin: 20px 0;
            border: 2px solid #333;
        }
        
        .map-cell {
            border: 1px solid #ddd;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            position: relative;
            background: #f5f5f5;
            text-align: center;
            padding: 2px;
        }
        
        .street-h, .street-v {
            background: #999;
            color: white;
            font-weight: bold;
        }
        
        .building {
            font-size: 8px;
            font-weight: bold;
            padding: 2px;
        }
        
        .building-hospital { background: #ff6b6b; color: white; }
        .building-police { background: #4dabf7; color: white; }
        .building-fire { background: #ff8787; color: white; }
        .building-school { background: #ffd43b; }
        .building-mall { background: #69db7c; }
        .building-library { background: #da77f2; color: white; }
        .building-park { background: #8ce99a; }
        
        .one-way::after {
            position: absolute;
            font-size: 20px;
            color: #ff0000;
            font-weight: bold;
        }
        
        .one-way-n::after { content: "‚Üë"; }
        .one-way-s::after { content: "‚Üì"; }
        .one-way-e::after { content: "‚Üí"; }
        .one-way-w::after { content: "‚Üê"; }
        
        .map-legend {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 3px;
        }
        
        .route-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #007bff;
            border-radius: 5px;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="criticall-container">
        <div class="criticall-header">
            <h1>üö® CritiCall Practice Modules</h1>
            <p>Emergency Services Dispatcher Training</p>
            <button onclick="window.location.href='index.html'" class="btn btn-primary" style="margin-top: 15px;">‚Üê Back to Main Menu</button>
        </div>
        
        <div class="module-grid">
            <div class="module-card" onclick="openModule('dataEntry')">
                <h3>üìù Data Entry</h3>
                <p>Listen to emergency calls and accurately record caller information, location, and incident type.</p>
            </div>
            
            <div class="module-card" onclick="openModule('callSummarization')">
                <h3>üéØ Call Summarization</h3>
                <p>Analyze emergency scenarios and determine appropriate services and priority levels.</p>
            </div>
            
            <div class="module-card" onclick="openModule('memoryRecall')">
                <h3>üß† Memory Recall</h3>
                <p>Memorize and recall critical information from emergency scenarios.</p>
            </div>
            
            <div class="module-card" onclick="openModule('mapReading')">
                <h3>üó∫Ô∏è Map Reading</h3>
                <p>Navigate city streets and determine optimal routes for emergency response.</p>
            </div>
            
            <div class="module-card" onclick="openModule('readingComprehension')">
                <h3>üìò Reading Comprehension</h3>
                <p>Read passages and answer questions about policies, procedures, and call details.</p>
            </div>
            
            <div class="module-card" onclick="openModule('spelling')">
                <h3>‚úèÔ∏è Spelling</h3>
                <p>Identify correctly spelled words commonly used in emergency dispatch.</p>
            </div>
            
            <div class="module-card" onclick="openModule('sentenceClarity')">
                <h3>üó£Ô∏è Sentence Clarity</h3>
                <p>Select the clearest and most grammatically correct way to communicate information.</p>
            </div>
            
            <div class="module-card" onclick="openModule('mathematics')">
                <h3>‚ûï Mathematics</h3>
                <p>Solve real-world math problems including time calculations and basic arithmetic.</p>
            </div>
            
            <div class="module-card" onclick="openModule('splitAttention')">
                <h3>üëÅÔ∏è Split Attention</h3>
                <p>Type accurately while monitoring multiple displays for target numbers.</p>
            </div>
            
            <div class="module-card" onclick="openModule('listeningSkills')">
                <h3>üéß Listening Skills</h3>
                <p>Listen to emergency calls and answer detailed comprehension questions.</p>
            </div>
            
            <div class="module-card" onclick="openModule('vinLicense')">
                <h3>üöó VIN/License Entry</h3>
                <p>Enter VINs and license numbers accurately, extract date of birth from licenses.</p>
            </div>
            
            <div class="module-card" onclick="openModule('crossReference')">
                <h3>üîç Cross-Reference</h3>
                <p>Spot discrepancies between caller information and database records.</p>
            </div>
            
            <div class="module-card" onclick="openModule('multitasking')">
                <h3>üéÆ Multitasking</h3>
                <p>Handle multiple emergency calls simultaneously while prioritizing urgency.</p>
            </div>
            
            <div class="module-card" onclick="openModule('decisionMaking')">
                <h3>üéØ Decision Making</h3>
                <p>Prioritize emergency calls by severity - people over property, in-progress over after-the-fact.</p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üìª </h3>
                <p></p>
            </div>
            
            <div class="module-card coming-soon" style="grid-column: span 2; background: linear-gradient(135deg, #999 0%, #666 100%);">
                <h3>üìã Full CritiCall Test</h3>
                <p>Complete simulation combining all modules to assess overall dispatcher readiness.</p>
            </div>
        </div>
    </div>
    
    <div class="module-overlay" id="moduleOverlay" onclick="closeModule()"></div>
    <div class="module-container" id="moduleContainer">
        <div class="module-header">
            <h2 id="moduleTitle"></h2>
            <button class="close-btn" onclick="closeModule()">‚úï Close</button>
        </div>
        <div id="moduleContent"></div>
    </div>

    <script>
        let auth, db;
        let currentModule = null;
        let currentQuestion = 0;
        let correctAnswers = 0;
        let totalQuestions = 0;
        let audioPlayCount = 0;
        let selectedPriority = null;
        let selectedServices = [];
        let memoryTimerInterval = null; // Global variable to track memory timer
        let splitAttentionInterval = null; // For split attention number cycling
        let splitAttentionTimer = null; // For split attention test timer
        let multitaskingState = { activeCall: null, callQueue: [], score: 0 }; // For multitasking module
        
        // Initialize Firebase
        auth = firebase.auth();
        db = firebase.firestore();
        
        // Data Entry Audio Files Database
        const dataEntryScenarios = [
            {
                audioFile: "audio/data-entry/scenario1.mp3", // You'll add your actual audio files
                answers: {
                    callerName: "Sarah Johnson",
                    address: "1245 Oak Street",
                    incidentType: "Medical Emergency"
                }
            },
            {
                audioFile: "audio/data-entry/scenario2.mp3",
                answers: {
                    callerName: "Michelle Chen",
                    address: "789 Maple Avenue",
                    incidentType: "Structure Fire"
                }
            },
            {
                audioFile: "audio/data-entry/scenario3.mp3",
                answers: {
                    callerName: "Emily Rodriguez",
                    address: "456 Pine Boulevard",
                    incidentType: "MVC"
                }
            }
        ];
        
        // Call Summarization Scenarios
        const callScenarios = [
            {
                scenario: "A 45-year-old male is experiencing severe chest pain and difficulty breathing. He is conscious but in obvious distress. His wife reports he has a history of heart problems.",
                correctServices: ["ems"],
                correctPriority: "high"
            },
            {
                scenario: "Caller reports seeing smoke coming from a neighbor's garage. No flames visible yet, but the smell is getting stronger. No one appears to be home.",
                correctServices: ["fire"],
                correctPriority: "medium"
            },
            {
                scenario: "A two-car collision at Main St and 5th Ave. Minor injuries reported, one vehicle is blocking the right lane. Both drivers are out of their vehicles.",
                correctServices: ["police", "ems"],
                correctPriority: "medium"
            },
            {
                scenario: "Caller reports an unresponsive infant, not breathing. Mother is hysterical. Address is clear.",
                correctServices: ["ems"],
                correctPriority: "high"
            },
            {
                scenario: "Neighbor reports a burglary in progress. Suspects are currently inside the residence. Homeowners are on vacation.",
                correctServices: ["police"],
                correctPriority: "high"
            },
            {
                scenario: "Elderly woman fell in her bathroom. She is conscious and alert but cannot get up. No visible injuries but complaining of hip pain.",
                correctServices: ["ems"],
                correctPriority: "medium"
            },
            {
                scenario: "Structure fire fully involved, multiple floors. Building is a commercial warehouse. All occupants have evacuated safely.",
                correctServices: ["fire", "police"],
                correctPriority: "high"
            },
            {
                scenario: "Carbon monoxide alarm sounding in a residence. Family members are feeling dizzy and nauseous. They are outside now.",
                correctServices: ["fire", "ems"],
                correctPriority: "high"
            },
            {
                scenario: "Suspicious person loitering near a school playground. School is currently in session. Individual is not responding to staff requests to leave.",
                correctServices: ["police"],
                correctPriority: "medium"
            },
            {
                scenario: "Tree branch fell on power lines during storm. Sparking visible. Lines are across the roadway blocking both lanes.",
                correctServices: ["fire", "police", "utilities"],
                correctPriority: "high"
            },
            {
                scenario: "Caller reports her medication was stolen from her vehicle overnight. Vehicle was parked in her driveway.",
                correctServices: ["police"],
                correctPriority: "low"
            },
            {
                scenario: "Domestic disturbance. Neighbors report shouting and sounds of items breaking. Children's voices heard crying.",
                correctServices: ["police"],
                correctPriority: "high"
            },
            {
                scenario: "Gas leak reported at a restaurant. Strong odor throughout the building. Building has been evacuated.",
                correctServices: ["fire", "utilities"],
                correctPriority: "high"
            },
            {
                scenario: "Vehicle vs pedestrian accident. Pedestrian is conscious, sitting on curb. Visible leg injury. Driver remained on scene.",
                correctServices: ["police", "ems"],
                correctPriority: "high"
            },
            {
                scenario: "Caller locked keys in car with infant inside. Weather is hot, approximately 85¬∞F. Infant appears alert through window.",
                correctServices: ["fire", "police"],
                correctPriority: "high"
            }
        ];
        
        // Memory Recall Questions by Difficulty
        const memoryQuestions = {
            easy: [
                {
                    items: ["Badge 423", "Unit 7", "Oak Street", "10-4", "Engine 2"],
                    questions: [
                        { q: "What badge number was shown?", a: "423" },
                        { q: "What unit number was mentioned?", a: "7" },
                        { q: "What street name appeared?", a: "Oak Street" }
                    ]
                },
                {
                    items: ["Code 3", "Maple Ave", "Badge 156", "Squad 9", "10-23"],
                    questions: [
                        { q: "What code was displayed?", a: "Code 3" },
                        { q: "What avenue was shown?", a: "Maple Ave" },
                        { q: "What was the badge number?", a: "156" }
                    ]
                }
            ],
            medium: [
                {
                    items: ["Suspect: Male, 6'2\"", "Weapon: Handgun", "Vehicle: Blue Sedan", "Plate: ABC 1234", "Direction: Northbound", "Last Seen: 5th & Main"],
                    questions: [
                        { q: "What was the suspect's height?", a: "6'2\"" },
                        { q: "What type of weapon was mentioned?", a: "Handgun" },
                        { q: "What color was the vehicle?", a: "Blue" },
                        { q: "What was the license plate number?", a: "ABC 1234" },
                        { q: "Which direction was the suspect heading?", a: "Northbound" }
                    ]
                },
                {
                    items: ["DOB: 03/15/1985", "Lic#: D532-8877-2341", "Height: 5'9\"", "Eyes: Brown", "Hair: Black", "Weight: 180 lbs"],
                    questions: [
                        { q: "What was the date of birth?", a: "03/15/1985" },
                        { q: "What was the license number?", a: "D532-8877-2341" },
                        { q: "What was the eye color?", a: "Brown" },
                        { q: "What was the person's height?", a: "5'9\"" },
                        { q: "What was the weight listed?", a: "180 lbs" }
                    ]
                }
            ],
            hard: [
                {
                    items: ["Call#: 2024-7893", "Time: 14:37", "Caller: Martinez, J.", "Location: 4521 Elmwood Dr, Apt 3B", "DOB: 11/22/1978", "Lic#: M582-3344-9871", "Responding: Units 7, 12, Engine 4", "Code: 10-52 with 10-18"],
                    questions: [
                        { q: "What was the call number?", a: "2024-7893" },
                        { q: "What time was the call received?", a: "14:37" },
                        { q: "What was the complete address including apartment?", a: "4521 Elmwood Dr, Apt 3B" },
                        { q: "What was the caller's date of birth?", a: "11/22/1978" },
                        { q: "List all responding units (separated by commas)", a: "7, 12, Engine 4" },
                        { q: "What codes were mentioned?", a: "10-52 with 10-18" }
                    ]
                },
                {
                    items: ["Incident#: 2024-15673", "Complainant: Rodriguez-Smith, M.", "Address: 8934 Pinecrest Blvd #215", "Vehicle: 2019 Toyota Camry, Gray", "VIN: 4T1BF1FK3KU123456", "Suspect: White Male, 5'11\", 175lbs", "Clothing: Blue hoodie, jeans", "Time: 09:15 - 09:42"],
                    questions: [
                        { q: "What was the incident number?", a: "2024-15673" },
                        { q: "What was the complainant's full name?", a: "Rodriguez-Smith, M." },
                        { q: "What was the complete address?", a: "8934 Pinecrest Blvd #215" },
                        { q: "What was the vehicle VIN?", a: "4T1BF1FK3KU123456" },
                        { q: "Describe the suspect's clothing", a: "Blue hoodie, jeans" },
                        { q: "What was the time frame of the incident?", a: "09:15 - 09:42" }
                    ]
                }
            ]
        };
        
        // Map Reading Scenarios
        const mapScenarios = [
            {
                question: "Route from Hospital to the Fire at Main St & 4th Ave",
                start: "Hospital",
                end: "Fire",
                correctRoute: ["Main St south", "4th Ave east"],
                avoidStreets: ["Oak St (one-way north)"]
            },
            {
                question: "Route from Police Station to accident at Oak St & 2nd Ave",
                start: "Police",
                end: "Accident",
                correctRoute: ["1st Ave north", "Oak St east"],
                avoidStreets: []
            },
            {
                question: "Route from Fire Station to School emergency",
                start: "Fire Station",
                end: "School",
                correctRoute: ["3rd Ave south", "Pine St west", "2nd Ave south"],
                avoidStreets: ["Elm St (one-way east)"]
            }
        ];
        
        // Reading Comprehension Passages
        const readingPassages = [
            {
                title: "Emergency Response Protocol",
                passage: "When a dispatcher receives a call regarding an unresponsive person, the first priority is to establish the exact location and ensure emergency medical services are dispatched immediately. The dispatcher must remain on the line with the caller and provide pre-arrival instructions if the caller is willing and able to assist. If the caller becomes unresponsive or disconnects, the dispatcher should attempt to call back using the registered phone number. If no callback is possible, units should still be dispatched to the last known location. Under no circumstances should the dispatcher delay sending help while attempting to gather additional information.",
                questions: [
                    {
                        q: "According to the text, what is the FIRST priority when receiving a call about an unresponsive person?",
                        options: [
                            "Provide pre-arrival instructions",
                            "Establish the exact location",
                            "Attempt to call the caller back",
                            "Gather additional medical information"
                        ],
                        correct: 1
                    },
                    {
                        q: "What should the dispatcher do if the caller becomes unresponsive?",
                        options: [
                            "End the call and move to the next one",
                            "Delay dispatch until contact is re-established",
                            "Attempt to call back using the registered phone number",
                            "Send only police to investigate"
                        ],
                        correct: 2
                    },
                    {
                        q: "According to the passage, when should help be delayed?",
                        options: [
                            "When gathering additional information",
                            "When the caller disconnects",
                            "When the location is uncertain",
                            "Under no circumstances"
                        ],
                        correct: 3
                    }
                ]
            },
            {
                title: "Vehicle Pursuit Policy",
                passage: "Officers may initiate a vehicle pursuit only when the suspect poses an immediate threat to public safety and the benefits of apprehension outweigh the risks of pursuit. Pursuits must never be initiated for traffic violations alone, regardless of severity. The pursuing officer must continuously broadcast updates including location, direction of travel, speed, and traffic conditions. A supervisor must approve continuation of any pursuit beyond two minutes. All pursuits must be terminated immediately if weather conditions deteriorate, traffic density increases significantly, or the suspect's identity is known and apprehension can be made at a later time.",
                questions: [
                    {
                        q: "When may officers initiate a vehicle pursuit?",
                        options: [
                            "For any traffic violation",
                            "Only for severe traffic violations",
                            "When the suspect poses an immediate threat to public safety",
                            "Whenever they have supervisor approval"
                        ],
                        correct: 2
                    },
                    {
                        q: "What must happen after two minutes of pursuit?",
                        options: [
                            "The pursuit must be terminated",
                            "A supervisor must approve continuation",
                            "Speed must be reduced",
                            "Additional units must join"
                        ],
                        correct: 1
                    },
                    {
                        q: "Which situation would require immediate termination of a pursuit?",
                        options: [
                            "The suspect speeds up",
                            "The suspect's identity becomes known",
                            "Additional units arrive",
                            "The pursuit reaches residential areas"
                        ],
                        correct: 1
                    }
                ]
            },
            {
                title: "Hazardous Materials Response",
                passage: "Upon receiving a report of a hazardous materials incident, the dispatcher must immediately establish a safe perimeter and ensure no personnel enter the area without proper protective equipment. The fire department hazmat team must be notified regardless of the substance involved. If the caller can safely provide information about the material, the dispatcher should request container labels, placards, or shipping documents. However, the caller must never be instructed to approach or handle hazardous materials. Wind direction and weather conditions must be documented as they are critical for evacuation decisions. Adjacent buildings and facilities must be notified if there is any risk of exposure.",
                questions: [
                    {
                        q: "What must be done immediately upon receiving a hazmat report?",
                        options: [
                            "Send the fire department only",
                            "Request container labels from the caller",
                            "Establish a safe perimeter",
                            "Document weather conditions"
                        ],
                        correct: 2
                    },
                    {
                        q: "Should the caller be instructed to approach hazardous materials to get information?",
                        options: [
                            "Yes, if they can do so safely",
                            "Yes, but only to read labels",
                            "No, never",
                            "Only if trained"
                        ],
                        correct: 2
                    },
                    {
                        q: "Why must wind direction be documented?",
                        options: [
                            "For fire department records",
                            "It is critical for evacuation decisions",
                            "To predict weather changes",
                            "For insurance purposes"
                        ],
                        correct: 1
                    }
                ]
            }
        ];
        
        // Spelling Questions
        const spellingQuestions = [
            { word: "separate", options: ["seperate", "separate", "separete", "separat"], correct: 1 },
            { word: "receive", options: ["recieve", "receive", "receve", "receeve"], correct: 1 },
            { word: "license", options: ["licence", "lisense", "license", "lisence"], correct: 2 },
            { word: "accident", options: ["accident", "accedent", "axident", "acident"], correct: 0 },
            { word: "vehicle", options: ["vehical", "veicle", "vehicle", "vehicel"], correct: 2 },
            { word: "immediately", options: ["imediately", "immediatly", "immediately", "imediatlly"], correct: 2 },
            { word: "necessary", options: ["necesary", "neccesary", "necessary", "neccessary"], correct: 2 },
            { word: "occurrence", options: ["occurence", "occurance", "occurrence", "occurrance"], correct: 2 },
            { word: "personnel", options: ["personel", "personnel", "personell", "personnell"], correct: 1 },
            { word: "conscious", options: ["concious", "consious", "conscious", "conscous"], correct: 2 },
            { word: "defendant", options: ["defendent", "defendant", "defendint", "defandant"], correct: 1 },
            { word: "dispatch", options: ["dispach", "dispatche", "dispatch", "dispetch"], correct: 2 },
            { word: "emergency", options: ["emergancy", "emergency", "emergencey", "emergensy"], correct: 1 },
            { word: "principal", options: ["principle", "principal", "prinsipal", "prinsiple"], correct: 1 },
            { word: "their", options: ["there", "their", "thier", "they're"], correct: 1 },
            { word: "definitely", options: ["definately", "definitly", "definitely", "definetly"], correct: 2 },
            { word: "accommodate", options: ["acommodate", "accomodate", "accommodate", "acomodate"], correct: 2 },
            { word: "existence", options: ["existance", "existence", "existense", "existents"], correct: 1 },
            { word: "maintenance", options: ["maintainance", "maintenence", "maintenance", "maintanence"], correct: 2 },
            { word: "pursuing", options: ["persuing", "pursuing", "pursueing", "persewing"], correct: 1 }
        ];
        
        // Sentence Clarity Questions
        const sentenceClarityQuestions = [
            {
                question: "Which sentence is the clearest?",
                options: [
                    "The car, which was red in color, was observed to be traveling at a high rate of speed down the road.",
                    "The red car was speeding down the road.",
                    "Down the road, there was a car that was red in color and it was speeding.",
                    "A car that was speeding, red in color, was going down the road."
                ],
                correct: 1
            },
            {
                question: "Which sentence communicates the information most effectively?",
                options: [
                    "The suspect, who was wearing a blue jacket, ran from the officers.",
                    "From the officers, the suspect wearing a blue jacket ran.",
                    "The suspect in the blue jacket fled from officers.",
                    "Running from the officers was the suspect in a jacket that was blue."
                ],
                correct: 2
            },
            {
                question: "Select the clearest version:",
                options: [
                    "The dispatcher was informed by the caller that there was a fire.",
                    "A fire was what the caller informed the dispatcher about.",
                    "The caller informed the dispatcher of a fire.",
                    "It was a fire that the dispatcher was informed of by the caller."
                ],
                correct: 2
            },
            {
                question: "Which sentence is most appropriate for a dispatch report?",
                options: [
                    "There were three units that responded to the scene where the accident occurred.",
                    "Three units responded to the accident scene.",
                    "To the scene of the accident, three units responded.",
                    "The accident scene was where three units responded to."
                ],
                correct: 1
            },
            {
                question: "Choose the clearest sentence:",
                options: [
                    "Medical assistance was being requested by a male caller for his wife.",
                    "A male caller's wife needed medical assistance which he requested.",
                    "A male caller requested medical assistance for his wife.",
                    "For his wife, a male caller was requesting that medical assistance be provided."
                ],
                correct: 2
            },
            {
                question: "Which version is best for radio communication?",
                options: [
                    "The vehicle that was stolen was located at the mall parking lot.",
                    "Located at the mall parking lot was the vehicle that had been stolen.",
                    "The stolen vehicle was located in the mall parking lot.",
                    "At the mall parking lot, the vehicle, which was stolen, was located."
                ],
                correct: 2
            },
            {
                question: "Select the most concise and clear option:",
                options: [
                    "The officer, who arrived at the scene first, secured the perimeter.",
                    "Securing the perimeter was done by the officer who arrived first.",
                    "The first officer on scene secured the perimeter.",
                    "The perimeter was secured by the officer who was first to arrive at the scene."
                ],
                correct: 2
            },
            {
                question: "Which sentence follows proper active voice?",
                options: [
                    "The suspect was apprehended by two officers.",
                    "By two officers, the suspect was apprehended.",
                    "Two officers apprehended the suspect.",
                    "The apprehension of the suspect was made by two officers."
                ],
                correct: 2
            },
            {
                question: "Choose the clearest way to report this information:",
                options: [
                    "In the direction of northbound on Highway 5, the suspect vehicle was last observed traveling.",
                    "The suspect vehicle was last seen traveling northbound on Highway 5.",
                    "Traveling northbound on Highway 5 is where the suspect vehicle was last seen.",
                    "Last seen was the suspect vehicle, traveling in a northbound direction on Highway 5."
                ],
                correct: 1
            },
            {
                question: "Which option is most appropriate for written documentation?",
                options: [
                    "At 15:30 hours, Officers Martinez and Chen were the ones who arrived at the location.",
                    "The arrival at the location by Officers Martinez and Chen occurred at 15:30 hours.",
                    "Officers Martinez and Chen arrived at the location at 15:30 hours.",
                    "It was at 15:30 hours that Officers Martinez and Chen arrived at the location."
                ],
                correct: 2
            }
        ];
        
        // Mathematics Questions
        const mathQuestions = [
            {
                question: "An officer began a traffic stop at 14:25 and completed it at 14:47. How long did the stop take?",
                options: ["22 minutes", "32 minutes", "18 minutes", "25 minutes"],
                correct: 0
            },
            {
                question: "If three patrol units respond every 4 minutes, how many units will have responded after 12 minutes?",
                options: ["6 units", "9 units", "12 units", "15 units"],
                correct: 1
            },
            {
                question: "A dispatcher handles 8 calls per hour. How many calls would they handle in a 12-hour shift?",
                options: ["84 calls", "96 calls", "102 calls", "108 calls"],
                correct: 1
            },
            {
                question: "Convert 45 miles to kilometers (1 mile = 1.6 km):",
                options: ["72 km", "68 km", "70 km", "75 km"],
                correct: 0
            },
            {
                question: "An officer drives 60 miles per hour. How far will they travel in 15 minutes?",
                options: ["10 miles", "12 miles", "15 miles", "20 miles"],
                correct: 2
            },
            {
                question: "If 60% of calls are medical emergencies and you receive 150 calls, how many are medical?",
                options: ["80", "85", "90", "95"],
                correct: 2
            },
            {
                question: "What is 24 √ó 15?",
                options: ["340", "350", "360", "370"],
                correct: 2
            },
            {
                question: "A suspect is 3.5 miles away traveling at 50 mph. An officer is 2 miles away traveling at 60 mph. Who arrives first?",
                options: ["Suspect", "Officer", "They arrive together", "Cannot determine"],
                correct: 1
            },
            {
                question: "Convert 135 minutes to hours and minutes:",
                options: ["2 hours 15 minutes", "2 hours 25 minutes", "2 hours 35 minutes", "1 hour 75 minutes"],
                correct: 0
            },
            {
                question: "If a fire truck uses 12 gallons of fuel per hour, how much fuel is used in 45 minutes?",
                options: ["8 gallons", "9 gallons", "10 gallons", "11 gallons"],
                correct: 1
            },
            {
                question: "What is 456 + 789?",
                options: ["1,235", "1,245", "1,255", "1,265"],
                correct: 1
            },
            {
                question: "A dispatcher works from 06:00 to 18:00. How many hours is this shift?",
                options: ["10 hours", "11 hours", "12 hours", "13 hours"],
                correct: 2
            },
            {
                question: "If response time averages 6.5 minutes and you have 8 calls, what is total response time?",
                options: ["48 minutes", "50 minutes", "52 minutes", "54 minutes"],
                correct: 2
            },
            {
                question: "What is 20% of 250?",
                options: ["40", "45", "50", "55"],
                correct: 2
            },
            {
                question: "An incident began at 09:35 and ended at 11:10. What was the duration?",
                options: ["1 hour 25 minutes", "1 hour 35 minutes", "1 hour 45 minutes", "1 hour 55 minutes"],
                correct: 1
            },
            {
                question: "Divide 1,440 by 12:",
                options: ["110", "115", "120", "125"],
                correct: 2
            },
            {
                question: "If you need 3 officers per scene and have 7 scenes, how many officers are needed?",
                options: ["18", "19", "20", "21"],
                correct: 3
            },
            {
                question: "Convert 2.5 hours to minutes:",
                options: ["130 minutes", "140 minutes", "150 minutes", "160 minutes"],
                correct: 2
            },
            {
                question: "What is the average of 12, 18, 24, and 30?",
                options: ["19", "21", "23", "25"],
                correct: 1
            },
            {
                question: "If a call center receives 480 calls in 8 hours, what is the average per hour?",
                options: ["55", "60", "65", "70"],
                correct: 1
            }
        ];
        
        // Split Attention - Typing passages (expanded set)
        const splitAttentionPassages = [
            "Emergency dispatchers must maintain composure under pressure while managing multiple information streams simultaneously. This requires exceptional multitasking abilities and sustained concentration throughout extended shifts.",
            "Effective communication is critical in emergency services. Dispatchers must quickly gather accurate information, relay instructions clearly, and coordinate responses between multiple agencies and units.",
            "Modern dispatch centers utilize advanced computer-aided dispatch systems to track unit locations, manage call queues, and maintain comprehensive incident records for legal and operational purposes.",
            "Time management skills are essential for dispatchers who must prioritize incoming calls based on urgency, allocate appropriate resources, and ensure timely response to life-threatening situations.",
            "Dispatchers serve as the vital link between callers in crisis and emergency responders in the field. Their ability to remain calm and professional can significantly impact outcomes.",
            "Public safety telecommunications requires precise attention to detail when recording addresses, license plate numbers, physical descriptions, and other critical incident information.",
            "Emergency call processing involves continuous assessment of caller credibility, threat levels, and resource availability while maintaining empathetic communication with distressed individuals.",
            "Dispatchers must master geographic knowledge of their service area including street layouts, landmark locations, and jurisdictional boundaries to ensure accurate resource deployment.",
            "Radio communication protocols demand clear enunciation, proper terminology, and strategic timing to coordinate multiple units responding to complex emergency situations.",
            "Crisis intervention skills enable dispatchers to provide pre-arrival instructions for medical emergencies, de-escalate volatile situations, and maintain caller cooperation during investigations.",
            "Technology proficiency is crucial as dispatchers operate multiple computer systems simultaneously while monitoring radio traffic, telephone calls, and automated alert systems.",
            "Documentation accuracy ensures legal compliance and operational continuity. Every detail recorded during emergency calls may become evidence in subsequent legal proceedings."
        ];
        
        // Listening Skills - Audio scenarios with questions (you'll add audio files)
        const listeningScenarios = [
            {
                audioFile: "audio/listening/listening1.mp3", // You'll add your audio file
                scenario: "911 call: House fire at 456 Elm Street. Caller reports seeing flames from second floor windows. Two children possibly trapped inside. Smoke visible from street.",
                questions: [
                    {
                        q: "What is the address of the fire?",
                        options: ["456 Elm Street", "456 Oak Street", "546 Elm Street", "4566 Elm Avenue"],
                        correct: 0
                    },
                    {
                        q: "Where are the flames visible?",
                        options: ["First floor", "Second floor", "Basement", "Roof"],
                        correct: 1
                    },
                    {
                        q: "How many children are possibly trapped?",
                        options: ["One", "Two", "Three", "Unknown"],
                        correct: 1
                    },
                    {
                        q: "What did the caller report seeing from the street?",
                        options: ["Only flames", "Only smoke", "Flames and smoke", "People at windows"],
                        correct: 2
                    }
                ]
            },
            {
                audioFile: "audio/listening/listening2.mp3",
                scenario: "Dispatch: Two-vehicle collision at Main and 5th. Silver Honda and black pickup truck. Driver of Honda is unconscious. Pickup driver walked away from scene. Traffic backed up for several blocks.",
                questions: [
                    {
                        q: "Where did the collision occur?",
                        options: ["Main and 4th", "Main and 5th", "Main and 6th", "5th and Oak"],
                        correct: 1
                    },
                    {
                        q: "What colour is the Honda?",
                        options: ["Black", "White", "Silver", "Blue"],
                        correct: 2
                    },
                    {
                        q: "What is the condition of the Honda driver?",
                        options: ["Conscious", "Unconscious", "Walked away", "Not mentioned"],
                        correct: 1
                    },
                    {
                        q: "What did the pickup driver do?",
                        options: ["Remained at scene", "Walked away from scene", "Was transported", "Was unconscious"],
                        correct: 1
                    },
                    {
                        q: "How is traffic affected?",
                        options: ["No impact", "Backed up one block", "Backed up several blocks", "Road closed"],
                        correct: 2
                    }
                ]
            },
            {
                audioFile: "audio/listening/listening3.mp3",
                scenario: "Medical emergency: 78-year-old male experiencing chest pain at 123 Maple Avenue, Apartment 4B. Patient is diabetic, taking blood pressure medication. Wife is with him. Patient is conscious but in severe pain.",
                questions: [
                    {
                        q: "What is the patient's age?",
                        options: ["68", "78", "88", "87"],
                        correct: 1
                    },
                    {
                        q: "What is the main complaint?",
                        options: ["Difficulty breathing", "Chest pain", "Abdominal pain", "Headache"],
                        correct: 1
                    },
                    {
                        q: "What is the apartment number?",
                        options: ["3B", "4A", "4B", "5B"],
                        correct: 2
                    },
                    {
                        q: "What medical condition does the patient have?",
                        options: ["Heart disease", "Diabetes", "Asthma", "Cancer"],
                        correct: 1
                    },
                    {
                        q: "Is the patient conscious?",
                        options: ["Yes", "No", "Intermittent", "Not mentioned"],
                        correct: 0
                    }
                ]
            }
        ];
        
        // VIN/License Entry - Generate license numbers with encoded DOB
        function generateLicenseNumber(lastName, birthYear, birthMonth, birthDay, isFemale) {
            const letter = lastName.charAt(0).toUpperCase();
            const year = birthYear.toString().slice(-2);
            const month = isFemale ? (parseInt(birthMonth) + 50).toString().padStart(2, '0') : birthMonth.padStart(2, '0');
            const day = birthDay.padStart(2, '0');
            
            // Create the DOB as YYMMDD  
            const dob = year + month + day;
            
            // Generate random middle sections
            const part1 = Math.floor(1000 + Math.random() * 9000);
            const part2 = Math.floor(1000 + Math.random() * 9000);
            
            // Put the DOB at the end
            const license = `${letter}${part1}-${part2}-${dob}`;
            
            // Fix century calculation: 00-25 = 20XX, 26-99 = 19XX
            const yearNum = parseInt(year);
            const fullYear = yearNum <= 25 ? "20" + year : "19" + year;
            
            return {
                license: license,
                year: fullYear,
                month: birthMonth.padStart(2, '0'),
                day: day,
                gender: isFemale ? "Female" : "Male"
            };
        }
        
        // Function to extract DOB from license number - just take last 6 digits
        function extractDobFromLicense(license) {
            // Remove dashes and extract last 6 digits
            const digitsOnly = license.replace(/[^0-9]/g, '');
            const last6 = digitsOnly.slice(-6);
            
            if (last6.length !== 6) return null;
            
            const year = last6.substring(0, 2);
            const month = last6.substring(2, 4);
            const day = last6.substring(4, 6);
            
            // Determine gender and actual month
            const monthNum = parseInt(month);
            const isFemale = monthNum > 50;
            const actualMonth = isFemale ? monthNum - 50 : monthNum;
            
            // Determine century
            const yearNum = parseInt(year);
            const fullYear = yearNum <= 25 ? "20" + year : "19" + year;
            
            return {
                fullDob: last6,
                year: fullYear,
                month: actualMonth.toString().padStart(2, '0'),
                day: day,
                gender: isFemale ? "Female" : "Male"
            };
        }
        
        // Pre-generated VINs
        const vinNumbers = [
            "1HGBH41JXMN109186",
            "2G1WF52E059246031",
            "JH4KA8260MC000000",
            "WBAVM1C50EVW48592",
            "1FTFW1ET5DFC10312",
            "5YJSA1DN5CFP01785",
            "1FMCU0F70AUA27450",
            "3GNDA13D76S000000",
            "5TDZA23C88S000000",
            "1G1ZT54806F109149"
        ];
        
        // Cross-Reference Scenarios
        const crossReferenceScenarios = [
            {
                title: "License Verification",
                callerInfo: {
                    name: "John Michael Smith",
                    dob: "03/15/1985",
                    license: "S1234-56789-85031",
                    address: "123 Oak Street",
                    phone: "705-555-1234"
                },
                databaseInfo: {
                    name: "John Michael Smith",
                    dob: "03/15/1985",
                    license: "S1234-56789-85031",
                    address: "123 Oak Street",
                    phone: "705-555-1235"
                },
                discrepancy: "phone",
                question: "What information does NOT match between the caller and database?"
            },
            {
                title: "Warrant Check",
                callerInfo: {
                    name: "Sarah Elizabeth Johnson",
                    dob: "07/22/1992",
                    license: "J5678-12345-92722",
                    address: "456 Maple Avenue"
                },
                databaseInfo: {
                    name: "Sarah Elizabeth Johnson",
                    dob: "07/22/1992",
                    license: "J5678-12345-92722",
                    address: "456 Maple Drive"
                },
                discrepancy: "address",
                question: "Which field contains a discrepancy?"
            },
            {
                title: "Vehicle Registration",
                callerInfo: {
                    name: "Michael Robert Chen",
                    plate: "ABCD 123",
                    vin: "1HGBH41JXMN109186",
                    year: "2015",
                    make: "Honda"
                },
                databaseInfo: {
                    name: "Michael Robert Chen",
                    plate: "ABCD 123",
                    vin: "1HGBH41JXMN109186",
                    year: "2016",
                    make: "Honda"
                },
                discrepancy: "year",
                question: "What vehicle information doesn't match?"
            },
            {
                title: "Emergency Contact",
                callerInfo: {
                    name: "Emily Rose Martinez",
                    dob: "11/30/1988",
                    address: "789 Pine Boulevard Apt 3B",
                    emergency_contact: "Carlos Martinez",
                    emergency_phone: "705-555-9876"
                },
                databaseInfo: {
                    name: "Emily Rose Martinez",
                    dob: "11/03/1988",
                    address: "789 Pine Boulevard Apt 3B",
                    emergency_contact: "Carlos Martinez",
                    emergency_phone: "705-555-9876"
                },
                discrepancy: "dob",
                question: "Which piece of information is inconsistent?"
            },
            {
                title: "Perfect Match",
                callerInfo: {
                    name: "David Lee Thompson",
                    dob: "05/14/1979",
                    license: "T2345-67890-79514",
                    address: "321 Birch Lane"
                },
                databaseInfo: {
                    name: "David Lee Thompson",
                    dob: "05/14/1979",
                    license: "T2345-67890-79514",
                    address: "321 Birch Lane"
                },
                discrepancy: "none",
                question: "Do all fields match?"
            }
        ];
        
        // Multitasking - Call scenarios with priorities
        const multitaskingCalls = [
            { id: 1, text: "Chest pain, difficulty breathing", priority: "high", service: "EMS" },
            { id: 2, text: "Suspicious person near school", priority: "medium", service: "Police" },
            { id: 3, text: "Noise complaint from neighbor", priority: "low", service: "Police" },
            { id: 4, text: "Structure fire, flames visible", priority: "high", service: "Fire" },
            { id: 5, text: "Traffic accident, injuries reported", priority: "high", service: "All" },
            { id: 6, text: "Lost pet report", priority: "low", service: "Police" },
            { id: 7, text: "Power lines down, sparking", priority: "high", service: "Fire/Utilities" },
            { id: 8, text: "Theft report from yesterday", priority: "low", service: "Police" },
            { id: 9, text: "Unresponsive person", priority: "high", service: "EMS" },
            { id: 10, text: "Loud party after midnight", priority: "medium", service: "Police" },
            { id: 11, text: "Gas odor in building", priority: "high", service: "Fire" },
            { id: 12, text: "Vehicle blocking driveway", priority: "low", service: "Police" },
            { id: 13, text: "Domestic disturbance, yelling heard", priority: "medium", service: "Police" },
            { id: 14, text: "Child fell from playground equipment", priority: "high", service: "EMS" },
            { id: 15, text: "Parking violation", priority: "low", service: "Police" },
            { id: 16, text: "Overdose, not breathing", priority: "high", service: "EMS" },
            { id: 17, text: "Smoke alarm activation", priority: "medium", service: "Fire" },
            { id: 18, text: "Request for police report", priority: "low", service: "Police" },
            { id: 19, text: "Armed robbery in progress", priority: "high", service: "Police" },
            { id: 20, text: "Water main break", priority: "medium", service: "Utilities" }
        ];
        
        function openModule(moduleName) {
            if (event.target.classList.contains('coming-soon')) {
                alert('This module is coming soon! Check back later.');
                return;
            }
            
            currentModule = moduleName;
            document.getElementById('moduleOverlay').classList.add('active');
            document.getElementById('moduleContainer').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            switch(moduleName) {
                case 'dataEntry':
                    showDataEntry();
                    break;
                case 'callSummarization':
                    showCallSummarization();
                    break;
                case 'memoryRecall':
                    showMemoryRecall();
                    break;
                case 'mapReading':
                    showMapReading();
                    break;
                case 'readingComprehension':
                    showReadingComprehension();
                    break;
                case 'spelling':
                    showSpelling();
                    break;
                case 'sentenceClarity':
                    showSentenceClarity();
                    break;
                case 'mathematics':
                    showMathematics();
                    break;
                case 'splitAttention':
                    showSplitAttention();
                    break;
                case 'listeningSkills':
                    showListeningSkills();
                    break;
                case 'vinLicense':
                    showVinLicense();
                    break;
                case 'crossReference':
                    showCrossReference();
                    break;
                case 'multitasking':
                    showMultitasking();
                    break;
                case 'decisionMaking':
                    showDecisionMaking();
                    break;
            }
        }
        
        function closeModule() {
            document.getElementById('moduleOverlay').classList.remove('active');
            document.getElementById('moduleContainer').classList.remove('active');
            document.body.style.overflow = 'auto';
            currentModule = null;
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = 0;
            audioPlayCount = 0;
            
            // Clear memory timer if it exists
            if (memoryTimerInterval) {
                clearInterval(memoryTimerInterval);
                memoryTimerInterval = null;
            }
            
            // Clear split attention timers
            if (splitAttentionInterval) {
                clearInterval(splitAttentionInterval);
                splitAttentionInterval = null;
            }
            if (splitAttentionTimer) {
                clearInterval(splitAttentionTimer);
                splitAttentionTimer = null;
            }
        }
        
        // DATA ENTRY MODULE
        function showDataEntry() {
            document.getElementById('moduleTitle').textContent = 'üìù Data Entry Practice';
            
            // Reset audio play count for new scenario
            audioPlayCount = 0;
            
            // For demo purposes, we'll use a random scenario
            // In production, you'd cycle through them or let teacher select
            const scenario = dataEntryScenarios[Math.floor(Math.random() * dataEntryScenarios.length)];
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div class="audio-container">
                    <h3>üéß Listen Carefully to the Emergency Call</h3>
                    <p><strong>‚ö† You can only play this audio ONCE - listen carefully and type as you hear the information!</strong></p>
                    <audio id="emergencyAudio" class="audio-player" controls>
                        <source src="${scenario.audioFile}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    <p class="play-count">Audio status: <span id="playCount" style="font-weight: bold; color: #007bff;">Ready to play</span></p>
                </div>
                
                <div class="data-entry-form">
                    <h3>Enter the information from the call:</h3>
                    <div class="form-row">
                        <label>Caller Name:</label>
                        <input type="text" id="callerName" placeholder="First and Last Name">
                    </div>
                    <div class="form-row">
                        <label>Address/Location:</label>
                        <input type="text" id="address" placeholder="Street address or location">
                    </div>
                    <div class="form-row">
                        <label>Incident Type:</label>
                        <input type="text" id="incidentType" placeholder="Type of emergency">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitDataEntry()">Submit Entry</button>
                </div>
            `;
            
            // Track audio plays and disable after first play
            const audio = document.getElementById('emergencyAudio');
            let hasPlayed = false;
            
            audio.addEventListener('play', function() {
                if (!hasPlayed) {
                    audioPlayCount++;
                    hasPlayed = true;
                    document.getElementById('playCount').textContent = 'Played once (disabled)';
                    document.getElementById('playCount').style.color = '#dc3545';
                }
            });
            
            audio.addEventListener('ended', function() {
                // Disable audio controls after it finishes playing
                audio.controls = false;
                audio.style.opacity = '0.5';
                document.getElementById('playCount').textContent = 'Audio completed (cannot replay)';
            });
            
            // Also disable if they try to replay before it ends
            audio.addEventListener('pause', function() {
                if (hasPlayed) {
                    audio.controls = false;
                    audio.style.opacity = '0.5';
                }
            });
            
            // Store correct answers for checking
            window.currentDataEntryAnswers = scenario.answers;
        }
        
        function submitDataEntry() {
            const userAnswers = {
                callerName: document.getElementById('callerName').value.trim(),
                address: document.getElementById('address').value.trim(),
                incidentType: document.getElementById('incidentType').value.trim()
            };
            
            const correctAnswers = window.currentDataEntryAnswers;
            let score = 0;
            let feedback = [];
            
            // Check Caller Name (case-insensitive, flexible matching)
            if (userAnswers.callerName.toLowerCase() === correctAnswers.callerName.toLowerCase()) {
                score += 33.33;
                feedback.push('‚úì Caller Name: Correct');
            } else {
                feedback.push('‚úó Caller Name: Incorrect (Correct: ' + correctAnswers.callerName + ')');
            }
            
            // Check Address (case-insensitive, flexible matching)
            if (userAnswers.address.toLowerCase() === correctAnswers.address.toLowerCase()) {
                score += 33.33;
                feedback.push('‚úì Address: Correct');
            } else {
                feedback.push('‚úó Address: Incorrect (Correct: ' + correctAnswers.address + ')');
            }
            
            // Check Incident Type (case-insensitive, flexible matching)
            if (userAnswers.incidentType.toLowerCase() === correctAnswers.incidentType.toLowerCase()) {
                score += 33.34;
                feedback.push('‚úì Incident Type: Correct');
            } else {
                feedback.push('‚úó Incident Type: Incorrect (Correct: ' + correctAnswers.incidentType + ')');
            }
            
            // Display results
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div class="score-display">
                    <h3>Data Entry Results</h3>
                    <h2>${Math.round(score)}%</h2>
                    <p>Audio played ${audioPlayCount} time(s)</p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>Detailed Feedback:</h3>
                    ${feedback.map(f => `<p style="margin: 10px 0; font-size: 16px;">${f}</p>`).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showDataEntry()">Try Another Scenario</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'dataEntry',
                    score: Math.round(score),
                    audioPlays: audioPlayCount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // CALL SUMMARIZATION MODULE
        function showCallSummarization() {
            document.getElementById('moduleTitle').textContent = 'üéØ Call Summarization Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = callScenarios.length;
            
            showNextCallScenario();
        }
        
        function showNextCallScenario() {
            if (currentQuestion >= callScenarios.length) {
                showCallSummarizationResults();
                return;
            }
            
            const scenario = callScenarios[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div class="incident-scenario">
                    <h3>üìû Emergency Call</h3>
                    <p style="font-size: 16px; line-height: 1.6;">${scenario.scenario}</p>
                </div>
                
                <div class="decision-section">
                    <h3>Select Appropriate Services:</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-police" value="police">
                            <label for="service-police">üöî Police</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-fire" value="fire">
                            <label for="service-fire">üöí Fire Department</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-ems" value="ems">
                            <label for="service-ems">üöë EMS/Medical</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-utilities" value="utilities">
                            <label for="service-utilities">‚ö° Utilities</label>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Select Priority Level:</h3>
                    <div class="priority-buttons">
                        <button class="priority-btn high" onclick="selectPriority('high')">HIGH<br><small>Life-threatening / Immediate danger</small></button>
                        <button class="priority-btn medium" onclick="selectPriority('medium')">MEDIUM<br><small>Urgent but not life-threatening</small></button>
                        <button class="priority-btn low" onclick="selectPriority('low')">LOW<br><small>Non-urgent / Routine</small></button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitCallDecision()">Submit Decision</button>
                </div>
            `;
        }
        
        function selectPriority(priority) {
            // Remove selection from all buttons
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selection to clicked button
            event.target.classList.add('selected');
            selectedPriority = priority;
        }
        
        function submitCallDecision() {
            const scenario = callScenarios[currentQuestion];
            
            // Get selected services
            selectedServices = [];
            if (document.getElementById('service-police').checked) selectedServices.push('police');
            if (document.getElementById('service-fire').checked) selectedServices.push('fire');
            if (document.getElementById('service-ems').checked) selectedServices.push('ems');
            if (document.getElementById('service-utilities').checked) selectedServices.push('utilities');
            
            // Check if user made selections
            if (selectedServices.length === 0 || !selectedPriority) {
                alert('Please select at least one service and a priority level.');
                return;
            }
            
            // Check if answer is correct
            const servicesCorrect = arraysEqual(selectedServices.sort(), scenario.correctServices.sort());
            const priorityCorrect = selectedPriority === scenario.correctPriority;
            
            if (servicesCorrect && priorityCorrect) {
                correctAnswers++;
            }
            
            // Show feedback
            let feedback = '<div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">';
            feedback += '<h3>Feedback:</h3>';
            feedback += `<p><strong>Services:</strong> ${servicesCorrect ? '‚úì Correct' : '‚úó Incorrect'}</p>`;
            if (!servicesCorrect) {
                feedback += `<p style="margin-left: 20px;">Correct services: ${scenario.correctServices.join(', ')}</p>`;
            }
            feedback += `<p><strong>Priority:</strong> ${priorityCorrect ? '‚úì Correct' : '‚úó Incorrect'}</p>`;
            if (!priorityCorrect) {
                feedback += `<p style="margin-left: 20px;">Correct priority: ${scenario.correctPriority}</p>`;
            }
            feedback += '</div>';
            
            document.getElementById('moduleContent').innerHTML += feedback;
            
            // Add continue button
            setTimeout(() => {
                const continueBtn = document.createElement('div');
                continueBtn.style.textAlign = 'center';
                continueBtn.style.marginTop = '20px';
                continueBtn.innerHTML = '<button class="btn btn-primary" onclick="nextCallQuestion()">Continue to Next Call</button>';
                document.getElementById('moduleContent').appendChild(continueBtn);
            }, 500);
        }
        
        function nextCallQuestion() {
            currentQuestion++;
            selectedPriority = null;
            selectedServices = [];
            showNextCallScenario();
        }
        
        function showCallSummarizationResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Call Summarization Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showCallSummarization()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'callSummarization',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // MEMORY RECALL MODULE
        function showMemoryRecall() {
            document.getElementById('moduleTitle').textContent = 'üß† Memory Recall Practice';
            
            // Clear any existing timer when going back to difficulty selection
            if (memoryTimerInterval) {
                clearInterval(memoryTimerInterval);
                memoryTimerInterval = null;
            }
            
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <h3>Select Difficulty Level:</h3>
                <div style="display: flex; gap: 15px; justify-content: center; margin: 30px 0;">
                    <button class="btn btn-success" onclick="startMemoryTest('easy')" style="min-width: 150px;">Easy<br><small>3 questions</small></button>
                    <button class="btn btn-primary" onclick="startMemoryTest('medium')" style="min-width: 150px;">Medium<br><small>5 questions</small></button>
                    <button class="btn btn-danger" onclick="startMemoryTest('hard')" style="min-width: 150px;">Hard<br><small>6 questions</small></button>
                </div>
            `;
        }
        
        function startMemoryTest(difficulty) {
            // Clear any existing timer first
            if (memoryTimerInterval) {
                clearInterval(memoryTimerInterval);
                memoryTimerInterval = null;
            }
            
            const testData = memoryQuestions[difficulty][Math.floor(Math.random() * memoryQuestions[difficulty].length)];
            
            // Show memory items
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <h3>Memorize the following information (30 seconds):</h3>
                <div class="memory-items">
                    ${testData.items.map(item => `<div class="memory-item">${item}</div>`).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <p style="font-size: 24px; font-weight: bold; color: #007bff;">Time remaining: <span id="timer">30</span>s</p>
                </div>
            `;
            
            // Countdown timer
            let timeLeft = 30;
            memoryTimerInterval = setInterval(() => {
                timeLeft--;
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = timeLeft;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(memoryTimerInterval);
                    memoryTimerInterval = null;
                    showMemoryQuestions(testData.questions);
                }
            }, 1000);
        }
        
        function showMemoryQuestions(questions) {
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = questions.length;
            window.currentMemoryQuestions = questions;
            
            showNextMemoryQuestion();
        }
        
        function showNextMemoryQuestion() {
            const questions = window.currentMemoryQuestions;
            
            if (currentQuestion >= questions.length) {
                showMemoryResults();
                return;
            }
            
            const question = questions[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div class="memory-question">
                    <h3>${question.q}</h3>
                    <input type="text" id="memoryAnswer" placeholder="Your answer" style="width: 100%; padding: 15px; font-size: 18px; border: 2px solid #007bff; border-radius: 5px; margin-top: 15px;">
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitMemoryAnswer()">Submit Answer</button>
                </div>
            `;
            
            // Focus on input
            document.getElementById('memoryAnswer').focus();
            
            // Allow Enter key to submit
            document.getElementById('memoryAnswer').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitMemoryAnswer();
                }
            });
        }
        
        function submitMemoryAnswer() {
            const questions = window.currentMemoryQuestions;
            const question = questions[currentQuestion];
            const userAnswer = document.getElementById('memoryAnswer').value.trim();
            
            // Flexible matching (case-insensitive, whitespace tolerant)
            const correct = userAnswer.toLowerCase().replace(/\s+/g, ' ') === question.a.toLowerCase().replace(/\s+/g, ' ');
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.a}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Add continue button
            setTimeout(() => {
                const continueBtn = document.createElement('div');
                continueBtn.style.textAlign = 'center';
                continueBtn.style.marginTop = '20px';
                continueBtn.innerHTML = '<button class="btn btn-primary" onclick="nextMemoryQuestion()">Next Question</button>';
                document.getElementById('moduleContent').appendChild(continueBtn);
            }, 500);
        }
        
        function nextMemoryQuestion() {
            currentQuestion++;
            showNextMemoryQuestion();
        }
        
        function showMemoryResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Memory Recall Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMemoryRecall()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'memoryRecall',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // MAP READING MODULE
        function showMapReading() {
            document.getElementById('moduleTitle').textContent = 'üó∫Ô∏è Map Reading & Navigation';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = mapScenarios.length;
            
            showNextMapQuestion();
        }
        
        function showNextMapQuestion() {
            if (currentQuestion >= mapScenarios.length) {
                showMapResults();
                return;
            }
            
            const scenario = mapScenarios[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Scenario ${currentQuestion + 1} of ${totalQuestions}</p>
                </div>
                
                <h3>${scenario.question}</h3>
                
                <div class="map-container">
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff6b6b;"></div>
                            <span>Hospital</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4dabf7;"></div>
                            <span>Police Station</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff8787;"></div>
                            <span>Fire Station</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffd43b;"></div>
                            <span>School</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #69db7c;"></div>
                            <span>Shopping Mall</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #da77f2;"></div>
                            <span>Library</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8ce99a;"></div>
                            <span>Park</span>
                        </div>
                        <div class="legend-item">
                            <span style="color: #ff0000; font-size: 20px;">‚Üë‚Üì‚Üí‚Üê</span>
                            <span>One-way streets</span>
                        </div>
                    </div>
                    
                    ${generateCityMap()}
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #007bff;">
                    <h3>Enter your route:</h3>
                    <p>Describe the streets and directions (e.g., "Main St south, then 4th Ave east")</p>
                    <textarea id="routeAnswer" class="route-input" rows="3" placeholder="Type your route here..."></textarea>
                    
                    ${scenario.avoidStreets.length > 0 ? `
                        <p style="color: #dc3545; margin-top: 10px;"><strong>‚ö† Note:</strong> ${scenario.avoidStreets.join(', ')}</p>
                    ` : ''}
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitMapRoute()">Submit Route</button>
                </div>
            `;
        }
        
        function generateCityMap() {
            // 10x10 grid city map
            const map = [
                // Row 0 - Header with avenue names
                ['', '1st Ave', '2nd Ave', '3rd Ave', '4th Ave', '5th Ave', '6th Ave', '7th Ave', '8th Ave', ''],
                // Row 1
                ['Main St', 'building-hospital', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'Main St'],
                // Row 2
                ['', 'street-v', 'building-police', '', 'building-park', '', '', 'building-library', '', ''],
                // Row 3
                ['Oak St', 'street-v one-way-n', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'Oak St'],
                // Row 4
                ['', 'street-v', '', 'building-school', '', '', 'building-mall', '', '', ''],
                // Row 5
                ['Elm St', 'street-v', 'street-h one-way-e', 'street-h one-way-e', 'street-h one-way-e', 'street-h one-way-e', 'street-h one-way-e', 'street-h', 'street-h', 'Elm St'],
                // Row 6
                ['', 'street-v', '', '', '', 'building-fire', '', '', '', ''],
                // Row 7
                ['Pine St', 'street-v', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'Pine St'],
                // Row 8
                ['', 'street-v', '', '', '', '', '', '', '', ''],
                // Row 9 - Footer
                ['', '1st Ave', '2nd Ave', '3rd Ave', '4th Ave', '5th Ave', '6th Ave', '7th Ave', '8th Ave', '']
            ];
            
            let html = '<div class="map-grid">';
            for (let row of map) {
                for (let cell of row) {
                    if (cell.includes('building')) {
                        const buildingType = cell.split(' ')[0];
                        const extraClass = cell.includes('one-way') ? cell.split(' ')[1] : '';
                        const buildingName = buildingType.replace('building-', '').toUpperCase();
                        html += `<div class="map-cell ${cell}">${buildingName}</div>`;
                    } else if (cell.includes('street')) {
                        html += `<div class="map-cell ${cell}"></div>`;
                    } else if (cell === '') {
                        html += `<div class="map-cell"></div>`;
                    } else {
                        html += `<div class="map-cell" style="background: #fff; font-weight: bold;">${cell}</div>`;
                    }
                }
            }
            html += '</div>';
            return html;
        }
        
        function submitMapRoute() {
            const scenario = mapScenarios[currentQuestion];
            const userRoute = document.getElementById('routeAnswer').value.trim().toLowerCase();
            
            // Simple route validation - check if key streets are mentioned
            let routeScore = 0;
            let feedback = [];
            
            // Check if route includes correct streets
            scenario.correctRoute.forEach(street => {
                const streetName = street.toLowerCase().split(' ')[0];
                if (userRoute.includes(streetName)) {
                    routeScore += (100 / scenario.correctRoute.length);
                    feedback.push(`‚úì Correctly included ${street}`);
                } else {
                    feedback.push(`‚úó Missing: ${street}`);
                }
            });
            
            // Check if route avoids restricted streets
            let avoidedRestrictions = true;
            scenario.avoidStreets.forEach(avoid => {
                const streetName = avoid.toLowerCase().split(' ')[0];
                if (userRoute.includes(streetName)) {
                    routeScore = Math.max(0, routeScore - 30);
                    feedback.push(`‚úó Should avoid ${avoid}`);
                    avoidedRestrictions = false;
                }
            });
            
            if (avoidedRestrictions && scenario.avoidStreets.length > 0) {
                feedback.push(`‚úì Correctly avoided restricted streets`);
            }
            
            if (routeScore >= 80) {
                correctAnswers++;
            }
            
            // Show feedback
            const content = document.getElementById('moduleContent');
            content.innerHTML += `
                <div style="background: ${routeScore >= 80 ? '#d4edda' : '#fff3cd'}; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid ${routeScore >= 80 ? '#28a745' : '#ffc107'};">
                    <h3>Route Evaluation: ${Math.round(routeScore)}%</h3>
                    ${feedback.map(f => `<p style="margin: 5px 0;">${f}</p>`).join('')}
                    <p style="margin-top: 15px;"><strong>Optimal route:</strong> ${scenario.correctRoute.join(', ')}</p>
                </div>
            `;
            
            // Add continue button
            setTimeout(() => {
                const continueBtn = document.createElement('div');
                continueBtn.style.textAlign = 'center';
                continueBtn.style.marginTop = '20px';
                continueBtn.innerHTML = '<button class="btn btn-primary" onclick="nextMapQuestion()">Next Scenario</button>';
                document.getElementById('moduleContent').appendChild(continueBtn);
            }, 500);
        }
        
        function nextMapQuestion() {
            currentQuestion++;
            showNextMapQuestion();
        }
        
        function showMapResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Map Reading Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Routes Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMapReading()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'mapReading',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // Helper function to compare arrays
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }
        
        // READING COMPREHENSION MODULE
        function showReadingComprehension() {
            document.getElementById('moduleTitle').textContent = 'üìò Reading Comprehension Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = 0;
            
            // Calculate total questions across all passages
            readingPassages.forEach(passage => {
                totalQuestions += passage.questions.length;
            });
            
            showNextPassage(0, 0);
        }
        
        function showNextPassage(passageIndex, questionIndex) {
            if (passageIndex >= readingPassages.length) {
                showReadingResults();
                return;
            }
            
            const passage = readingPassages[passageIndex];
            const question = passage.questions[questionIndex];
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #007bff;">
                    <h3 style="color: #007bff; margin-bottom: 15px;">${passage.title}</h3>
                    <p style="line-height: 1.8; font-size: 16px; text-align: justify;">${passage.passage}</p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #28a745;">
                    <h4 style="margin-bottom: 15px;">${question.q}</h4>
                    ${question.options.map((opt, i) => `
                        <div style="margin: 10px 0;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 5px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                <input type="radio" name="answer" value="${i}" style="margin-right: 10px; width: 20px; height: 20px;">
                                <span style="font-size: 16px;">${opt}</span>
                            </label>
                        </div>
                    `).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitReadingAnswer(${passageIndex}, ${questionIndex})">Submit Answer</button>
                </div>
            `;
        }
        
        function submitReadingAnswer(passageIndex, questionIndex) {
            const selected = document.querySelector('input[name="answer"]:checked');
            
            if (!selected) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const passage = readingPassages[passageIndex];
            const question = passage.questions[questionIndex];
            const userAnswer = parseInt(selected.value);
            const correct = userAnswer === question.correct;
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.options[question.correct]}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Move to next question
            currentQuestion++;
            setTimeout(() => {
                questionIndex++;
                if (questionIndex >= passage.questions.length) {
                    passageIndex++;
                    questionIndex = 0;
                }
                showNextPassage(passageIndex, questionIndex);
            }, 1500);
        }
        
        function showReadingResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Reading Comprehension Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showReadingComprehension()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'readingComprehension',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // SPELLING MODULE
        function showSpelling() {
            document.getElementById('moduleTitle').textContent = '‚úèÔ∏è Spelling Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = spellingQuestions.length;
            
            showNextSpellingQuestion();
        }
        
        function showNextSpellingQuestion() {
            if (currentQuestion >= spellingQuestions.length) {
                showSpellingResults();
                return;
            }
            
            const question = spellingQuestions[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 10px; margin: 20px 0; text-align: center;">
                    <h3 style="margin-bottom: 20px;">Which spelling is correct?</h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 30px;">Select the correctly spelled word</p>
                    
                    ${question.options.map((opt, i) => `
                        <div style="margin: 15px 0;">
                            <label style="display: block; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 20px; font-family: monospace;" onmouseover="this.style.borderColor='#007bff'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'">
                                <input type="radio" name="spelling" value="${i}" style="margin-right: 15px; width: 20px; height: 20px;">
                                ${opt}
                            </label>
                        </div>
                    `).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitSpellingAnswer()">Submit Answer</button>
                </div>
            `;
        }
        
        function submitSpellingAnswer() {
            const selected = document.querySelector('input[name="spelling"]:checked');
            
            if (!selected) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const question = spellingQuestions[currentQuestion];
            const userAnswer = parseInt(selected.value);
            const correct = userAnswer === question.correct;
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0; font-family: monospace; font-size: 20px;">Correct spelling: <strong>${question.options[question.correct]}</strong></p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Move to next question
            setTimeout(() => {
                currentQuestion++;
                showNextSpellingQuestion();
            }, 1500);
        }
        
        function showSpellingResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Spelling Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showSpelling()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'spelling',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // SENTENCE CLARITY MODULE
        function showSentenceClarity() {
            document.getElementById('moduleTitle').textContent = 'üó£Ô∏è Sentence Clarity Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = sentenceClarityQuestions.length;
            
            showNextClarityQuestion();
        }
        
        function showNextClarityQuestion() {
            if (currentQuestion >= sentenceClarityQuestions.length) {
                showClarityResults();
                return;
            }
            
            const question = sentenceClarityQuestions[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #ffc107; text-align: center;">
                    <h3 style="color: #856404;">${question.question}</h3>
                    <p style="font-size: 14px; color: #856404; margin-top: 10px;">Choose the clearest, most concise sentence</p>
                </div>
                
                ${question.options.map((opt, i) => `
                    <div style="margin: 15px 0;">
                        <label style="display: block; padding: 15px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#007bff'; this.style.transform='translateX(5px)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateX(0)'">
                            <input type="radio" name="clarity" value="${i}" style="margin-right: 10px; width: 18px; height: 18px;">
                            <span style="font-size: 16px; line-height: 1.6;">${opt}</span>
                        </label>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitClarityAnswer()">Submit Answer</button>
                </div>
            `;
        }
        
        function submitClarityAnswer() {
            const selected = document.querySelector('input[name="clarity"]:checked');
            
            if (!selected) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const question = sentenceClarityQuestions[currentQuestion];
            const userAnswer = parseInt(selected.value);
            const correct = userAnswer === question.correct;
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.options[question.correct]}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Move to next question
            setTimeout(() => {
                currentQuestion++;
                showNextClarityQuestion();
            }, 1500);
        }
        
        function showClarityResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Sentence Clarity Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showSentenceClarity()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'sentenceClarity',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // MATHEMATICS MODULE
        function showMathematics() {
            document.getElementById('moduleTitle').textContent = '‚ûï Mathematics Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = mathQuestions.length;
            
            showNextMathQuestion();
        }
        
        function showNextMathQuestion() {
            if (currentQuestion >= mathQuestions.length) {
                showMathResults();
                return;
            }
            
            const question = mathQuestions[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #e3f2fd; padding: 25px; border-radius: 10px; margin: 20px 0; border: 2px solid #2196f3;">
                    <h3 style="color: #1976d2; margin-bottom: 20px; text-align: center;">${question.question}</h3>
                    <p style="text-align: center; color: #1976d2; font-size: 14px;">‚ö† No calculator allowed - work it out mentally or on paper</p>
                </div>
                
                ${question.options.map((opt, i) => `
                    <div style="margin: 12px 0;">
                        <label style="display: block; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 18px;" onmouseover="this.style.borderColor='#2196f3'; this.style.background='#f5f5f5'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                            <input type="radio" name="math" value="${i}" style="margin-right: 12px; width: 20px; height: 20px;">
                            <strong style="margin-right: 10px;">${String.fromCharCode(65 + i)})</strong> ${opt}
                        </label>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitMathAnswer()">Submit Answer</button>
                </div>
            `;
        }
        
        function submitMathAnswer() {
            const selected = document.querySelector('input[name="math"]:checked');
            
            if (!selected) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const question = mathQuestions[currentQuestion];
            const userAnswer = parseInt(selected.value);
            const correct = userAnswer === question.correct;
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.options[question.correct]}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Move to next question
            setTimeout(() => {
                currentQuestion++;
                showNextMathQuestion();
            }, 1500);
        }
        
        function showMathResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Mathematics Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMathematics()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'mathematics',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // SPLIT ATTENTION MODULE
        let splitAttentionState = {
            currentRound: 1,
            totalRounds: 4,
            rounds: [
                {
                    roundNumber: 1,
                    targetNumbers: [33], // 1 target number
                    interval: 5000, // 5 seconds - slower for first round
                    duration: 90, // 1.5 minutes
                    description: "Round 1: Watch for number 33"
                },
                {
                    roundNumber: 2,
                    targetNumbers: [33, 55], // 2 target numbers
                    interval: 4000, // 4 seconds
                    duration: 90,
                    description: "Round 2: Watch for numbers 33 and 55"
                },
                {
                    roundNumber: 3,
                    targetNumbers: [33, 55, 77], // 3 target numbers
                    interval: 3000, // 3 seconds
                    duration: 90,
                    description: "Round 3: Watch for numbers 33, 55, and 77"
                },
                {
                    roundNumber: 4,
                    targetNumbers: [22, 44, 66, 88], // 4 different target numbers, fastest
                    interval: 2500, // 2.5 seconds - fastest round
                    duration: 120, // 2 minutes for final challenge
                    description: "Round 4: Watch for numbers 22, 44, 66, and 88"
                }
            ],
            displayNumbers: [11, 12, 13, 14, 21, 23, 24, 31, 32, 34, 41, 42, 43, 51, 52, 53, 54, 61, 62, 63, 64, 71, 72, 73, 74, 81, 82, 83, 84, 91, 92, 93, 94],
            corners: [null, null, null, null],
            typingText: '',
            typedText: '',
            correctClicks: 0,
            missedTargets: 0,
            falseClicks: 0,
            startTime: null,
            roundStartTime: null,
            currentTargets: [],
            currentInterval: null,
            roundResults: []
        };
        
        function showSplitAttention() {
            document.getElementById('moduleTitle').textContent = 'üëÅÔ∏è Progressive Split Attention Training';
            
            // Reset state
            splitAttentionState.currentRound = 1;
            splitAttentionState.roundResults = [];
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <h3>Progressive Training Overview:</h3>
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin-bottom: 20px;">
                    <p><strong>This training consists of 4 progressive rounds to build your divided attention skills:</strong></p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0;">
                        ${splitAttentionState.rounds.map(round => `
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #007bff;">
                                <h4 style="color: #007bff; margin-bottom: 8px;">Round ${round.roundNumber}</h4>
                                <p style="margin: 5px 0; font-size: 14px;"><strong>Targets:</strong> ${round.targetNumbers.join(', ')}</p>
                                <p style="margin: 5px 0; font-size: 14px;"><strong>Speed:</strong> ${round.interval/1000}s intervals</p>
                                <p style="margin: 5px 0; font-size: 14px;"><strong>Duration:</strong> ${Math.floor(round.duration/60)}:${(round.duration%60).toString().padStart(2,'0')}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin-top: 15px;">
                        <h4 style="margin-bottom: 10px;">Training Instructions:</h4>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li><strong>Type the passage</strong> shown in the center - accuracy and speed matter</li>
                            <li><strong>Watch the 4 corner boxes</strong> for target numbers (they change at different speeds each round)</li>
                            <li><strong>Click immediately</strong> when you see a target number appear</li>
                            <li><strong>Progress through rounds</strong> - each gets faster with more targets</li>
                        </ol>
                        <p style="color: #0066cc; margin-top: 10px;"><strong>üí° Tip:</strong> Focus primarily on typing, but stay alert for targets in your peripheral vision!</p>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="startSplitAttentionRound(1)" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">Begin Round 1</button>
                </div>
            `;
        }
        
        function startSplitAttentionRound(roundNumber) {
            // Reset state for new round
            const currentRound = splitAttentionState.rounds[roundNumber - 1];
            splitAttentionState.currentRound = roundNumber;
            splitAttentionState.currentTargets = currentRound.targetNumbers;
            splitAttentionState.currentInterval = currentRound.interval;
            splitAttentionState.typingText = splitAttentionPassages[Math.floor(Math.random() * splitAttentionPassages.length)];
            splitAttentionState.typedText = '';
            splitAttentionState.correctClicks = 0;
            splitAttentionState.missedTargets = 0;
            splitAttentionState.falseClicks = 0;
            splitAttentionState.roundStartTime = Date.now();
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>${currentRound.description}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                            <strong>Round ${roundNumber}/4</strong>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                            <strong>Speed: ${currentRound.interval/1000}s</strong>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                            <strong>Targets: ${currentRound.targetNumbers.map(n => `<span style="background: #ff6b6b; padding: 2px 6px; border-radius: 3px; margin: 0 2px;">${n}</span>`).join('')}</strong>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px; text-align: center;">
                            <strong>Time: <span id="splitTimeLeft">${Math.floor(currentRound.duration/60)}:${(currentRound.duration%60).toString().padStart(2,'0')}</span></strong>
                        </div>
                    </div>
                </div>
                
                <div style="position: relative; min-height: 500px; background: #f8f9fa; padding: 40px; border-radius: 10px;">
                    <!-- Corner Boxes -->
                    <div id="corner0" class="corner-box" style="position: absolute; top: 20px; left: 20px; width: 80px; height: 80px; background: white; border: 3px solid #007bff; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="clickCorner(0)">--</div>
                    <div id="corner1" class="corner-box" style="position: absolute; top: 20px; right: 20px; width: 80px; height: 80px; background: white; border: 3px solid #007bff; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="clickCorner(1)">--</div>
                    <div id="corner2" class="corner-box" style="position: absolute; bottom: 20px; left: 20px; width: 80px; height: 80px; background: white; border: 3px solid #007bff; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="clickCorner(2)">--</div>
                    <div id="corner3" class="corner-box" style="position: absolute; bottom: 20px; right: 20px; width: 80px; height: 80px; background: white; border: 3px solid #007bff; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; cursor: pointer;" onclick="clickCorner(3)">--</div>
                    
                    <!-- Center Typing Area -->
                    <div style="margin: 60px 120px; text-align: center;">
                        <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #28a745; margin-bottom: 15px;">
                            <p style="font-size: 18px; line-height: 1.8; color: #333;">${splitAttentionState.typingText}</p>
                        </div>
                        
                        <textarea id="splitTypingInput" style="width: 100%; height: 120px; padding: 15px; border: 2px solid #007bff; border-radius: 10px; font-size: 16px; line-height: 1.6; resize: vertical;" placeholder="Start typing the passage above..."></textarea>
                        
                        <!-- Stats Display -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; text-align: center;">
                            <div style="background: #d4edda; padding: 10px; border-radius: 5px; border: 1px solid #c3e6cb;">
                                <strong>Correct Clicks</strong><br>
                                <span id="splitCorrectClicks" style="font-size: 24px; color: #28a745;">0</span>
                            </div>
                            <div style="background: #f8d7da; padding: 10px; border-radius: 5px; border: 1px solid #f5c6cb;">
                                <strong>Missed Targets</strong><br>
                                <span id="splitMissed" style="font-size: 24px; color: #dc3545;">0</span>
                            </div>
                            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeaa7;">
                                <strong>False Clicks</strong><br>
                                <span id="splitFalse" style="font-size: 24px; color: #856404;">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Set up input listener for typing
            document.getElementById('splitTypingInput').addEventListener('input', (e) => {
                splitAttentionState.typedText = e.target.value;
            });
            
            // Focus on typing input
            document.getElementById('splitTypingInput').focus();
            
            // Start the round
            cycleSplitAttentionNumbers();
            updateSplitAttentionTimer();
        }
        
        function cycleSplitAttentionNumbers() {
            if (splitAttentionInterval) {
                clearInterval(splitAttentionInterval);
            }
            
            splitAttentionInterval = setInterval(() => {
                // Randomly update each corner
                for (let i = 0; i < 4; i++) {
                    const oldNumber = splitAttentionState.corners[i];
                    // Combine display numbers with current round's targets for selection
                    const allNumbers = [...splitAttentionState.displayNumbers, ...splitAttentionState.currentTargets];
                    const newNumber = allNumbers[Math.floor(Math.random() * allNumbers.length)];
                    splitAttentionState.corners[i] = newNumber;
                    
                    const cornerElement = document.getElementById(`corner${i}`);
                    if (cornerElement) {
                        cornerElement.textContent = newNumber;
                        
                        // If this was a target that wasn't clicked, count as missed
                        if (oldNumber && splitAttentionState.currentTargets.includes(oldNumber)) {
                            splitAttentionState.missedTargets++;
                            document.getElementById('splitMissed').textContent = splitAttentionState.missedTargets;
                        }
                        
                        // Highlight if target number
                        if (splitAttentionState.currentTargets.includes(newNumber)) {
                            cornerElement.style.background = '#ffebee';
                            cornerElement.style.borderColor = '#dc3545';
                        } else {
                            cornerElement.style.background = 'white';
                            cornerElement.style.borderColor = '#007bff';
                        }
                    }
                }
            }, splitAttentionState.currentInterval);
        }
        
        function clickCorner(cornerIndex) {
            const number = splitAttentionState.corners[cornerIndex];
            const cornerElement = document.getElementById(`corner${cornerIndex}`);
            
            if (splitAttentionState.currentTargets.includes(number)) {
                // Correct click
                splitAttentionState.correctClicks++;
                document.getElementById('splitCorrectClicks').textContent = splitAttentionState.correctClicks;
                
                // Visual feedback
                cornerElement.style.background = '#d4edda';
                setTimeout(() => {
                    cornerElement.style.background = 'white';
                }, 300);
                
                // Replace with new number immediately
                const allNumbers = [...splitAttentionState.displayNumbers, ...splitAttentionState.currentTargets];
                splitAttentionState.corners[cornerIndex] = allNumbers[Math.floor(Math.random() * allNumbers.length)];
                cornerElement.textContent = splitAttentionState.corners[cornerIndex];
            } else {
                // False click
                splitAttentionState.falseClicks++;
                document.getElementById('splitFalse').textContent = splitAttentionState.falseClicks;
                
                // Visual feedback
                cornerElement.style.background = '#f8d7da';
                setTimeout(() => {
                    cornerElement.style.background = 'white';
                }, 300);
            }
        }
        
        function updateSplitAttentionTimer() {
            if (splitAttentionTimer) {
                clearInterval(splitAttentionTimer);
            }
            
            const currentRound = splitAttentionState.rounds[splitAttentionState.currentRound - 1];
            
            splitAttentionTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - splitAttentionState.roundStartTime) / 1000);
                const remaining = currentRound.duration - elapsed;
                
                if (remaining <= 0) {
                    finishSplitAttentionRound();
                    return;
                }
                
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                const timeElement = document.getElementById('splitTimeLeft');
                if (timeElement) {
                    timeElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
        
        function finishSplitAttentionRound() {
            clearInterval(splitAttentionInterval);
            clearInterval(splitAttentionTimer);
            
            // Calculate round performance
            const currentRound = splitAttentionState.rounds[splitAttentionState.currentRound - 1];
            const originalLength = splitAttentionState.typingText.length;
            const typedLength = splitAttentionState.typedText.length;
            
            let correctChars = 0;
            for (let i = 0; i < Math.min(typedLength, originalLength); i++) {
                if (splitAttentionState.typedText[i] === splitAttentionState.typingText[i]) {
                    correctChars++;
                }
            }
            
            const typingAccuracy = originalLength > 0 ? Math.round((correctChars / originalLength) * 100) : 0;
            const totalTargets = splitAttentionState.correctClicks + splitAttentionState.missedTargets;
            const detectionRate = totalTargets > 0 ? Math.round((splitAttentionState.correctClicks / totalTargets) * 100) : 0;
            const overallScore = Math.round((typingAccuracy * 0.6) + (detectionRate * 0.4));
            
            // Store round result
            splitAttentionState.roundResults.push({
                round: splitAttentionState.currentRound,
                typingAccuracy: typingAccuracy,
                detectionRate: detectionRate,
                overallScore: overallScore,
                correctClicks: splitAttentionState.correctClicks,
                missedTargets: splitAttentionState.missedTargets,
                falseClicks: splitAttentionState.falseClicks,
                typedLength: typedLength,
                originalLength: originalLength
            });
            
            showSplitAttentionRoundResults();
        }
        
        function showSplitAttentionRoundResults() {
            const roundResult = splitAttentionState.roundResults[splitAttentionState.currentRound - 1];
            const currentRound = splitAttentionState.rounds[splitAttentionState.currentRound - 1];
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div style="background: ${roundResult.overallScore >= 70 ? '#d4edda' : roundResult.overallScore >= 50 ? '#fff3cd' : '#f8d7da'}; border: 2px solid ${roundResult.overallScore >= 70 ? '#c3e6cb' : roundResult.overallScore >= 50 ? '#ffeaa7' : '#f5c6cb'}; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3>Round ${splitAttentionState.currentRound} Complete!</h3>
                    <h2>Overall Score: ${roundResult.overallScore}%</h2>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="margin-bottom: 15px;">Round ${splitAttentionState.currentRound} Performance:</h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4>Typing Accuracy</h4>
                            <div style="color: ${roundResult.typingAccuracy >= 70 ? '#28a745' : '#dc3545'}; font-weight: bold; font-size: 24px;">
                                ${roundResult.typingAccuracy}%
                            </div>
                            <small>${roundResult.typedLength} / ${roundResult.originalLength} characters</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4>Target Detection</h4>
                            <div style="color: ${roundResult.detectionRate >= 70 ? '#28a745' : '#dc3545'}; font-weight: bold; font-size: 24px;">
                                ${roundResult.detectionRate}%
                            </div>
                            <small>Correct: ${roundResult.correctClicks}, Missed: ${roundResult.missedTargets}</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4>Accuracy</h4>
                            <div style="color: ${roundResult.falseClicks <= 2 ? '#28a745' : '#dc3545'}; font-weight: bold; font-size: 24px;">
                                ${roundResult.falseClicks} false clicks
                            </div>
                            <small>Avoid clicking non-targets</small>
                        </div>
                    </div>
                </div>
                
                <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin: 20px 0; border: 1px solid #007bff;">
                    <h4>üìà Progress Update:</h4>
                    <p>${roundResult.overallScore >= 80 ? 
                        "<strong>Excellent!</strong> You're mastering divided attention skills. Ready for more challenging rounds!" :
                        roundResult.overallScore >= 60 ?
                        "<strong>Good progress!</strong> Keep practicing the balance between typing accuracy and target detection." :
                        "<strong>Keep practicing!</strong> Focus on maintaining typing rhythm while staying alert for targets."
                    }</p>
                </div>
                
                <div style="text-align: center;">
                    ${splitAttentionState.currentRound < splitAttentionState.totalRounds ?
                        `<button class="btn btn-primary" onclick="startSplitAttentionRound(${splitAttentionState.currentRound + 1})" style="background: #007bff; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; margin-right: 10px;">Continue to Round ${splitAttentionState.currentRound + 1}</button>` :
                        `<button class="btn btn-success" onclick="showSplitAttentionFinalResults()" style="background: #28a745; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; margin-right: 10px;">View Final Results</button>`
                    }
                    <button class="btn btn-danger" onclick="closeModule()" style="background: #dc3545; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; cursor: pointer;">Exit Training</button>
                </div>
            `;
        }
        
        function showSplitAttentionFinalResults() {
            const totalScore = Math.round(splitAttentionState.roundResults.reduce((sum, result) => sum + result.overallScore, 0) / splitAttentionState.roundResults.length);
            const totalCorrectClicks = splitAttentionState.roundResults.reduce((sum, result) => sum + result.correctClicks, 0);
            const totalMissedTargets = splitAttentionState.roundResults.reduce((sum, result) => sum + result.missedTargets, 0);
            const totalFalseClicks = splitAttentionState.roundResults.reduce((sum, result) => sum + result.falseClicks, 0);
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px;">
                    <h3>üéØ Progressive Split Attention Training Complete!</h3>
                    <h2>Final Average Score: ${totalScore}%</h2>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3>Round-by-Round Performance:</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                        ${splitAttentionState.roundResults.map((result, index) => `
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid ${result.overallScore >= 70 ? '#28a745' : '#ffc107'};">
                                <h4>Round ${result.round}</h4>
                                <div style="color: ${result.overallScore >= 70 ? '#28a745' : '#ffc107'}; font-weight: bold; font-size: 20px;">
                                    ${result.overallScore}%
                                </div>
                                <small>Typing: ${result.typingAccuracy}% | Targets: ${result.detectionRate}%</small>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3>Overall Statistics:</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0;">
                        <div style="background: #d4edda; padding: 15px; border-radius: 8px; text-align: center;">
                            <strong>Total Correct Clicks</strong><br>
                            <span style="font-size: 24px; color: #28a745;">${totalCorrectClicks}</span>
                        </div>
                        <div style="background: #f8d7da; padding: 15px; border-radius: 8px; text-align: center;">
                            <strong>Total Missed</strong><br>
                            <span style="font-size: 24px; color: #dc3545;">${totalMissedTargets}</span>
                        </div>
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; text-align: center;">
                            <strong>Total False Clicks</strong><br>
                            <span style="font-size: 24px; color: #856404;">${totalFalseClicks}</span>
                        </div>
                    </div>
                </div>
                
                <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; border: 2px solid #007bff;">
                    <h4>üìã Training Assessment:</h4>
                    <p>${
                        totalScore >= 85 ? 
                            "<strong>Outstanding!</strong> You've demonstrated excellent divided attention skills across all difficulty levels. Your ability to multitask effectively will serve you well in emergency dispatch scenarios." :
                        totalScore >= 70 ?
                            "<strong>Great progress!</strong> You've shown solid improvement through the progressive training. Continue practicing to maintain and enhance these divided attention skills." :
                        totalScore >= 55 ?
                            "<strong>Good effort!</strong> The training shows you're developing divided attention abilities. Consider additional practice sessions to strengthen multitasking skills." :
                            "<strong>Additional training recommended.</strong> Divided attention is a critical skill for dispatchers. Focus on maintaining steady typing while staying alert to visual cues."
                    }</p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showSplitAttention()" style="background: #007bff; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; margin-right: 10px;">Train Again</button>
                    <button class="btn btn-danger" onclick="closeModule()" style="background: #dc3545; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer;">Exit Training</button>
                </div>
            `;
            
            // Save comprehensive score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'splitAttention',
                    finalAverageScore: totalScore,
                    roundResults: splitAttentionState.roundResults,
                    totalCorrectClicks: totalCorrectClicks,
                    totalMissedTargets: totalMissedTargets,
                    totalFalseClicks: totalFalseClicks,
                    roundsCompleted: splitAttentionState.totalRounds,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // LISTENING SKILLS MODULE
        function showListeningSkills() {
            document.getElementById('moduleTitle').textContent = 'üéß Listening Skills Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = 0;
            
            // Calculate total questions
            listeningScenarios.forEach(scenario => {
                totalQuestions += scenario.questions.length;
            });
            
            showNextListeningScenario(0, 0);
        }
        
        function showNextListeningScenario(scenarioIndex, questionIndex) {
            if (scenarioIndex >= listeningScenarios.length) {
                showListeningResults();
                return;
            }
            
            const scenario = listeningScenarios[scenarioIndex];
            
            if (questionIndex === 0) {
                // Show audio first
                const content = document.getElementById('moduleContent');
                content.innerHTML = `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin-bottom: 20px;">
                        <h3>‚ö† Important Instructions:</h3>
                        <p><strong>You can only play the audio ONCE.</strong> Listen carefully and take notes if needed.</p>
                    </div>
                    
                    <div class="audio-container">
                        <h3>üéß Listen to the Emergency Call</h3>
                        <p style="color: #666; margin: 10px 0;">Audio Scenario ${scenarioIndex + 1} of ${listeningScenarios.length}</p>
                        <audio id="listeningAudio" class="audio-player" controls>
                            <source src="${scenario.audioFile}" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        <p class="play-count">Status: <span id="audioStatus" style="font-weight: bold; color: #007bff;">Ready to play</span></p>
                        
                        <div style="background: white; padding: 15px; border-radius: 5px; margin-top: 20px;">
                            <p><strong>Scenario Preview (for demo - remove in production):</strong></p>
                            <p style="font-style: italic; color: #666;">${scenario.scenario}</p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" id="beginQuestionsBtn" onclick="startListeningQuestions(${scenarioIndex})">Begin Questions</button>
                        <p style="color: #666; font-size: 14px; margin-top: 10px;">Make sure you've listened to the audio before clicking this button</p>
                    </div>
                `;
                
                // Track audio plays
                const audio = document.getElementById('listeningAudio');
                let hasPlayed = false;
                
                audio.addEventListener('play', function() {
                    if (!hasPlayed) {
                        hasPlayed = true;
                        document.getElementById('audioStatus').textContent = 'Playing...';
                        document.getElementById('audioStatus').style.color = '#28a745';
                    }
                });
                
                audio.addEventListener('ended', function() {
                    audio.controls = false;
                    audio.style.opacity = '0.5';
                    document.getElementById('audioStatus').textContent = 'Audio completed (cannot replay)';
                    document.getElementById('audioStatus').style.color = '#dc3545';
                    document.getElementById('beginQuestionsBtn').style.background = 'linear-gradient(135deg, #28a745 0%, #20a038 100%)';
                    document.getElementById('beginQuestionsBtn').style.animation = 'pulse 1s infinite';
                });
                
                // Also disable if they try to replay
                audio.addEventListener('pause', function() {
                    if (hasPlayed) {
                        audio.controls = false;
                        audio.style.opacity = '0.5';
                    }
                });
            } else {
                // Show question
                showListeningQuestion(scenarioIndex, questionIndex);
            }
        }
        
        function startListeningQuestions(scenarioIndex) {
            showListeningQuestion(scenarioIndex, 0);
        }
        
        function showListeningQuestion(scenarioIndex, questionIndex) {
            const scenario = listeningScenarios[scenarioIndex];
            const question = scenario.questions[questionIndex];
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #2196f3;">
                    <h3 style="color: #1976d2;">${question.q}</h3>
                </div>
                
                ${question.options.map((opt, i) => `
                    <div style="margin: 12px 0;">
                        <label style="display: block; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#007bff'; this.style.background='#f5f5f5'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                            <input type="radio" name="listeningAnswer" value="${i}" style="margin-right: 12px; width: 20px; height: 20px;">
                            <span style="font-size: 16px;">${opt}</span>
                        </label>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitListeningAnswer(${scenarioIndex}, ${questionIndex})">Submit Answer</button>
                </div>
            `;
        }
        
        function submitListeningAnswer(scenarioIndex, questionIndex) {
            const selected = document.querySelector('input[name="listeningAnswer"]:checked');
            
            if (!selected) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const scenario = listeningScenarios[scenarioIndex];
            const question = scenario.questions[questionIndex];
            const userAnswer = parseInt(selected.value);
            const correct = userAnswer === question.correct;
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.options[question.correct]}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Move to next question
            currentQuestion++;
            setTimeout(() => {
                questionIndex++;
                if (questionIndex >= scenario.questions.length) {
                    scenarioIndex++;
                    questionIndex = 0;
                }
                showNextListeningScenario(scenarioIndex, questionIndex);
            }, 1500);
        }
        
        function showListeningResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Listening Skills Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showListeningSkills()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'listeningSkills',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // VIN/LICENSE ENTRY MODULE
        function showVinLicense() {
            document.getElementById('moduleTitle').textContent = 'üöó VIN/License Entry Practice';
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <h3>Select Practice Type:</h3>
                <div class="lesson-grid" style="margin: 30px 0;">
                    <div class="lesson-card" onclick="startVinPractice()">
                        <h3>VIN Entry</h3>
                        <p>Enter 17-character Vehicle Identification Numbers accurately</p>
                    </div>
                    <div class="lesson-card" onclick="startLicensePractice()">
                        <h3>License Number Entry</h3>
                        <p>Enter Ontario license numbers accurately</p>
                    </div>
                    <div class="lesson-card" onclick="startDobExtraction()">
                        <h3>DOB Extraction</h3>
                        <p>Extract date of birth and gender from license numbers</p>
                    </div>
                </div>
            `;
        }
        
        function startVinPractice() {
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = 5;
            
            showNextVinQuestion();
        }
        
        function showNextVinQuestion() {
            if (currentQuestion >= totalQuestions) {
                showVinResults();
                return;
            }
            
            const vin = vinNumbers[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">VIN ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: 10px; border: 2px solid #007bff; text-align: center;">
                    <h3>Enter this VIN exactly as shown:</h3>
                    <div style="background: #f8f9fa; padding: 20px; margin: 20px 0; border: 3px solid #333; display: inline-block; border-radius: 5px;">
                        <p style="font-family: monospace; font-size: 32px; letter-spacing: 3px; margin: 0; font-weight: bold;">${vin}</p>
                    </div>
                    <input type="text" id="vinInput" maxlength="17" placeholder="Type the VIN here" style="width: 100%; max-width: 500px; padding: 15px; font-size: 20px; font-family: monospace; letter-spacing: 2px; border: 2px solid #007bff; border-radius: 5px; text-align: center; text-transform: uppercase;">
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitVinEntry('${vin}')">Submit VIN</button>
                </div>
            `;
            
            document.getElementById('vinInput').focus();
            
            // Auto-uppercase
            document.getElementById('vinInput').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });
        }
        
        function submitVinEntry(correctVin) {
            const userVin = document.getElementById('vinInput').value.trim();
            
            if (userVin.length !== 17) {
                alert('VIN must be exactly 17 characters.');
                return;
            }
            
            const correct = userVin === correctVin;
            if (correct) correctAnswers++;
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545') + '; text-align: center;';
            feedback.innerHTML = `
                <p style="font-size: 24px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0; font-family: monospace; font-size: 18px;">Correct VIN: ${correctVin}</p><p style="font-family: monospace; font-size: 18px;">Your entry: ${userVin}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            setTimeout(() => {
                currentQuestion++;
                showNextVinQuestion();
            }, correct ? 1000 : 2000);
        }
        
        function showVinResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>VIN Entry Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Accuracy</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showVinLicense()">Back to Menu</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'vinEntry',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        function startLicensePractice() {
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = 5;
            
            // Generate 5 random licenses
            window.currentLicenses = [];
            const lastNames = ['M', 'S', 'J', 'W', 'B', 'T', 'A', 'K', 'L', 'R'];
            for (let i = 0; i < 5; i++) {
                const isFemale = Math.random() > 0.5;
                const year = (Math.floor(Math.random() * 40) + 60).toString(); // 60-99 (1960-1999)
                const month = (Math.floor(Math.random() * 12) + 1).toString();
                const day = (Math.floor(Math.random() * 28) + 1).toString();
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                
                window.currentLicenses.push(generateLicenseNumber(lastName, year, month, day, isFemale));
            }
            
            showNextLicenseQuestion();
        }
        
        function showNextLicenseQuestion() {
            if (currentQuestion >= totalQuestions) {
                showLicenseResults();
                return;
            }
            
            const license = window.currentLicenses[currentQuestion].license;
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">License ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: 10px; border: 2px solid #007bff; text-align: center;">
                    <h3>Enter this Ontario license number exactly as shown:</h3>
                    <div style="background: #f8f9fa; padding: 20px; margin: 20px 0; border: 3px solid #333; display: inline-block; border-radius: 5px;">
                        <p style="font-family: monospace; font-size: 32px; letter-spacing: 3px; margin: 0; font-weight: bold;">${license}</p>
                    </div>
                    <input type="text" id="licenseInput" maxlength="18" placeholder="L####-#####-#####" style="width: 100%; max-width: 400px; padding: 15px; font-size: 20px; font-family: monospace; letter-spacing: 2px; border: 2px solid #007bff; border-radius: 5px; text-align: center; text-transform: uppercase;">
                    <p style="color: #666; font-size: 14px; margin-top: 10px;">Format: Letter + 4 digits - 5 digits - 5 digits</p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitLicenseEntry('${license}')">Submit License</button>
                </div>
            `;
            
            document.getElementById('licenseInput').focus();
            
            // Auto-format and uppercase
            document.getElementById('licenseInput').addEventListener('input', function(e) {
                let val = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
                if (val.length > 0) {
                    if (val.length <= 5) {
                        val = val;
                    } else if (val.length <= 10) {
                        val = val.slice(0, 5) + '-' + val.slice(5);
                    } else {
                        val = val.slice(0, 5) + '-' + val.slice(5, 10) + '-' + val.slice(10, 15);
                    }
                }
                e.target.value = val;
            });
        }
        
        function submitLicenseEntry(correctLicense) {
            const userLicense = document.getElementById('licenseInput').value.trim();
            
            const correct = userLicense === correctLicense;
            if (correct) correctAnswers++;
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545') + '; text-align: center;';
            feedback.innerHTML = `
                <p style="font-size: 24px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0; font-family: monospace; font-size: 18px;">Correct: ${correctLicense}</p><p style="font-family: monospace; font-size: 18px;">Yours: ${userLicense}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            setTimeout(() => {
                currentQuestion++;
                showNextLicenseQuestion();
            }, correct ? 1000 : 2000);
        }
        
        function showLicenseResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>License Entry Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Accuracy</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showVinLicense()">Back to Menu</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'licenseEntry',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        function startDobExtraction() {
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = 10;
            
            // Generate 10 random licenses with DOB
            window.dobExtractionLicenses = [];
            const lastNames = ['M', 'S', 'J', 'W', 'B', 'T', 'A', 'K', 'L', 'R'];
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            for (let i = 0; i < 10; i++) {
                const isFemale = Math.random() > 0.5;
                // Generate years that test both century cases: 00-25 (20XX) and 60-99 (19XX)
                const yearRanges = [...Array(26).keys(), ...Array(40).keys().map(x => x + 60)]; // 0-25, 60-99
                const year = yearRanges[Math.floor(Math.random() * yearRanges.length)].toString().padStart(2, '0');
                const month = (Math.floor(Math.random() * 12) + 1).toString();
                const day = (Math.floor(Math.random() * 28) + 1).toString();
                const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
                
                const licenseData = generateLicenseNumber(lastName, year, month, day, isFemale);
                licenseData.monthName = monthNames[parseInt(month) - 1];
                window.dobExtractionLicenses.push(licenseData);
            }
            
            showNextDobQuestion();
        }
        
        function showNextDobQuestion() {
            if (currentQuestion >= totalQuestions) {
                showDobResults();
                return;
            }
            
            const licenseData = window.dobExtractionLicenses[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin-bottom: 20px;">
                    <h3>üìö Ontario License Number DOB Encoding:</h3>
                    <p><strong>DOB is encoded in the last 6 digits as YYMMDD</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Males:</strong> Month is 01-12</li>
                        <li><strong>Females:</strong> Month is 51-62 (add 50 to actual month)</li>
                        <li><strong>Years:</strong> 00-25 = 20XX, 26-99 = 19XX</li>
                    </ul>
                    <p style="margin-top: 10px;"><strong>How to decode:</strong></p>
                    <ol style="margin: 5px 0; padding-left: 20px;">
                        <li>Take the <strong>last 6 digits</strong> from the license number</li>
                        <li>Read as YYMMDD</li>
                        <li>Apply century and gender rules</li>
                    </ol>
                    <p style="margin-top: 10px;"><strong>Examples:</strong></p>
                    <p>‚Ä¢ B7574-78504-<strong>830422</strong> ‚Üí 83/04/22 ‚Üí 1983/04/22 (Male)</p>
                    <p>‚Ä¢ M5777-61578-<strong>855106</strong> ‚Üí 85/51/06 ‚Üí 1985/01/06 (Female, 51-50=01)</p>
                    <p>‚Ä¢ A1234-56789-<strong>050212</strong> ‚Üí 05/02/12 ‚Üí 2005/02/12 (Male, 05 = 20XX)</p>
                </div>
                
                <div style="background: white; padding: 30px; border-radius: 10px; border: 2px solid #007bff; text-align: center;">
                    <h3>License Number:</h3>
                    <div style="background: #f8f9fa; padding: 20px; margin: 20px 0; border: 3px solid #333; display: inline-block; border-radius: 5px;">
                        <p style="font-family: monospace; font-size: 32px; letter-spacing: 3px; margin: 0; font-weight: bold;">${licenseData.license}</p>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;">
                        <h4>Extract the following information:</h4>
                        
                        <div style="margin: 15px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Date of Birth (Format: YYYY/MM/DD):</label>
                            <input type="text" id="dobInput" placeholder="YYYY/MM/DD" maxlength="10" style="width: 100%; padding: 10px; font-size: 18px; border: 2px solid #007bff; border-radius: 5px;">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Gender:</label>
                            <select id="genderInput" style="width: 100%; padding: 10px; font-size: 18px; border: 2px solid #007bff; border-radius: 5px;">
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitDobExtraction()">Submit Answer</button>
                </div>
            `;
            
            document.getElementById('dobInput').focus();
            
            // Auto-format date for YYYY/MM/DD
            document.getElementById('dobInput').addEventListener('input', function(e) {
                let val = e.target.value.replace(/[^0-9]/g, '');
                if (val.length >= 4) {
                    val = val.slice(0, 4) + '/' + val.slice(4);
                }
                if (val.length >= 7) {
                    val = val.slice(0, 7) + '/' + val.slice(7, 9);
                }
                e.target.value = val;
            });
        }
        
        function submitDobExtraction() {
            const licenseData = window.dobExtractionLicenses[currentQuestion];
            const userDob = document.getElementById('dobInput').value.trim();
            const userGender = document.getElementById('genderInput').value;
            
            if (!userDob || !userGender) {
                alert('Please fill in both date of birth and gender.');
                return;
            }
            
            // Parse the license number to get the actual DOB (what student should find)
            const parsedData = extractDobFromLicense(licenseData.license);
            if (!parsedData) {
                console.error('Failed to parse license:', licenseData.license);
                return;
            }
            
            const correctDob = `${parsedData.year}/${parsedData.month}/${parsedData.day}`;
            const dobCorrect = userDob === correctDob;
            const genderCorrect = userGender === parsedData.gender;
            const bothCorrect = dobCorrect && genderCorrect;
            
            if (bothCorrect) correctAnswers++;
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (bothCorrect ? '#d4edda' : '#f8d7da') + '; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid ' + (bothCorrect ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 24px; margin: 0; text-align: center;"><strong>${bothCorrect ? '‚úì Perfect!' : '‚úó Incorrect'}</strong></p>
                <div style="margin-top: 15px;">
                    <p><strong>DOB:</strong> ${dobCorrect ? '‚úì' : '‚úó'} ${dobCorrect ? 'Correct' : `Wrong - Correct: ${correctDob}`}</p>
                    <p><strong>Gender:</strong> ${genderCorrect ? '‚úì' : '‚úó'} ${genderCorrect ? 'Correct' : `Wrong - Correct: ${parsedData.gender}`}</p>
                </div>
                <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <p style="font-family: monospace;"><strong>License:</strong> ${licenseData.license}</p>
                    <p style="font-family: monospace;"><strong>Last 6 digits:</strong> ${parsedData.fullDob}</p>
                    <p><strong>Breakdown:</strong> Year=${parsedData.fullDob.substring(0,2)} (${parsedData.year}), Month=${parsedData.fullDob.substring(2,4)} ${parsedData.gender === 'Female' ? '(-50=' + parsedData.month + ')' : ''}, Day=${parsedData.fullDob.substring(4,6)}</p>
                </div>
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            setTimeout(() => {
                currentQuestion++;
                showNextDobQuestion();
            }, bothCorrect ? 1500 : 3000);
        }
        
        function showDobResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>DOB Extraction Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Accuracy</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showVinLicense()">Back to Menu</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'dobExtraction',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // CROSS REFERENCE MODULE
        function showCrossReference() {
            document.getElementById('moduleTitle').textContent = 'üîç Cross-Reference Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = crossReferenceScenarios.length;
            
            showNextCrossReferenceQuestion();
        }
        
        function showNextCrossReferenceQuestion() {
            if (currentQuestion >= crossReferenceScenarios.length) {
                showCrossReferenceResults();
                return;
            }
            
            const scenario = crossReferenceScenarios[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            // Build comparison table
            const fields = Object.keys(scenario.callerInfo);
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Scenario ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <h3 style="text-align: center; color: #007bff;">${scenario.title}</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">Compare the caller information with the database record</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div>
                        <h4 style="background: #007bff; color: white; padding: 10px; text-align: center; border-radius: 5px;">Caller Information</h4>
                        <div style="background: white; border: 2px solid #007bff; border-radius: 5px; padding: 15px;">
                            ${fields.map(field => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                                    <strong>${field.replace('_', ' ').toUpperCase()}:</strong><br>
                                    <span style="font-family: monospace;">${scenario.callerInfo[field]}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="background: #28a745; color: white; padding: 10px; text-align: center; border-radius: 5px;">Database Record</h4>
                        <div style="background: white; border: 2px solid #28a745; border-radius: 5px; padding: 15px;">
                            ${fields.map(field => `
                                <div style="padding: 8px 0; border-bottom: 1px solid #e0e0e0;">
                                    <strong>${field.replace('_', ' ').toUpperCase()}:</strong><br>
                                    <span style="font-family: monospace;">${scenario.databaseInfo[field]}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; text-align: center; margin-top: 20px;">
                    <h4>${scenario.question}</h4>
                    
                    ${scenario.discrepancy === 'none' ? `
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="submitCrossReference('match')" style="margin: 5px;">‚úì All Information Matches</button>
                            <button class="btn btn-danger" onclick="submitCrossReference('nomatch')" style="margin: 5px;">‚úó Discrepancy Found</button>
                        </div>
                    ` : `
                        <div style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                            ${fields.map(field => `
                                <button class="btn btn-primary" onclick="submitCrossReference('${field}')" style="min-width: 120px;">${field.replace('_', ' ').toUpperCase()}</button>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }
        
        function submitCrossReference(answer) {
            const scenario = crossReferenceScenarios[currentQuestion];
            let correct = false;
            
            if (scenario.discrepancy === 'none') {
                correct = answer === 'match';
            } else {
                correct = answer === scenario.discrepancy;
            }
            
            if (correct) correctAnswers++;
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545') + '; text-align: center;';
            feedback.innerHTML = `
                <p style="font-size: 24px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${scenario.discrepancy === 'none' ? 'All information matches' : scenario.discrepancy.replace('_', ' ').toUpperCase() + ' field has a discrepancy'}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            setTimeout(() => {
                currentQuestion++;
                showNextCrossReferenceQuestion();
            }, 1500);
        }
        
        function showCrossReferenceResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Cross-Reference Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Accuracy</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showCrossReference()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'crossReference',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // MULTITASKING MODULE
        function showMultitasking() {
            document.getElementById('moduleTitle').textContent = 'üéÆ Multitasking Practice';
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <h3>Instructions:</h3>
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin-bottom: 20px;">
                    <p><strong>This test simulates handling multiple emergency calls simultaneously:</strong></p>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>Calls will appear in the queue with different priority levels</li>
                        <li><span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 3px;">HIGH</span> priority = Life-threatening (handle first)</li>
                        <li><span style="background: #ffc107; color: black; padding: 2px 8px; border-radius: 3px;">MEDIUM</span> priority = Urgent but not life-threatening</li>
                        <li><span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 3px;">LOW</span> priority = Routine calls</li>
                        <li>Click on calls in order of priority (high first)</li>
                        <li>New calls may appear while you're working</li>
                        <li>You'll have 2 minutes to handle as many calls as possible</li>
                    </ol>
                    <p style="color: #856404; margin-top: 10px;"><strong>Goal: Handle calls in correct priority order</strong></p>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="startMultitasking()">Start Simulation</button>
                </div>
            `;
        }
        
        function startMultitasking() {
            // Reset state
            multitaskingState = {
                activeCall: null,
                callQueue: [],
                score: 0,
                correctPicks: 0,
                incorrectPicks: 0,
                startTime: Date.now(),
                duration: 120,
                callsHandled: 0
            };
            
            // Add initial calls
            addRandomCalls(3);
            
            renderMultitaskingUI();
            
            // Add new calls periodically
            multitaskingState.addCallsInterval = setInterval(() => {
                if (multitaskingState.callQueue.length < 6) {
                    addRandomCalls(1);
                    renderMultitaskingUI();
                }
            }, 8000);
            
            // Timer
            multitaskingState.timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - multitaskingState.startTime) / 1000);
                const remaining = multitaskingState.duration - elapsed;
                
                if (remaining <= 0) {
                    finishMultitasking();
                    return;
                }
                
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                const timeElement = document.getElementById('multitaskingTimer');
                if (timeElement) {
                    timeElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }
        
        function addRandomCalls(count) {
            const available = multitaskingCalls.filter(c => 
                !multitaskingState.callQueue.find(q => q.id === c.id)
            );
            
            for (let i = 0; i < count && available.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * available.length);
                multitaskingState.callQueue.push(available[randomIndex]);
                available.splice(randomIndex, 1);
            }
        }
        
        function renderMultitaskingUI() {
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="display: flex; gap: 20px; min-height: 500px;">
                    <!-- Call Queue -->
                    <div style="flex: 1; background: white; padding: 20px; border-radius: 10px; border: 2px solid #007bff;">
                        <h3 style="margin-bottom: 15px;">üìû Incoming Calls</h3>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Click on the highest priority call first</p>
                        
                        <div id="callQueueContainer">
                            ${multitaskingState.callQueue.map(call => {
                                const priorityColor = call.priority === 'high' ? '#dc3545' : call.priority === 'medium' ? '#ffc107' : '#28a745';
                                const priorityText = call.priority.toUpperCase();
                                return `
                                    <div class="call-item" onclick="handleCall(${call.id})" style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 5px solid ${priorityColor}; border-radius: 5px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                            <strong>Call #${call.id}</strong>
                                            <span style="background: ${priorityColor}; color: ${call.priority === 'medium' ? 'black' : 'white'}; padding: 3px 10px; border-radius: 3px; font-size: 12px; font-weight: bold;">${priorityText}</span>
                                        </div>
                                        <p style="margin: 5px 0; font-size: 14px;">${call.text}</p>
                                        <p style="margin: 5px 0; font-size: 12px; color: #666;">Service: ${call.service}</p>
                                    </div>
                                `;
                            }).join('') || '<p style="color: #999; text-align: center; padding: 40px 0;">No calls in queue</p>'}
                        </div>
                    </div>
                    
                    <!-- Stats Panel -->
                    <div style="width: 250px; background: white; padding: 20px; border-radius: 10px; border: 2px solid #28a745;">
                        <h3 style="margin-bottom: 15px;">üìä Performance</h3>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                            <div style="font-size: 14px; color: #666;">Time Remaining</div>
                            <div id="multitaskingTimer" style="font-size: 32px; font-weight: bold; color: #007bff;">2:00</div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                            <div style="font-size: 14px; color: #666;">Calls Handled</div>
                            <div style="font-size: 28px; font-weight: bold; color: #007bff;">${multitaskingState.callsHandled}</div>
                        </div>
                        
                        <div style="background: #d4edda; padding: 15px; border-radius: 5px; margin-bottom: 10px;">
                            <div style="font-size: 14px; color: #155724;">‚úì Correct Priority</div>
                            <div style="font-size: 28px; font-weight: bold; color: #28a745;">${multitaskingState.correctPicks}</div>
                        </div>
                        
                        <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                            <div style="font-size: 14px; color: #721c24;">‚úó Wrong Priority</div>
                            <div style="font-size: 28px; font-weight: bold; color: #dc3545;">${multitaskingState.incorrectPicks}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function handleCall(callId) {
            const call = multitaskingState.callQueue.find(c => c.id === callId);
            if (!call) return;
            
            // Check if this was the highest priority call
            const priorities = { high: 3, medium: 2, low: 1 };
            const callPriority = priorities[call.priority];
            const highestPriority = Math.max(...multitaskingState.callQueue.map(c => priorities[c.priority]));
            
            const correct = callPriority === highestPriority;
            
            if (correct) {
                multitaskingState.correctPicks++;
            } else {
                multitaskingState.incorrectPicks++;
            }
            
            multitaskingState.callsHandled++;
            
            // Remove call from queue
            multitaskingState.callQueue = multitaskingState.callQueue.filter(c => c.id !== callId);
            
            // Visual feedback
            const callElements = document.querySelectorAll('.call-item');
            callElements.forEach(el => {
                if (el.textContent.includes(`Call #${callId}`)) {
                    el.style.background = correct ? '#d4edda' : '#f8d7da';
                    setTimeout(() => {
                        renderMultitaskingUI();
                    }, 300);
                }
            });
        }
        
        function finishMultitasking() {
            clearInterval(multitaskingState.addCallsInterval);
            clearInterval(multitaskingState.timerInterval);
            
            const totalPicks = multitaskingState.correctPicks + multitaskingState.incorrectPicks;
            const accuracy = totalPicks > 0 ? Math.round((multitaskingState.correctPicks / totalPicks) * 100) : 0;
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div class="score-display">
                    <h3>Multitasking Results</h3>
                    <h2>${accuracy}% Accuracy</h2>
                    <p>Calls handled: ${multitaskingState.callsHandled}</p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="margin-bottom: 15px;">Performance Breakdown:</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <div style="background: #d4edda; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 48px; font-weight: bold; color: #28a745;">${multitaskingState.correctPicks}</div>
                            <div style="color: #155724;">Correct Priority Picks</div>
                        </div>
                        
                        <div style="background: #f8d7da; padding: 15px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 48px; font-weight: bold; color: #dc3545;">${multitaskingState.incorrectPicks}</div>
                            <div style="color: #721c24;">Wrong Priority Picks</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <p><strong>Key Skill:</strong> Always handle HIGH priority (life-threatening) calls before MEDIUM or LOW priority calls.</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMultitasking()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'multitasking',
                    accuracy: accuracy,
                    callsHandled: multitaskingState.callsHandled,
                    correctPicks: multitaskingState.correctPicks,
                    incorrectPicks: multitaskingState.incorrectPicks,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // DECISION MAKING MODULE
        let decisionMakingState = {
            currentStage: 0,
            stages: [],
            score: 0,
            totalStages: 5,
            stageAnswers: []
        };
        
        const decisionMakingStages = [
            {
                title: "Stage 1: High Priority Emergencies",
                description: "Three high-priority emergency calls - order them from highest to lowest priority based on immediate threat to life.",
                calls: [
                    {
                        id: 1,
                        title: "Robbery in-progress",
                        details: "Bank staff being held at gunpoint",
                        priority: "high",
                        correctRank: 1
                    },
                    {
                        id: 2,
                        title: "Bar Fight",
                        details: "15 people fist fighting in the street, unknown weapons",
                        priority: "High",
                        correctRank: 2
                    },
                    {
                        id: 3,
                        title: "Disturbance",
                        details: "Lots of yelling coming from apartment, unknown who is present",
                        priority: "High",
                        correctRank: 3
                    }
                ]
            },
            {
                title: "Stage 2: Mixed Priority Scenarios",
                description: "Mix of high and medium priority calls - prioritize based on urgency and threat level.",
                calls: [
                    {
                        id: 1,
                        title: "Person Welfare Check",
                        details: "Complainant hasn't seen their elderly neighbour for a few days, concerned something could have happened to them",
                        priority: "Medium",
                        correctRank: 2
                    },
                    {
                        id: 2,
                        title: "Suspicious Person",
                        details: "Male walking up and down the street, seems to be looking at peoples cars",
                        priority: "Medium",
                        correctRank: 3
                    },
                    {
                        id: 3,
                        title: "Suicidal Person",
                        details: "Male just told his family he would drive into a rock cliff, took off in his vehicle",
                        priority: "High",
                        correctRank: 1
                    }
                ]
            },
            {
                title: "Stage 3: Property vs. Personal Safety",
                description: "Calls involving both property damage and personal safety - remember: people over property.",
                calls: [
                    {
                        id: 1,
                        title: "Break-in Completed",
                        details: "Homeowner returned to find house burglarized, suspect gone, no one injured",
                        priority: "Low",
                        correctRank: 3
                    },
                    {
                        id: 2,
                        title: "Assault in Progress",
                        details: "Physical altercation outside bar, multiple people involved, injuries reported",
                        priority: "High",
                        correctRank: 1
                    },
                    {
                        id: 3,
                        title: "Theft from Vehicle in Progress",
                        details: "Suspect just stole items out of car in parking lot, left running northbound",
                        priority: "Medium",
                        correctRank: 2
                    }
                ]
            },
            {
                title: "Stage 4: Complex Prioritization",
                description: "Complex scenarios mixing intimate partner violence, property crimes, and disturbances.",
                calls: [
                    {
                        id: 1,
                        title: "Domestic Violence",
                        details: "Female caller whispering, says boyfriend is threatening her with knife",
                        priority: "High",
                        correctRank: 1
                    },
                    {
                        id: 2,
                        title: "Commercial Alarm",
                        details: "Silent alarm at electronics store, no response from owner, possible burglary",
                        priority: "Medium",
                        correctRank: 3
                    },
                    {
                        id: 3,
                        title: "Welfare Check",
                        details: "Elderly man hasn't been seen for 3 days, family concerned, bad smell coming from apartment, no answer at the door",
                        priority: "Medium-High",
                        correctRank: 2
                    }
                ]
            },
            {
                title: "Stage 5: Fire calls",
                description: "Variety of fire calls.",
                calls: [
                    {
                        id: 1,
                        title: "Apartment Fire",
                        details: "Apartment building up in flames, unknown if everyone is out",
                        priority: "High",
                        correctRank: 1
                    },
                    {
                        id: 2,
                        title: "Burning Complaint",
                        details: "Smoke from neighbours bonfire bothering complainant, also thinks it's too close to their fence",
                        priority: "Medium",
                        correctRank: 3
                    },
                    {
                        id: 3,
                        title: "bush fire",
                        details: "flames and smoke coming from the bush area behind complainants house",
                        priority: "Medium-High",
                        correctRank: 2
                    }
                ]
            }
        ];
        
        function showDecisionMaking() {
            document.getElementById('moduleTitle').textContent = 'üéØ Decision Making Practice';
            
            // Reset state
            decisionMakingState.currentStage = 0;
            decisionMakingState.score = 0;
            decisionMakingState.stageAnswers = [];
            decisionMakingState.stages = [...decisionMakingStages];
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <h3>Instructions:</h3>
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin-bottom: 20px;">
                    <p><strong>Emergency Call Prioritization Training</strong></p>
                    <p>You will be presented with 4 stages of emergency scenarios. For each stage:</p>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Review all 3 calls</strong> carefully</li>
                        <li><strong>Prioritize them</strong> by clicking "1st Priority", "2nd Priority", or "3rd Priority" for each call</li>
                        <li><strong>Remember the key principles:</strong>
                            <ul style="margin: 5px 0;">
                                <li>People over property</li>
                                <li>In-progress over after-the-fact</li>
                                <li>Immediate threat to life over injury</li>
                                <li>Confirmed emergencies over possible emergencies</li>
                            </ul>
                        </li>
                    </ol>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-success" onclick="startDecisionMaking()">Begin Training</button>
                </div>
            `;
        }
        
        function startDecisionMaking() {
            showDecisionMakingStage();
        }
        
        function showDecisionMakingStage() {
            const stage = decisionMakingState.stages[decisionMakingState.currentStage];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>${stage.title}</h3>
                    <p>${stage.description}</p>
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 5px; margin-top: 10px;">
                        Stage ${decisionMakingState.currentStage + 1} of ${decisionMakingState.totalStages}
                    </div>
                </div>
                
                <div id="callCards" style="display: grid; gap: 20px;">
                    ${stage.calls.map(call => `
                        <div class="call-card" data-call-id="${call.id}" style="background: white; border: 3px solid #ddd; border-radius: 10px; padding: 20px; position: relative;">
                            <h4 style="color: #333; margin-bottom: 10px;">${call.title}</h4>
                            <p style="color: #666; margin-bottom: 15px;">${call.details}</p>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                <strong>Classification:</strong> <span style="color: ${call.priority === 'High' || call.priority === 'Life-threatening' ? '#dc3545' : call.priority === 'Medium' || call.priority === 'Medium-High' ? '#ffc107' : '#28a745'}">${call.priority}</span>
                            </div>
                            <div class="priority-buttons" style="display: flex; gap: 10px; justify-content: center;">
                                <button class="priority-btn btn" onclick="setPriority(${call.id}, 1)" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">1st Priority</button>
                                <button class="priority-btn btn" onclick="setPriority(${call.id}, 2)" style="background: #ffc107; color: black; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">2nd Priority</button>
                                <button class="priority-btn btn" onclick="setPriority(${call.id}, 3)" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">3rd Priority</button>
                            </div>
                            <div class="selected-priority" style="margin-top: 10px; text-align: center; font-weight: bold; color: #007bff;"></div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button id="submitStage" class="btn btn-primary" onclick="submitStageAnswers()" style="background: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; opacity: 0.5;" disabled>Submit Rankings</button>
                </div>
            `;
            
            // Initialize tracking for this stage
            decisionMakingState.stageAnswers[decisionMakingState.currentStage] = {};
        }
        
        function setPriority(callId, priority) {
            // Clear any previous assignment of this priority
            const currentStageAnswers = decisionMakingState.stageAnswers[decisionMakingState.currentStage];
            
            // Remove this priority from other calls
            Object.keys(currentStageAnswers).forEach(id => {
                if (currentStageAnswers[id] === priority) {
                    delete currentStageAnswers[id];
                    // Update visual
                    const otherCard = document.querySelector(`[data-call-id="${id}"] .selected-priority`);
                    if (otherCard) otherCard.textContent = '';
                    // Reset button styles for that card
                    const otherButtons = document.querySelectorAll(`[data-call-id="${id}"] .priority-btn`);
                    otherButtons.forEach(btn => {
                        btn.style.opacity = '1';
                        btn.style.fontWeight = 'normal';
                    });
                }
            });
            
            // Set new priority
            currentStageAnswers[callId] = priority;
            
            // Update visual feedback
            const priorityText = priority === 1 ? '1st Priority' : priority === 2 ? '2nd Priority' : '3rd Priority';
            const selectedDiv = document.querySelector(`[data-call-id="${callId}"] .selected-priority`);
            selectedDiv.textContent = `Selected: ${priorityText}`;
            
            // Highlight selected button
            const buttons = document.querySelectorAll(`[data-call-id="${callId}"] .priority-btn`);
            buttons.forEach((btn, index) => {
                if (index + 1 === priority) {
                    btn.style.opacity = '1';
                    btn.style.fontWeight = 'bold';
                    btn.style.transform = 'scale(1.05)';
                } else {
                    btn.style.opacity = '0.6';
                    btn.style.fontWeight = 'normal';
                    btn.style.transform = 'scale(1)';
                }
            });
            
            // Check if all priorities are assigned
            const assignedPriorities = Object.keys(currentStageAnswers).length;
            const submitButton = document.getElementById('submitStage');
            if (assignedPriorities === 3) {
                submitButton.disabled = false;
                submitButton.style.opacity = '1';
            }
        }
        
        function submitStageAnswers() {
            const stage = decisionMakingState.stages[decisionMakingState.currentStage];
            const answers = decisionMakingState.stageAnswers[decisionMakingState.currentStage];
            let stageScore = 0;
            
            // Calculate score for this stage
            stage.calls.forEach(call => {
                if (answers[call.id] === call.correctRank) {
                    stageScore++;
                }
            });
            
            // Show results for this stage
            showStageResults(stage, answers, stageScore);
        }
        
        function showStageResults(stage, answers, stageScore) {
            const content = document.getElementById('moduleContent');
            const percentage = Math.round((stageScore / 3) * 100);
            
            content.innerHTML = `
                <div style="background: ${percentage >= 67 ? '#d4edda' : '#f8d7da'}; border: 2px solid ${percentage >= 67 ? '#c3e6cb' : '#f5c6cb'}; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h3>Stage ${decisionMakingState.currentStage + 1} Results</h3>
                    <h2>Score: ${stageScore}/3 (${percentage}%)</h2>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h4>Correct Rankings:</h4>
                    ${stage.calls.sort((a, b) => a.correctRank - b.correctRank).map(call => `
                        <div style="margin: 15px 0; padding: 15px; border: 2px solid ${answers[call.id] === call.correctRank ? '#28a745' : '#dc3545'}; border-radius: 5px;">
                            <div style="display: flex; justify-content: between; align-items: center;">
                                <div style="flex: 1;">
                                    <strong>${call.correctRank}. ${call.title}</strong>
                                    <p style="margin: 5px 0; color: #666;">${call.details}</p>
                                </div>
                                <div style="text-align: right;">
                                    <span style="color: ${answers[call.id] === call.correctRank ? '#28a745' : '#dc3545'}; font-weight: bold;">
                                        Your Choice: ${answers[call.id] === 1 ? '1st' : answers[call.id] === 2 ? '2nd' : '3rd'} 
                                        ${answers[call.id] === call.correctRank ? '‚úì' : '‚úó'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 20px 0;">
                    <h4>Learning Points:</h4>
                    <p><strong>Key Principles Applied:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Life over injury:</strong> Immediate threats to life (cardiac arrest, entrapment) get highest priority</li>
                        <li><strong>In-progress over after-the-fact:</strong> Active emergencies take precedence over completed crimes</li>
                        <li><strong>People over property:</strong> Personal safety always comes before property damage</li>
                        <li><strong>Confirmed vs possible:</strong> Verified emergencies rank higher than potential situations</li>
                    </ul>
                </div>
                
                <div style="text-align: center;">
                    ${decisionMakingState.currentStage < decisionMakingState.totalStages - 1 ? 
                        `<button class="btn btn-primary" onclick="nextStage()" style="background: #007bff; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer;">Next Stage</button>` :
                        `<button class="btn btn-success" onclick="finishDecisionMaking()" style="background: #28a745; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer;">View Final Results</button>`
                    }
                </div>
            `;
            
            decisionMakingState.score += stageScore;
        }
        
        function nextStage() {
            decisionMakingState.currentStage++;
            showDecisionMakingStage();
        }
        
        function finishDecisionMaking() {
            const finalPercentage = Math.round((decisionMakingState.score / (decisionMakingState.totalStages * 3)) * 100);
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px;">
                    <h3>üéØ Decision Making Training Complete!</h3>
                    <h2>Final Score: ${decisionMakingState.score}/${decisionMakingState.totalStages * 3} (${finalPercentage}%)</h2>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3>Performance Summary:</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
                        ${decisionMakingState.stages.map((stage, index) => {
                            const stageAnswers = decisionMakingState.stageAnswers[index];
                            let stageScore = 0;
                            stage.calls.forEach(call => {
                                if (stageAnswers && stageAnswers[call.id] === call.correctRank) {
                                    stageScore++;
                                }
                            });
                            const stagePercentage = Math.round((stageScore / 3) * 100);
                            return `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                    <h4>Stage ${index + 1}</h4>
                                    <div style="color: ${stagePercentage >= 67 ? '#28a745' : '#dc3545'}; font-weight: bold; font-size: 18px;">
                                        ${stageScore}/3 (${stagePercentage}%)
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; border: 2px solid #007bff;">
                    <h4>üìã Assessment Feedback:</h4>
                    <p>${
                        finalPercentage >= 85 ? 
                            "<strong>Excellent!</strong> You demonstrate strong understanding of emergency prioritization principles. You're ready for real-world dispatch scenarios." :
                        finalPercentage >= 70 ?
                            "<strong>Good work!</strong> You understand most prioritization concepts. Review the scenarios where you lost points to strengthen your decision-making." :
                        finalPercentage >= 50 ?
                            "<strong>Needs improvement.</strong> Focus on the core principles: people over property, in-progress over completed, life-threatening over injury. Practice more scenarios." :
                            "<strong>Requires additional training.</strong> Review emergency prioritization guidelines thoroughly. The key is always immediate threat to life, then safety, then property."
                    }</p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="startDecisionMaking()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'decisionMaking',
                    totalScore: decisionMakingState.score,
                    totalPossible: decisionMakingState.totalStages * 3,
                    percentage: finalPercentage,
                    stagesCompleted: decisionMakingState.totalStages,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
    </script>
</body>
</html>
