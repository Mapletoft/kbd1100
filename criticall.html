<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CritiCall Practice - KBD1100</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    
    <style>
        .criticall-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .criticall-header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 30px;
        }
        
        .module-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 180px;
            position: relative;
        }
        
        .module-card.coming-soon {
            background: linear-gradient(135deg, #999 0%, #666 100%);
            opacity: 0.7;
        }
        
        .module-card.coming-soon::after {
            content: "COMING SOON";
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .module-card:hover:not(.coming-soon) {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .module-card h3 {
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .module-card p {
            opacity: 0.95;
            font-size: 14px;
        }
        
        .module-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9998;
        }
        
        .module-overlay.active {
            display: block;
        }
        
        .module-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            z-index: 9999;
        }
        
        .module-container.active {
            display: block;
        }
        
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* Audio Player Styles */
        .audio-container {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        
        .audio-player {
            width: 100%;
            margin: 15px 0;
        }
        
        .play-count {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        /* Data Entry Form */
        .data-entry-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .form-row label {
            font-weight: bold;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        .form-row input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-row input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        /* Call Summarization Styles */
        .incident-scenario {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .decision-section {
            background: white;
            border: 2px solid #007bff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
        
        .priority-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .priority-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .priority-btn.high { background: #dc3545; color: white; }
        .priority-btn.medium { background: #ffc107; color: black; }
        .priority-btn.low { background: #28a745; color: white; }
        
        .priority-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* Score Display */
        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }
        
        .score-display h2 {
            font-size: 48px;
            margin: 20px 0;
        }
        
        /* Memory Recall Styles */
        .memory-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .memory-item {
            padding: 15px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .memory-question {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            margin: 15px 0;
        }
        
        /* Map Styles */
        .map-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .map-grid {
            display: grid;
            grid-template-columns: repeat(10, 60px);
            gap: 0;
            margin: 20px 0;
            border: 2px solid #333;
        }
        
        .map-cell {
            border: 1px solid #ddd;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            position: relative;
            background: #f5f5f5;
            text-align: center;
            padding: 2px;
        }
        
        .street-h, .street-v {
            background: #999;
            color: white;
            font-weight: bold;
        }
        
        .building {
            font-size: 8px;
            font-weight: bold;
            padding: 2px;
        }
        
        .building-hospital { background: #ff6b6b; color: white; }
        .building-police { background: #4dabf7; color: white; }
        .building-fire { background: #ff8787; color: white; }
        .building-school { background: #ffd43b; }
        .building-mall { background: #69db7c; }
        .building-library { background: #da77f2; color: white; }
        .building-park { background: #8ce99a; }
        
        .one-way::after {
            position: absolute;
            font-size: 20px;
            color: #ff0000;
            font-weight: bold;
        }
        
        .one-way-n::after { content: "‚Üë"; }
        .one-way-s::after { content: "‚Üì"; }
        .one-way-e::after { content: "‚Üí"; }
        .one-way-w::after { content: "‚Üê"; }
        
        .map-legend {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 3px;
        }
        
        .route-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #007bff;
            border-radius: 5px;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="criticall-container">
        <div class="criticall-header">
            <h1>üö® CritiCall Practice Modules</h1>
            <p>Emergency Services Dispatcher Training</p>
            <button onclick="window.location.href='index.html'" class="btn btn-primary" style="margin-top: 15px;">‚Üê Back to Main Menu</button>
        </div>
        
        <div class="module-grid">
            <div class="module-card coming-soon" onclick="openModule('dataEntry')">
                <h3>üìù Data Entry</h3>
                <p>Listen to emergency calls and accurately record caller information, location, and incident type.</p>
            </div>
            
            <div class="module-card" onclick="openModule('callSummarization')">
                <h3>üéØ Call Summarization</h3>
                <p>Analyze emergency scenarios and determine appropriate services and priority levels.</p>
            </div>
            
            <div class="module-card" onclick="openModule('memoryRecall')">
                <h3>üß† Memory Recall</h3>
                <p>Memorize and recall critical information from emergency scenarios.</p>
            </div>
            
            <div class="module-card" onclick="openModule('mapReading')">
                <h3>üó∫Ô∏è Map Reading</h3>
                <p>Navigate city streets and determine optimal routes for emergency response.</p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üîÑ Split Attention</h3>
                <p></p>
            </div>

            <div class="module-card" onclick="openModule('readingComprehension')">
                <h3>üìò Reading Comprehension</h3>
                <p>Read passages and answer questions about policies, procedures, and call details.</p>
            </div>
            
            <div class="module-card" onclick="openModule('spelling')">
                <h3>‚úèÔ∏è Spelling</h3>
                <p>Identify correctly spelled words commonly used in emergency dispatch.</p>
            </div>
            
            <div class="module-card" onclick="openModule('sentenceClarity')">
                <h3>üó£Ô∏è Sentence Clarity</h3>
                <p>Select the clearest and most grammatically correct way to communicate information.</p>
            </div>
            
            <div class="module-card" onclick="openModule('mathematics')">
                <h3>‚ûï Mathematics</h3>
                <p>Solve real-world math problems including time calculations and basic arithmetic.</p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üìª </h3>
                <p></p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üëÇ Listening Skills</h3>
                <p></p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üöó VIN/License Entry</h3>
                <p>Accurately enter vehicle identification numbers and license plates.</p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üîç Cross-Reference</h3>
                <p>Verify caller information against database records.</p>
            </div>
            
            <div class="module-card coming-soon">
                <h3>üéÆ Multitasking</h3>
                <p>Handle multiple tasks simultaneously under time pressure.</p>
            </div>
            
            <div class="module-card coming-soon" style="grid-column: span 2; background: linear-gradient(135deg, #999 0%, #666 100%);">
                <h3>üìã Full CritiCall Test</h3>
                <p>Complete simulation combining all modules to assess overall dispatcher readiness.</p>
            </div>
        </div>
    </div>
    
    <div class="module-overlay" id="moduleOverlay" onclick="closeModule()"></div>
    <div class="module-container" id="moduleContainer">
        <div class="module-header">
            <h2 id="moduleTitle"></h2>
            <button class="close-btn" onclick="closeModule()">‚úï Close</button>
        </div>
        <div id="moduleContent"></div>
    </div>

    <script>
        let auth, db;
        let currentModule = null;
        let currentQuestion = 0;
        let correctAnswers = 0;
        let totalQuestions = 0;
        let audioPlayCount = 0;
        let selectedPriority = null;
        let selectedServices = [];
        let memoryTimerInterval = null; // Global variable to track memory timer
        
        // Initialize Firebase
        auth = firebase.auth();
        db = firebase.firestore();
        
        // Data Entry Audio Files Database
        const dataEntryScenarios = [
            {
                audioFile: "scenario1.mp3", // You'll add your actual audio files
                answers: {
                    callerName: "Sarah Johnson",
                    address: "1245 Oak Street",
                    incidentType: "Medical Emergency"
                }
            },
            {
                audioFile: "scenario2.mp3",
                answers: {
                    callerName: "Michael Chen",
                    address: "789 Maple Avenue",
                    incidentType: "House Fire"
                }
            },
            {
                audioFile: "scenario3.mp3",
                answers: {
                    callerName: "Emily Rodriguez",
                    address: "456 Pine Boulevard",
                    incidentType: "Car Accident"
                }
            }
        ];
        
        // Call Summarization Scenarios
        const callScenarios = [
            {
                scenario: "A 45-year-old male is experiencing severe chest pain and difficulty breathing. He is conscious but in obvious distress. His wife reports he has a history of heart problems.",
                correctServices: ["ems"],
                correctPriority: "high"
            },
            {
                scenario: "Caller reports seeing smoke coming from a neighbor's garage. No flames visible yet, but the smell is getting stronger. No one appears to be home.",
                correctServices: ["fire"],
                correctPriority: "high"
            },
            {
                scenario: "A two-car collision at Main St and 5th Ave. Minor injuries reported. Both drivers are out of their vehicles.",
                correctServices: ["ems"],
                correctPriority: "low"
            },
            {
                scenario: "Caller reports an unresponsive infant, not breathing. Mother is hysterical. Address is clear.",
                correctServices: ["ems"],
                correctPriority: "high"
            },
            {
                scenario: "Neighbour reports a burglary in progress. Suspects are currently inside the residence. Homeowners are on vacation.",
                correctServices: ["police"],
                correctPriority: "high"
            },
            {
                scenario: "Elderly woman fell in her bathroom. She is conscious and alert but cannot get up. No visible injuries but complaining of hip pain.",
                correctServices: ["ems"],
                correctPriority: "medium"
            },
            {
                scenario: "Structure fire fully involved, multiple floors. Building is a commercial warehouse. All occupants have evacuated safely.",
                correctServices: ["fire"],
                correctPriority: "high"
            },
            {
                scenario: "Carbon monoxide alarm sounding in a residence. Family members are feeling dizzy and nauseous. They are outside now.",
                correctServices: ["fire", "ems"],
                correctPriority: "high"
            },
            {
                scenario: "Suspicious person loitering near a school playground. School is currently in session. Individual is not responding to staff requests to leave.",
                correctServices: ["police"],
                correctPriority: "medium"
            },
            {
                scenario: "Tree branch fell on power lines during storm. Sparking visible. Lines are across the roadway blocking both lanes.",
                correctServices: ["fire", "utilities"],
                correctPriority: "high"
            },
            {
                scenario: "Caller reports her medication was stolen from her vehicle overnight. Vehicle was parked in her driveway.",
                correctServices: ["police"],
                correctPriority: "low"
            },
            {
                scenario: "Domestic disturbance. Neighbours report shouting and sounds of items breaking. Children's voices heard crying.",
                correctServices: ["police"],
                correctPriority: "high"
            },
            {
                scenario: "Gas leak reported at a restaurant. Strong odor throughout the building. Building has been evacuated. No illness",
                correctServices: ["fire", "utilities"],
                correctPriority: "high"
            },
            {
                scenario: "Vehicle vs pedestrian accident. Pedestrian is conscious, sitting on curb. Visible leg injury. Driver remained on scene.",
                correctServices: ["police", "ems"],
                correctPriority: "high"
            },
            {
                scenario: "Caller locked keys in car with infant inside. Weather is hot, approximately 85¬∞F. Infant appears alert through window.",
                correctServices: ["fire"],
                correctPriority: "high"
            }
        ];
        
        // Memory Recall Questions by Difficulty
        const memoryQuestions = {
            easy: [
                {
                    items: ["Badge 423", "Unit 7", "Oak Street", "10-4", "Engine 2"],
                    questions: [
                        { q: "What badge number was shown?", a: "423" },
                        { q: "What unit number was mentioned?", a: "7" },
                        { q: "What street name appeared?", a: "Oak Street" }
                    ]
                },
                {
                    items: ["Code 3", "Maple Ave", "Badge 156", "Squad 9", "10-23"],
                    questions: [
                        { q: "What code was displayed?", a: "Code 3" },
                        { q: "What avenue was shown?", a: "Maple Ave" },
                        { q: "What was the badge number?", a: "156" }
                    ]
                }
            ],
            medium: [
                {
                    items: ["Suspect: Male, 6'2\"", "Weapon: Handgun", "Vehicle: Blue Sedan", "Plate: ABC 1234", "Direction: Northbound", "Last Seen: 5th & Main"],
                    questions: [
                        { q: "What was the suspect's height?", a: "6'2\"" },
                        { q: "What type of weapon was mentioned?", a: "Handgun" },
                        { q: "What color was the vehicle?", a: "Blue" },
                        { q: "What was the license plate number?", a: "ABC 1234" },
                        { q: "Which direction was the suspect heading?", a: "Northbound" }
                    ]
                },
                {
                    items: ["DOB: 03/15/1985", "Lic#: D532-8877-2341", "Height: 5'9\"", "Eyes: Brown", "Hair: Black", "Weight: 180 lbs"],
                    questions: [
                        { q: "What was the date of birth?", a: "03/15/1985" },
                        { q: "What was the license number?", a: "D532-8877-2341" },
                        { q: "What was the eye color?", a: "Brown" },
                        { q: "What was the person's height?", a: "5'9\"" },
                        { q: "What was the weight listed?", a: "180 lbs" }
                    ]
                }
            ],
            hard: [
                {
                    items: ["Call#: 2024-7893", "Time: 14:37", "Caller: Martinez, J.", "Location: 4521 Elmwood Dr, Apt 3B", "DOB: 11/22/1978", "Lic#: M582-3344-9871", "Responding: Units 7, 12, Engine 4", "Code: 10-52 with 10-18"],
                    questions: [
                        { q: "What was the call number?", a: "2024-7893" },
                        { q: "What time was the call received?", a: "14:37" },
                        { q: "What was the complete address including apartment?", a: "4521 Elmwood Dr, Apt 3B" },
                        { q: "What was the caller's date of birth?", a: "11/22/1978" },
                        { q: "List all responding units (separated by commas)", a: "7, 12, Engine 4" },
                        { q: "What codes were mentioned?", a: "10-52 with 10-18" }
                    ]
                },
                {
                    items: ["Incident#: 2024-15673", "Complainant: Rodriguez-Smith, M.", "Address: 8934 Pinecrest Blvd #215", "Vehicle: 2019 Toyota Camry, Gray", "VIN: 4T1BF1FK3KU123456", "Suspect: White Male, 5'11\", 175lbs", "Clothing: Blue hoodie, jeans", "Time: 09:15 - 09:42"],
                    questions: [
                        { q: "What was the incident number?", a: "2024-15673" },
                        { q: "What was the complainant's full name?", a: "Rodriguez-Smith, M." },
                        { q: "What was the complete address?", a: "8934 Pinecrest Blvd #215" },
                        { q: "What was the vehicle VIN?", a: "4T1BF1FK3KU123456" },
                        { q: "Describe the suspect's clothing", a: "Blue hoodie, jeans" },
                        { q: "What was the time frame of the incident?", a: "09:15 - 09:42" }
                    ]
                }
            ]
        };
        
        // Map Reading Scenarios
        const mapScenarios = [
            {
                question: "Route from Hospital to the Fire at Main St & 4th Ave",
                start: "Hospital",
                end: "Fire",
                correctRoute: ["Main St south", "4th Ave east"],
                avoidStreets: ["Oak St (one-way north)"]
            },
            {
                question: "Route from Police Station to accident at Oak St & 2nd Ave",
                start: "Police",
                end: "Accident",
                correctRoute: ["1st Ave north", "Oak St east"],
                avoidStreets: []
            },
            {
                question: "Route from Fire Station to School emergency",
                start: "Fire Station",
                end: "School",
                correctRoute: ["3rd Ave south", "Pine St west", "2nd Ave south"],
                avoidStreets: ["Elm St (one-way east)"]
            }
        ];

        // Reading Comprehension Passages
        const readingPassages = [
            {
                title: "Emergency Response Protocol",
                passage: "When a dispatcher receives a call regarding an unresponsive person, the first priority is to establish the exact location and ensure emergency medical services are dispatched immediately. The dispatcher must remain on the line with the caller and provide pre-arrival instructions if the caller is willing and able to assist. If the caller becomes unresponsive or disconnects, the dispatcher should attempt to call back using the registered phone number. If no callback is possible, units should still be dispatched to the last known location. Under no circumstances should the dispatcher delay sending help while attempting to gather additional information.",
                questions: [
                    {
                        q: "According to the text, what is the FIRST priority when receiving a call about an unresponsive person?",
                        options: [
                            "Provide pre-arrival instructions",
                            "Establish the exact location",
                            "Attempt to call the caller back",
                            "Gather additional medical information"
                        ],
                        correct: 1
                    },
                    {
                        q: "What should the dispatcher do if the caller becomes unresponsive?",
                        options: [
                            "End the call and move to the next one",
                            "Delay dispatch until contact is re-established",
                            "Attempt to call back using the registered phone number",
                            "Send only police to investigate"
                        ],
                        correct: 2
                    },
                    {
                        q: "According to the passage, when should help be delayed?",
                        options: [
                            "When gathering additional information",
                            "When the caller disconnects",
                            "When the location is uncertain",
                            "Under no circumstances"
                        ],
                        correct: 3
                    }
                ]
            },
            {
                title: "Vehicle Pursuit Policy",
                passage: "Officers may initiate a vehicle pursuit only when the suspect poses an immediate threat to public safety and the benefits of apprehension outweigh the risks of pursuit. Pursuits must never be initiated for traffic violations alone, regardless of severity. The pursuing officer must continuously broadcast updates including location, direction of travel, speed, and traffic conditions. A supervisor must approve continuation of any pursuit beyond two minutes. All pursuits must be terminated immediately if weather conditions deteriorate, traffic density increases significantly, or the suspect's identity is known and apprehension can be made at a later time.",
                questions: [
                    {
                        q: "When may officers initiate a vehicle pursuit?",
                        options: [
                            "For any traffic violation",
                            "Only for severe traffic violations",
                            "When the suspect poses an immediate threat to public safety",
                            "Whenever they have supervisor approval"
                        ],
                        correct: 2
                    },
                    {
                        q: "What must happen after two minutes of pursuit?",
                        options: [
                            "The pursuit must be terminated",
                            "A supervisor must approve continuation",
                            "Speed must be reduced",
                            "Additional units must join"
                        ],
                        correct: 1
                    },
                    {
                        q: "Which situation would require immediate termination of a pursuit?",
                        options: [
                            "The suspect speeds up",
                            "The suspect's identity becomes known",
                            "Additional units arrive",
                            "The pursuit reaches residential areas"
                        ],
                        correct: 1
                    }
                ]
            },
            {
                title: "Hazardous Materials Response",
                passage: "Upon receiving a report of a hazardous materials incident, the dispatcher must immediately establish a safe perimeter and ensure no personnel enter the area without proper protective equipment. The fire department hazmat team must be notified regardless of the substance involved. If the caller can safely provide information about the material, the dispatcher should request container labels, placards, or shipping documents. However, the caller must never be instructed to approach or handle hazardous materials. Wind direction and weather conditions must be documented as they are critical for evacuation decisions. Adjacent buildings and facilities must be notified if there is any risk of exposure.",
                questions: [
                    {
                        q: "What must be done immediately upon receiving a hazmat report?",
                        options: [
                            "Send the fire department only",
                            "Request container labels from the caller",
                            "Establish a safe perimeter",
                            "Document weather conditions"
                        ],
                        correct: 2
                    },
                    {
                        q: "Should the caller be instructed to approach hazardous materials to get information?",
                        options: [
                            "Yes, if they can do so safely",
                            "Yes, but only to read labels",
                            "No, never",
                            "Only if trained"
                        ],
                        correct: 2
                    },
                    {
                        q: "Why must wind direction be documented?",
                        options: [
                            "For fire department records",
                            "It is critical for evacuation decisions",
                            "To predict weather changes",
                            "For insurance purposes"
                        ],
                        correct: 1
                    }
                ]
            }
        ];
        
        // Spelling Questions
        const spellingQuestions = [
            { word: "separate", options: ["seperate", "separate", "separete", "separat"], correct: 1 },
            { word: "receive", options: ["recieve", "receive", "receve", "receeve"], correct: 1 },
            { word: "license", options: ["licence", "lisense", "license", "lisence"], correct: 2 },
            { word: "accident", options: ["accident", "accedent", "axident", "acident"], correct: 0 },
            { word: "vehicle", options: ["vehical", "veicle", "vehicle", "vehicel"], correct: 2 },
            { word: "immediately", options: ["imediately", "immediatly", "immediately", "imediatlly"], correct: 2 },
            { word: "necessary", options: ["necesary", "neccesary", "necessary", "neccessary"], correct: 2 },
            { word: "occurrence", options: ["occurence", "occurance", "occurrence", "occurrance"], correct: 2 },
            { word: "personnel", options: ["personel", "personnel", "personell", "personnell"], correct: 1 },
            { word: "conscious", options: ["concious", "consious", "conscious", "conscous"], correct: 2 },
            { word: "defendant", options: ["defendent", "defendant", "defendint", "defandant"], correct: 1 },
            { word: "dispatch", options: ["dispach", "dispatche", "dispatch", "dispetch"], correct: 2 },
            { word: "emergency", options: ["emergancy", "emergency", "emergencey", "emergensy"], correct: 1 },
            { word: "principal", options: ["principle", "principal", "prinsipal", "prinsiple"], correct: 1 },
            { word: "paraphernalia", options: ["parepharnalia", "paraphernalia", "parapharnalia", "parephernalia"], correct: 1 },
            { word: "definitely", options: ["definately", "definitly", "definitely", "definetly"], correct: 2 },
            { word: "accommodate", options: ["acommodate", "accomodate", "accommodate", "acomodate"], correct: 2 },
            { word: "existence", options: ["existance", "existence", "existense", "existents"], correct: 1 },
            { word: "maintenance", options: ["maintainance", "maintenence", "maintenance", "maintanence"], correct: 2 },
            { word: "pursuing", options: ["persuing", "pursuing", "pursueing", "persewing"], correct: 1 }
        ];
        
        // Sentence Clarity Questions
        const sentenceClarityQuestions = [
            {
                question: "Which sentence is the clearest?",
                options: [
                    "The car, which was red in color, was observed to be traveling at a high rate of speed down the road.",
                    "The red car was speeding down the road.",
                    "Down the road, there was a car that was red in color and it was speeding.",
                    "A car that was speeding, red in color, was going down the road."
                ],
                correct: 1
            },
            {
                question: "Which sentence communicates the information most effectively?",
                options: [
                    "The suspect, who was wearing a blue jacket, ran from the officers.",
                    "From the officers, the suspect wearing a blue jacket ran.",
                    "The suspect in the blue jacket fled from officers.",
                    "Running from the officers was the suspect in a jacket that was blue."
                ],
                correct: 2
            },
            {
                question: "Select the clearest version:",
                options: [
                    "The dispatcher was informed by the caller that there was a fire.",
                    "A fire was what the caller informed the dispatcher about.",
                    "The caller informed the dispatcher of a fire.",
                    "It was a fire that the dispatcher was informed of by the caller."
                ],
                correct: 2
            },
            {
                question: "Which sentence is most appropriate for a dispatch report?",
                options: [
                    "There were three units that responded to the scene where the accident occurred.",
                    "Three units responded to the accident scene.",
                    "To the scene of the accident, three units responded.",
                    "The accident scene was where three units responded to."
                ],
                correct: 1
            },
            {
                question: "Choose the clearest sentence:",
                options: [
                    "Medical assistance was being requested by a male caller for his wife.",
                    "A male caller's wife needed medical assistance which he requested.",
                    "A male caller requested medical assistance for his wife.",
                    "For his wife, a male caller was requesting that medical assistance be provided."
                ],
                correct: 2
            },
            {
                question: "Which version is best for radio communication?",
                options: [
                    "The vehicle that was stolen was located at the mall parking lot.",
                    "Located at the mall parking lot was the vehicle that had been stolen.",
                    "The stolen vehicle was located in the mall parking lot.",
                    "At the mall parking lot, the vehicle, which was stolen, was located."
                ],
                correct: 2
            },
            {
                question: "Select the most concise and clear option:",
                options: [
                    "The officer, who arrived at the scene first, secured the perimeter.",
                    "Securing the perimeter was done by the officer who arrived first.",
                    "The first officer on scene secured the perimeter.",
                    "The perimeter was secured by the officer who was first to arrive at the scene."
                ],
                correct: 2
            },
            {
                question: "Which sentence follows proper active voice?",
                options: [
                    "The suspect was apprehended by two officers.",
                    "By two officers, the suspect was apprehended.",
                    "Two officers apprehended the suspect.",
                    "The apprehension of the suspect was made by two officers."
                ],
                correct: 2
            },
            {
                question: "Choose the clearest way to report this information:",
                options: [
                    "In the direction of northbound on Highway 5, the suspect vehicle was last observed traveling.",
                    "The suspect vehicle was last seen traveling northbound on Highway 5.",
                    "Traveling northbound on Highway 5 is where the suspect vehicle was last seen.",
                    "Last seen was the suspect vehicle, traveling in a northbound direction on Highway 5."
                ],
                correct: 1
            },
            {
                question: "Which option is most appropriate for written documentation?",
                options: [
                    "At 15:30 hours, Officers Martinez and Chen were the ones who arrived at the location.",
                    "The arrival at the location by Officers Martinez and Chen occurred at 15:30 hours.",
                    "Officers Martinez and Chen arrived at the location at 15:30 hours.",
                    "It was at 15:30 hours that Officers Martinez and Chen arrived at the location."
                ],
                correct: 2
            }
        ];
        
        // Mathematics Questions
        const mathQuestions = [
            {
                question: "An officer began a traffic stop at 14:25 and completed it at 14:47. How long did the stop take?",
                options: ["22 minutes", "32 minutes", "18 minutes", "25 minutes"],
                correct: 0
            },
            {
                question: "If three patrol units respond every 4 minutes, how many units will have responded after 12 minutes?",
                options: ["6 units", "9 units", "12 units", "15 units"],
                correct: 1
            },
            {
                question: "A dispatcher handles 8 calls per hour. How many calls would they handle in a 12-hour shift?",
                options: ["84 calls", "96 calls", "102 calls", "108 calls"],
                correct: 1
            },
            {
                question: "Convert 45 miles to kilometers (1 mile = 1.6 km):",
                options: ["72 km", "68 km", "70 km", "75 km"],
                correct: 0
            },
            {
                question: "An officer drives 60 miles per hour. How far will they travel in 15 minutes?",
                options: ["10 miles", "12 miles", "15 miles", "20 miles"],
                correct: 2
            },
            {
                question: "If 60% of calls are medical emergencies and you receive 150 calls, how many are medical?",
                options: ["80", "85", "90", "95"],
                correct: 2
            },
            {
                question: "What is 24 √ó 15?",
                options: ["340", "350", "360", "370"],
                correct: 2
            },
            {
                question: "A suspect is 3.5 miles away traveling at 50 mph. An officer is 2 miles away traveling at 60 mph. Who arrives first?",
                options: ["Suspect", "Officer", "They arrive together", "Cannot determine"],
                correct: 1
            },
            {
                question: "Convert 135 minutes to hours and minutes:",
                options: ["2 hours 15 minutes", "2 hours 25 minutes", "2 hours 35 minutes", "1 hour 75 minutes"],
                correct: 0
            },
            {
                question: "If a fire truck uses 12 gallons of fuel per hour, how much fuel is used in 45 minutes?",
                options: ["8 gallons", "9 gallons", "10 gallons", "11 gallons"],
                correct: 1
            },
            {
                question: "What is 456 + 789?",
                options: ["1,235", "1,245", "1,255", "1,265"],
                correct: 1
            },
            {
                question: "A dispatcher works from 06:00 to 18:00. How many hours is this shift?",
                options: ["10 hours", "11 hours", "12 hours", "13 hours"],
                correct: 2
            },
            {
                question: "If response time averages 6.5 minutes and you have 8 calls, what is total response time?",
                options: ["48 minutes", "50 minutes", "52 minutes", "54 minutes"],
                correct: 2
            },
            {
                question: "What is 20% of 250?",
                options: ["40", "45", "50", "55"],
                correct: 2
            },
            {
                question: "An incident began at 09:35 and ended at 11:10. What was the duration?",
                options: ["1 hour 25 minutes", "1 hour 35 minutes", "1 hour 45 minutes", "1 hour 55 minutes"],
                correct: 1
            },
            {
                question: "Divide 1,440 by 12:",
                options: ["110", "115", "120", "125"],
                correct: 2
            },
            {
                question: "If you need 3 officers per scene and have 7 scenes, how many officers are needed?",
                options: ["18", "19", "20", "21"],
                correct: 3
            },
            {
                question: "Convert 2.5 hours to minutes:",
                options: ["130 minutes", "140 minutes", "150 minutes", "160 minutes"],
                correct: 2
            },
            {
                question: "What is the average of 12, 18, 24, and 30?",
                options: ["19", "21", "23", "25"],
                correct: 1
            },
            {
                question: "If a call center receives 480 calls in 8 hours, what is the average per hour?",
                options: ["55", "60", "65", "70"],
                correct: 1
            }
        ];
        
        function openModule(moduleName) {
            if (event.target.classList.contains('coming-soon')) {
                alert('This module is coming soon! Check back later.');
                return;
            }
            
            currentModule = moduleName;
            document.getElementById('moduleOverlay').classList.add('active');
            document.getElementById('moduleContainer').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            switch(moduleName) {
                case 'dataEntry':
                    showDataEntry();
                    break;
                case 'callSummarization':
                    showCallSummarization();
                    break;
                case 'memoryRecall':
                    showMemoryRecall();
                    break;
                case 'mapReading':
                    showMapReading();
                    break;
                case 'readingComprehension':
                    showReadingComprehension();
                    break;
                case 'spelling':
                    showSpelling();
                    break;
                case 'sentenceClarity':
                    showSentenceClarity();
                    break;
                case 'mathematics':
                    showMathematics();
                    break;
            }
        }
        
        function closeModule() {
            document.getElementById('moduleOverlay').classList.remove('active');
            document.getElementById('moduleContainer').classList.remove('active');
            document.body.style.overflow = 'auto';
            currentModule = null;
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = 0;
            audioPlayCount = 0;
            
            // Clear memory timer if it exists
            if (memoryTimerInterval) {
                clearInterval(memoryTimerInterval);
                memoryTimerInterval = null;
            }
        }
        
        // DATA ENTRY MODULE
        function showDataEntry() {
            document.getElementById('moduleTitle').textContent = 'üìù Data Entry Practice';
            
            // Reset audio play count for new scenario
            audioPlayCount = 0;
            
            // For demo purposes, we'll use a random scenario
            // In production, you'd cycle through them or let teacher select
            const scenario = dataEntryScenarios[Math.floor(Math.random() * dataEntryScenarios.length)];
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div class="audio-container">
                    <h3>üéß Listen Carefully to the Emergency Call</h3>
                    <p><strong>‚ö† You can only play this audio ONCE - listen carefully and type as you hear the information!</strong></p>
                    <audio id="emergencyAudio" class="audio-player" controls>
                        <source src="${scenario.audioFile}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    <p class="play-count">Audio status: <span id="playCount" style="font-weight: bold; color: #007bff;">Ready to play</span></p>
                </div>
                
                <div class="data-entry-form">
                    <h3>Enter the information from the call:</h3>
                    <div class="form-row">
                        <label>Caller Name:</label>
                        <input type="text" id="callerName" placeholder="First and Last Name">
                    </div>
                    <div class="form-row">
                        <label>Address/Location:</label>
                        <input type="text" id="address" placeholder="Street address or location">
                    </div>
                    <div class="form-row">
                        <label>Incident Type:</label>
                        <input type="text" id="incidentType" placeholder="Type of emergency">
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitDataEntry()">Submit Entry</button>
                </div>
            `;
            
            // Track audio plays and disable after first play
            const audio = document.getElementById('emergencyAudio');
            let hasPlayed = false;
            
            audio.addEventListener('play', function() {
                if (!hasPlayed) {
                    audioPlayCount++;
                    hasPlayed = true;
                    document.getElementById('playCount').textContent = 'Played once (disabled)';
                    document.getElementById('playCount').style.color = '#dc3545';
                }
            });
            
            audio.addEventListener('ended', function() {
                // Disable audio controls after it finishes playing
                audio.controls = false;
                audio.style.opacity = '0.5';
                document.getElementById('playCount').textContent = 'Audio completed (cannot replay)';
            });
            
            // Also disable if they try to replay before it ends
            audio.addEventListener('pause', function() {
                if (hasPlayed) {
                    audio.controls = false;
                    audio.style.opacity = '0.5';
                }
            });
            
            // Store correct answers for checking
            window.currentDataEntryAnswers = scenario.answers;
        }
        
        function submitDataEntry() {
            const userAnswers = {
                callerName: document.getElementById('callerName').value.trim(),
                address: document.getElementById('address').value.trim(),
                incidentType: document.getElementById('incidentType').value.trim()
            };
            
            const correctAnswers = window.currentDataEntryAnswers;
            let score = 0;
            let feedback = [];
            
            // Check Caller Name (case-insensitive, flexible matching)
            if (userAnswers.callerName.toLowerCase() === correctAnswers.callerName.toLowerCase()) {
                score += 33.33;
                feedback.push('‚úì Caller Name: Correct');
            } else {
                feedback.push('‚úó Caller Name: Incorrect (Correct: ' + correctAnswers.callerName + ')');
            }
            
            // Check Address (case-insensitive, flexible matching)
            if (userAnswers.address.toLowerCase() === correctAnswers.address.toLowerCase()) {
                score += 33.33;
                feedback.push('‚úì Address: Correct');
            } else {
                feedback.push('‚úó Address: Incorrect (Correct: ' + correctAnswers.address + ')');
            }
            
            // Check Incident Type (case-insensitive, flexible matching)
            if (userAnswers.incidentType.toLowerCase() === correctAnswers.incidentType.toLowerCase()) {
                score += 33.34;
                feedback.push('‚úì Incident Type: Correct');
            } else {
                feedback.push('‚úó Incident Type: Incorrect (Correct: ' + correctAnswers.incidentType + ')');
            }
            
            // Display results
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div class="score-display">
                    <h3>Data Entry Results</h3>
                    <h2>${Math.round(score)}%</h2>
                    <p>Audio played ${audioPlayCount} time(s)</p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>Detailed Feedback:</h3>
                    ${feedback.map(f => `<p style="margin: 10px 0; font-size: 16px;">${f}</p>`).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showDataEntry()">Try Another Scenario</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'dataEntry',
                    score: Math.round(score),
                    audioPlays: audioPlayCount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // CALL SUMMARIZATION MODULE
        function showCallSummarization() {
            document.getElementById('moduleTitle').textContent = 'üéØ Call Summarization Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = callScenarios.length;
            
            showNextCallScenario();
        }
        
        function showNextCallScenario() {
            if (currentQuestion >= callScenarios.length) {
                showCallSummarizationResults();
                return;
            }
            
            const scenario = callScenarios[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div class="incident-scenario">
                    <h3>üìû Emergency Call</h3>
                    <p style="font-size: 16px; line-height: 1.6;">${scenario.scenario}</p>
                </div>
                
                <div class="decision-section">
                    <h3>Select Appropriate Services:</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-police" value="police">
                            <label for="service-police">üöî Police</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-fire" value="fire">
                            <label for="service-fire">üöí Fire Department</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-ems" value="ems">
                            <label for="service-ems">üöë EMS/Medical</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="service-utilities" value="utilities">
                            <label for="service-utilities">‚ö° Utilities</label>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 20px;">Select Priority Level:</h3>
                    <div class="priority-buttons">
                        <button class="priority-btn high" onclick="selectPriority('high')">HIGH<br><small>Life-threatening / Immediate danger</small></button>
                        <button class="priority-btn medium" onclick="selectPriority('medium')">MEDIUM<br><small>Urgent but not life-threatening</small></button>
                        <button class="priority-btn low" onclick="selectPriority('low')">LOW<br><small>Non-urgent / Routine</small></button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitCallDecision()">Submit Decision</button>
                </div>
            `;
        }
        
        function selectPriority(priority) {
            // Remove selection from all buttons
            document.querySelectorAll('.priority-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selection to clicked button
            event.target.classList.add('selected');
            selectedPriority = priority;
        }
        
        function submitCallDecision() {
            const scenario = callScenarios[currentQuestion];
            
            // Get selected services
            selectedServices = [];
            if (document.getElementById('service-police').checked) selectedServices.push('police');
            if (document.getElementById('service-fire').checked) selectedServices.push('fire');
            if (document.getElementById('service-ems').checked) selectedServices.push('ems');
            if (document.getElementById('service-utilities').checked) selectedServices.push('utilities');
            
            // Check if user made selections
            if (selectedServices.length === 0 || !selectedPriority) {
                alert('Please select at least one service and a priority level.');
                return;
            }
            
            // Check if answer is correct
            const servicesCorrect = arraysEqual(selectedServices.sort(), scenario.correctServices.sort());
            const priorityCorrect = selectedPriority === scenario.correctPriority;
            
            if (servicesCorrect && priorityCorrect) {
                correctAnswers++;
            }
            
            // Show feedback
            let feedback = '<div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px;">';
            feedback += '<h3>Feedback:</h3>';
            feedback += `<p><strong>Services:</strong> ${servicesCorrect ? '‚úì Correct' : '‚úó Incorrect'}</p>`;
            if (!servicesCorrect) {
                feedback += `<p style="margin-left: 20px;">Correct services: ${scenario.correctServices.join(', ')}</p>`;
            }
            feedback += `<p><strong>Priority:</strong> ${priorityCorrect ? '‚úì Correct' : '‚úó Incorrect'}</p>`;
            if (!priorityCorrect) {
                feedback += `<p style="margin-left: 20px;">Correct priority: ${scenario.correctPriority}</p>`;
            }
            feedback += '</div>';
            
            document.getElementById('moduleContent').innerHTML += feedback;
            
            // Add continue button
            setTimeout(() => {
                const continueBtn = document.createElement('div');
                continueBtn.style.textAlign = 'center';
                continueBtn.style.marginTop = '20px';
                continueBtn.innerHTML = '<button class="btn btn-primary" onclick="nextCallQuestion()">Continue to Next Call</button>';
                document.getElementById('moduleContent').appendChild(continueBtn);
            }, 500);
        }
        
        function nextCallQuestion() {
            currentQuestion++;
            selectedPriority = null;
            selectedServices = [];
            showNextCallScenario();
        }
        
        function showCallSummarizationResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Call Summarization Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showCallSummarization()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'callSummarization',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // MEMORY RECALL MODULE
        function showMemoryRecall() {
            document.getElementById('moduleTitle').textContent = 'üß† Memory Recall Practice';
            
            // Clear any existing timer when going back to difficulty selection
            if (memoryTimerInterval) {
                clearInterval(memoryTimerInterval);
                memoryTimerInterval = null;
            }
            
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <h3>Select Difficulty Level:</h3>
                <div style="display: flex; gap: 15px; justify-content: center; margin: 30px 0;">
                    <button class="btn btn-success" onclick="startMemoryTest('easy')" style="min-width: 150px;">Easy<br><small>3 questions</small></button>
                    <button class="btn btn-primary" onclick="startMemoryTest('medium')" style="min-width: 150px;">Medium<br><small>5 questions</small></button>
                    <button class="btn btn-danger" onclick="startMemoryTest('hard')" style="min-width: 150px;">Hard<br><small>6 questions</small></button>
                </div>
            `;
        }
        
        function startMemoryTest(difficulty) {
            // Clear any existing timer first
            if (memoryTimerInterval) {
                clearInterval(memoryTimerInterval);
                memoryTimerInterval = null;
            }
            
            const testData = memoryQuestions[difficulty][Math.floor(Math.random() * memoryQuestions[difficulty].length)];
            
            // Show memory items
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <h3>Memorize the following information (30 seconds):</h3>
                <div class="memory-items">
                    ${testData.items.map(item => `<div class="memory-item">${item}</div>`).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <p style="font-size: 24px; font-weight: bold; color: #007bff;">Time remaining: <span id="timer">30</span>s</p>
                </div>
            `;
            
            // Countdown timer
            let timeLeft = 30;
            memoryTimerInterval = setInterval(() => {
                timeLeft--;
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = timeLeft;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(memoryTimerInterval);
                    memoryTimerInterval = null;
                    showMemoryQuestions(testData.questions);
                }
            }, 1000);
        }
        
        function showMemoryQuestions(questions) {
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = questions.length;
            window.currentMemoryQuestions = questions;
            
            showNextMemoryQuestion();
        }
        
        function showNextMemoryQuestion() {
            const questions = window.currentMemoryQuestions;
            
            if (currentQuestion >= questions.length) {
                showMemoryResults();
                return;
            }
            
            const question = questions[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div class="memory-question">
                    <h3>${question.q}</h3>
                    <input type="text" id="memoryAnswer" placeholder="Your answer" style="width: 100%; padding: 15px; font-size: 18px; border: 2px solid #007bff; border-radius: 5px; margin-top: 15px;">
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitMemoryAnswer()">Submit Answer</button>
                </div>
            `;
            
            // Focus on input
            document.getElementById('memoryAnswer').focus();
            
            // Allow Enter key to submit
            document.getElementById('memoryAnswer').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitMemoryAnswer();
                }
            });
        }
        
        function submitMemoryAnswer() {
            const questions = window.currentMemoryQuestions;
            const question = questions[currentQuestion];
            const userAnswer = document.getElementById('memoryAnswer').value.trim();
            
            // Flexible matching (case-insensitive, whitespace tolerant)
            const correct = userAnswer.toLowerCase().replace(/\s+/g, ' ') === question.a.toLowerCase().replace(/\s+/g, ' ');
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.a}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Add continue button
            setTimeout(() => {
                const continueBtn = document.createElement('div');
                continueBtn.style.textAlign = 'center';
                continueBtn.style.marginTop = '20px';
                continueBtn.innerHTML = '<button class="btn btn-primary" onclick="nextMemoryQuestion()">Next Question</button>';
                document.getElementById('moduleContent').appendChild(continueBtn);
            }, 500);
        }
        
        function nextMemoryQuestion() {
            currentQuestion++;
            showNextMemoryQuestion();
        }
        
        function showMemoryResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Memory Recall Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMemoryRecall()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'memoryRecall',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // MAP READING MODULE
        function showMapReading() {
            document.getElementById('moduleTitle').textContent = 'üó∫Ô∏è Map Reading & Navigation';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = mapScenarios.length;
            
            showNextMapQuestion();
        }
        
        function showNextMapQuestion() {
            if (currentQuestion >= mapScenarios.length) {
                showMapResults();
                return;
            }
            
            const scenario = mapScenarios[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Scenario ${currentQuestion + 1} of ${totalQuestions}</p>
                </div>
                
                <h3>${scenario.question}</h3>
                
                <div class="map-container">
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff6b6b;"></div>
                            <span>Hospital</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #4dabf7;"></div>
                            <span>Police Station</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ff8787;"></div>
                            <span>Fire Station</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffd43b;"></div>
                            <span>School</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #69db7c;"></div>
                            <span>Shopping Mall</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #da77f2;"></div>
                            <span>Library</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #8ce99a;"></div>
                            <span>Park</span>
                        </div>
                        <div class="legend-item">
                            <span style="color: #ff0000; font-size: 20px;">‚Üë‚Üì‚Üí‚Üê</span>
                            <span>One-way streets</span>
                        </div>
                    </div>
                    
                    ${generateCityMap()}
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #007bff;">
                    <h3>Enter your route:</h3>
                    <p>Describe the streets and directions (e.g., "Main St south, then 4th Ave east")</p>
                    <textarea id="routeAnswer" class="route-input" rows="3" placeholder="Type your route here..."></textarea>
                    
                    ${scenario.avoidStreets.length > 0 ? `
                        <p style="color: #dc3545; margin-top: 10px;"><strong>‚ö† Note:</strong> ${scenario.avoidStreets.join(', ')}</p>
                    ` : ''}
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitMapRoute()">Submit Route</button>
                </div>
            `;
        }
        
        function generateCityMap() {
            // 10x10 grid city map
            const map = [
                // Row 0 - Header with avenue names
                ['', '1st Ave', '2nd Ave', '3rd Ave', '4th Ave', '5th Ave', '6th Ave', '7th Ave', '8th Ave', ''],
                // Row 1
                ['Main St', 'building-hospital', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'Main St'],
                // Row 2
                ['', 'street-v', 'building-police', '', 'building-park', '', '', 'building-library', '', ''],
                // Row 3
                ['Oak St', 'street-v one-way-n', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'Oak St'],
                // Row 4
                ['', 'street-v', '', 'building-school', '', '', 'building-mall', '', '', ''],
                // Row 5
                ['Elm St', 'street-v', 'street-h one-way-e', 'street-h one-way-e', 'street-h one-way-e', 'street-h one-way-e', 'street-h one-way-e', 'street-h', 'street-h', 'Elm St'],
                // Row 6
                ['', 'street-v', '', '', '', 'building-fire', '', '', '', ''],
                // Row 7
                ['Pine St', 'street-v', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'street-h', 'Pine St'],
                // Row 8
                ['', 'street-v', '', '', '', '', '', '', '', ''],
                // Row 9 - Footer
                ['', '1st Ave', '2nd Ave', '3rd Ave', '4th Ave', '5th Ave', '6th Ave', '7th Ave', '8th Ave', '']
            ];
            
            let html = '<div class="map-grid">';
            for (let row of map) {
                for (let cell of row) {
                    if (cell.includes('building')) {
                        const buildingType = cell.split(' ')[0];
                        const extraClass = cell.includes('one-way') ? cell.split(' ')[1] : '';
                        const buildingName = buildingType.replace('building-', '').toUpperCase();
                        html += `<div class="map-cell ${cell}">${buildingName}</div>`;
                    } else if (cell.includes('street')) {
                        html += `<div class="map-cell ${cell}"></div>`;
                    } else if (cell === '') {
                        html += `<div class="map-cell"></div>`;
                    } else {
                        html += `<div class="map-cell" style="background: #fff; font-weight: bold;">${cell}</div>`;
                    }
                }
            }
            html += '</div>';
            return html;
        }
        
        function submitMapRoute() {
            const scenario = mapScenarios[currentQuestion];
            const userRoute = document.getElementById('routeAnswer').value.trim().toLowerCase();
            
            // Simple route validation - check if key streets are mentioned
            let routeScore = 0;
            let feedback = [];
            
            // Check if route includes correct streets
            scenario.correctRoute.forEach(street => {
                const streetName = street.toLowerCase().split(' ')[0];
                if (userRoute.includes(streetName)) {
                    routeScore += (100 / scenario.correctRoute.length);
                    feedback.push(`‚úì Correctly included ${street}`);
                } else {
                    feedback.push(`‚úó Missing: ${street}`);
                }
            });
            
            // Check if route avoids restricted streets
            let avoidedRestrictions = true;
            scenario.avoidStreets.forEach(avoid => {
                const streetName = avoid.toLowerCase().split(' ')[0];
                if (userRoute.includes(streetName)) {
                    routeScore = Math.max(0, routeScore - 30);
                    feedback.push(`‚úó Should avoid ${avoid}`);
                    avoidedRestrictions = false;
                }
            });
            
            if (avoidedRestrictions && scenario.avoidStreets.length > 0) {
                feedback.push(`‚úì Correctly avoided restricted streets`);
            }
            
            if (routeScore >= 80) {
                correctAnswers++;
            }
            
            // Show feedback
            const content = document.getElementById('moduleContent');
            content.innerHTML += `
                <div style="background: ${routeScore >= 80 ? '#d4edda' : '#fff3cd'}; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px solid ${routeScore >= 80 ? '#28a745' : '#ffc107'};">
                    <h3>Route Evaluation: ${Math.round(routeScore)}%</h3>
                    ${feedback.map(f => `<p style="margin: 5px 0;">${f}</p>`).join('')}
                    <p style="margin-top: 15px;"><strong>Optimal route:</strong> ${scenario.correctRoute.join(', ')}</p>
                </div>
            `;
            
            // Add continue button
            setTimeout(() => {
                const continueBtn = document.createElement('div');
                continueBtn.style.textAlign = 'center';
                continueBtn.style.marginTop = '20px';
                continueBtn.innerHTML = '<button class="btn btn-primary" onclick="nextMapQuestion()">Next Scenario</button>';
                document.getElementById('moduleContent').appendChild(continueBtn);
            }, 500);
        }
        
        function nextMapQuestion() {
            currentQuestion++;
            showNextMapQuestion();
        }
        
        function showMapResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Map Reading Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Routes Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMapReading()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'mapReading',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // Helper function to compare arrays
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }
        
        // READING COMPREHENSION MODULE
        function showReadingComprehension() {
            document.getElementById('moduleTitle').textContent = 'üìò Reading Comprehension Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = 0;
            
            // Calculate total questions across all passages
            readingPassages.forEach(passage => {
                totalQuestions += passage.questions.length;
            });
            
            showNextPassage(0, 0);
        }
        
        function showNextPassage(passageIndex, questionIndex) {
            if (passageIndex >= readingPassages.length) {
                showReadingResults();
                return;
            }
            
            const passage = readingPassages[passageIndex];
            const question = passage.questions[questionIndex];
            
            const content = document.getElementById('moduleContent');
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #007bff;">
                    <h3 style="color: #007bff; margin-bottom: 15px;">${passage.title}</h3>
                    <p style="line-height: 1.8; font-size: 16px; text-align: justify;">${passage.passage}</p>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #28a745;">
                    <h4 style="margin-bottom: 15px;">${question.q}</h4>
                    ${question.options.map((opt, i) => `
                        <div style="margin: 10px 0;">
                            <label style="display: flex; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 5px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f8f9fa'">
                                <input type="radio" name="answer" value="${i}" style="margin-right: 10px; width: 20px; height: 20px;">
                                <span style="font-size: 16px;">${opt}</span>
                            </label>
                        </div>
                    `).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitReadingAnswer(${passageIndex}, ${questionIndex})">Submit Answer</button>
                </div>
            `;
        }
        
        function submitReadingAnswer(passageIndex, questionIndex) {
            const selected = document.querySelector('input[name="answer"]:checked');
            
            if (!selected) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const passage = readingPassages[passageIndex];
            const question = passage.questions[questionIndex];
            const userAnswer = parseInt(selected.value);
            const correct = userAnswer === question.correct;
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.options[question.correct]}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Move to next question
            currentQuestion++;
            setTimeout(() => {
                questionIndex++;
                if (questionIndex >= passage.questions.length) {
                    passageIndex++;
                    questionIndex = 0;
                }
                showNextPassage(passageIndex, questionIndex);
            }, 1500);
        }
        
        function showReadingResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Reading Comprehension Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showReadingComprehension()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'readingComprehension',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // SPELLING MODULE
        function showSpelling() {
            document.getElementById('moduleTitle').textContent = '‚úèÔ∏è Spelling Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = spellingQuestions.length;
            
            showNextSpellingQuestion();
        }
        
        function showNextSpellingQuestion() {
            if (currentQuestion >= spellingQuestions.length) {
                showSpellingResults();
                return;
            }
            
            const question = spellingQuestions[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 30px; border-radius: 10px; margin: 20px 0; text-align: center;">
                    <h3 style="margin-bottom: 20px;">Which spelling is correct?</h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 30px;">Select the correctly spelled word</p>
                    
                    ${question.options.map((opt, i) => `
                        <div style="margin: 15px 0;">
                            <label style="display: block; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 20px; font-family: monospace;" onmouseover="this.style.borderColor='#007bff'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'">
                                <input type="radio" name="spelling" value="${i}" style="margin-right: 15px; width: 20px; height: 20px;">
                                ${opt}
                            </label>
                        </div>
                    `).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitSpellingAnswer()">Submit Answer</button>
                </div>
            `;
        }
        
        function submitSpellingAnswer() {
            const selected = document.querySelector('input[name="spelling"]:checked');
            
            if (!selected) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const question = spellingQuestions[currentQuestion];
            const userAnswer = parseInt(selected.value);
            const correct = userAnswer === question.correct;
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0; font-family: monospace; font-size: 20px;">Correct spelling: <strong>${question.options[question.correct]}</strong></p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Move to next question
            setTimeout(() => {
                currentQuestion++;
                showNextSpellingQuestion();
            }, 1500);
        }
        
        function showSpellingResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Spelling Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showSpelling()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'spelling',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // SENTENCE CLARITY MODULE
        function showSentenceClarity() {
            document.getElementById('moduleTitle').textContent = 'üó£Ô∏è Sentence Clarity Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = sentenceClarityQuestions.length;
            
            showNextClarityQuestion();
        }
        
        function showNextClarityQuestion() {
            if (currentQuestion >= sentenceClarityQuestions.length) {
                showClarityResults();
                return;
            }
            
            const question = sentenceClarityQuestions[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border: 2px solid #ffc107; text-align: center;">
                    <h3 style="color: #856404;">${question.question}</h3>
                    <p style="font-size: 14px; color: #856404; margin-top: 10px;">Choose the clearest, most concise sentence</p>
                </div>
                
                ${question.options.map((opt, i) => `
                    <div style="margin: 15px 0;">
                        <label style="display: block; padding: 15px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#007bff'; this.style.transform='translateX(5px)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateX(0)'">
                            <input type="radio" name="clarity" value="${i}" style="margin-right: 10px; width: 18px; height: 18px;">
                            <span style="font-size: 16px; line-height: 1.6;">${opt}</span>
                        </label>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitClarityAnswer()">Submit Answer</button>
                </div>
            `;
        }
        
        function submitClarityAnswer() {
            const selected = document.querySelector('input[name="clarity"]:checked');
            
            if (!selected) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const question = sentenceClarityQuestions[currentQuestion];
            const userAnswer = parseInt(selected.value);
            const correct = userAnswer === question.correct;
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.options[question.correct]}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Move to next question
            setTimeout(() => {
                currentQuestion++;
                showNextClarityQuestion();
            }, 1500);
        }
        
        function showClarityResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Sentence Clarity Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showSentenceClarity()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'sentenceClarity',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
        
        // MATHEMATICS MODULE
        function showMathematics() {
            document.getElementById('moduleTitle').textContent = '‚ûï Mathematics Practice';
            currentQuestion = 0;
            correctAnswers = 0;
            totalQuestions = mathQuestions.length;
            
            showNextMathQuestion();
        }
        
        function showNextMathQuestion() {
            if (currentQuestion >= mathQuestions.length) {
                showMathResults();
                return;
            }
            
            const question = mathQuestions[currentQuestion];
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p style="color: #666;">Question ${currentQuestion + 1} of ${totalQuestions}</p>
                    <div style="background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden;">
                        <div style="background: #007bff; height: 100%; width: ${((currentQuestion + 1) / totalQuestions) * 100}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="background: #e3f2fd; padding: 25px; border-radius: 10px; margin: 20px 0; border: 2px solid #2196f3;">
                    <h3 style="color: #1976d2; margin-bottom: 20px; text-align: center;">${question.question}</h3>
                    <p style="text-align: center; color: #1976d2; font-size: 14px;">‚ö† No calculator allowed - work it out mentally or on paper</p>
                </div>
                
                ${question.options.map((opt, i) => `
                    <div style="margin: 12px 0;">
                        <label style="display: block; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 18px;" onmouseover="this.style.borderColor='#2196f3'; this.style.background='#f5f5f5'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white'">
                            <input type="radio" name="math" value="${i}" style="margin-right: 12px; width: 20px; height: 20px;">
                            <strong style="margin-right: 10px;">${String.fromCharCode(65 + i)})</strong> ${opt}
                        </label>
                    </div>
                `).join('')}
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-success" onclick="submitMathAnswer()">Submit Answer</button>
                </div>
            `;
        }
        
        function submitMathAnswer() {
            const selected = document.querySelector('input[name="math"]:checked');
            
            if (!selected) {
                alert('Please select an answer before submitting.');
                return;
            }
            
            const question = mathQuestions[currentQuestion];
            const userAnswer = parseInt(selected.value);
            const correct = userAnswer === question.correct;
            
            if (correct) {
                correctAnswers++;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = 'background: ' + (correct ? '#d4edda' : '#f8d7da') + '; padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid ' + (correct ? '#28a745' : '#dc3545');
            feedback.innerHTML = `
                <p style="font-size: 18px; margin: 0;"><strong>${correct ? '‚úì Correct!' : '‚úó Incorrect'}</strong></p>
                ${!correct ? `<p style="margin: 10px 0 0 0;">Correct answer: ${question.options[question.correct]}</p>` : ''}
            `;
            document.getElementById('moduleContent').appendChild(feedback);
            
            // Move to next question
            setTimeout(() => {
                currentQuestion++;
                showNextMathQuestion();
            }, 1500);
        }
        
        function showMathResults() {
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const content = document.getElementById('moduleContent');
            
            content.innerHTML = `
                <div class="score-display">
                    <h3>Mathematics Results</h3>
                    <h2>${correctAnswers} out of ${totalQuestions}</h2>
                    <p>${percentage}% Correct</p>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="showMathematics()">Practice Again</button>
                    <button class="btn btn-danger" onclick="closeModule()">Exit Module</button>
                </div>
            `;
            
            // Save score to Firebase
            if (auth.currentUser) {
                db.collection('users').doc(auth.currentUser.uid)
                  .collection('criticallScores').add({
                    module: 'mathematics',
                    score: percentage,
                    correct: correctAnswers,
                    total: totalQuestions,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                  });
            }
        }
    </script>
</body>
</html>
