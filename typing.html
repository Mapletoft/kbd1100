<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KBD1100 - Typing Practice | Cambrian College</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <div class="app-header">
      <div class="app-title">
        <h1>‚å®Ô∏è KBD1100 - Computer Keyboarding Skills</h1>
        <p>Cambrian College | Instructor: Charles Mapletoft</p>
      </div>
      <div class="user-info">
        <span>üë§ <strong id="userName">Student</strong></span>
        <span>üìä <strong id="userProgress">0/12 Stages</strong></span>
        <button class="logout-btn" onclick="signOut()">Sign Out</button>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="tab active" onclick="switchTab('lessons', this)">üìö Skill Building</button>
      <button class="tab" onclick="switchTab('progress', this)">üìä My Progress</button>
      <button class="tab" onclick="switchTab('tests', this)" id="testsTab" disabled>üîí Timed Tests</button>
      <button class="tab" onclick="switchTab('office', this)">üíº Office Practice</button>
      <button class="tab" onclick="window.location.href='criticall.html'" style="background: linear-gradient(135deg, #ff6b6b, #ff8e53);">üö® CritiCall Practice</button>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Lessons Tab -->
      <div id="lessons" class="tab-content active">
        <h2>Skill Building Lessons</h2>
        <p>Complete all stages in each skill to unlock the next level. Focus on accuracy first, speed will follow!</p>
        <div class="lesson-grid" id="lessonGrid"></div>
      </div>

      <!-- Progress Tab -->
      <div id="progress" class="tab-content">
        <h2>Your Progress Report</h2>

        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-label">Average WPM</div>
            <div class="stat-value" id="avgWpm">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Average Accuracy</div>
            <div class="stat-value" id="avgAccuracy">0%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Total Backspaces</div>
            <div class="stat-value" id="totalBackspaces">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Stages Complete</div>
            <div class="stat-value" id="stagesComplete">0</div>
          </div>
        </div>

        <h3 style="margin-top: 30px;">Recent Activity</h3>
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="padding: 12px; text-align: left;">Date</th>
              <th style="padding: 12px; text-align: left;">Lesson</th>
              <th style="padding: 12px; text-align: left;">Stage</th
              <th style="padding: 12px; text-align: left;">WPM</th>
              <th style="padding: 12px; text-align: left;">Accuracy</th>
              <th style="padding: 12px; text-align: left;">Backspaces</th>
            </tr>
          </thead>
          <tbody id="historyTable"></tbody>
        </table>

        <div class="control-buttons">
          <button class="btn btn-primary" onclick="exportProgress()">üì• Export Report</button>
        </div>
      </div>

        <!-- Office tab content section -->
<div id="office" class="tab-content">
    <h2>Microsoft Office Practice</h2>
    
    <!-- Sub-tabs for Word and Excel -->
    <div style="display: flex; gap: 10px; margin: 20px 0; border-bottom: 2px solid #e0e0e0;">
        <button onclick="showOfficeTool('word')" class="btn btn-primary">üìù Word Processor</button>
        <button onclick="showOfficeTool('excel')" class="btn btn-primary">üìä Spreadsheet</button>
    </div>

    <!-- Word Processor -->
    <div id="wordTool" class="office-tool">
        <h3>Word Processor Practice</h3>
        
        <!-- Formatting Toolbar -->
        <div class="word-toolbar" style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <button onclick="formatText('bold')" title="Bold (Ctrl+B)"><b>B</b></button>
            <button onclick="formatText('italic')" title="Italic (Ctrl+I)"><i>I</i></button>
            <button onclick="formatText('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
            <span style="margin: 0 10px;">|</span>
            <button onclick="formatText('justifyLeft')" title="Align Left">‚¨ÖÔ∏è</button>
            <button onclick="formatText('justifyCenter')" title="Center">‚ÜîÔ∏è</button>
            <button onclick="formatText('justifyRight')" title="Align Right">‚û°Ô∏è</button>
            <span style="margin: 0 10px;">|</span>
            <button onclick="insertTable()" title="Insert Table">üìã Table</button>
            <button onclick="saveWordDoc()" title="Save (Ctrl+S)">üíæ Save</button>
            <button onclick="loadWordDoc()" title="Open">üìÅ Open</button>
            <button onclick="printDoc()" title="Print (Ctrl+P)">üñ®Ô∏è Print</button>
            <span style="margin: 0 10px;">|</span>
            <button onclick="wordCount()" title="Word Count">üìä Count</button>
            <button onclick="findReplace()" title="Find & Replace">üîç Find</button>
            <button onclick="insertDateTime()" title="Insert Date/Time">üìÖ Date</button>
            <button onclick="toUpperCase()" title="Convert to UPPERCASE">üî† CAPS</button>
            <button onclick="showPracticeTask('word')" class="btn btn-success">üìã Get Practice Task</button>
        </div>

        <!-- Document Area -->
        <div contenteditable="true" id="wordDocument" style="min-height: 400px; padding: 40px; background: white; border: 1px solid #ccc; font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5;">
            <h1 style="text-align: center;">MEMO</h1>
            <p><strong>TO:</strong> All Dispatch Staff<br>
            <strong>FROM:</strong> [Your Name]<br>
            <strong>DATE:</strong> <span id="currentDate"></span><br>
            <strong>RE:</strong> Training Exercise</p>
            
            <p>Type your memo content here. Practice using keyboard shortcuts:</p>
            <ul>
                <li>Ctrl+B for Bold</li>
                <li>Ctrl+I for Italic</li>
                <li>Ctrl+S to Save</li>
                <li>Ctrl+Z to Undo</li>
            </ul>
        </div>

        <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
            <strong>Practice Tasks:</strong>
            <ol>
                <li>Format the heading as bold and centered</li>
                <li>Add a table for shift schedules</li>
                <li>Save your document with a meaningful name</li>
            </ol>
        </div>
    </div>

    <!-- Excel/Spreadsheet -->
    <div id="excelTool" class="office-tool" style="display: none;">
        <h3>Spreadsheet Practice - Dispatcher Overtime Tracker</h3>
        
        <!-- Excel Toolbar -->
        <div class="excel-toolbar" style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <button onclick="addRow()">‚ûï Add Row</button>
            <button onclick="addColumn()">üìä Add Column</button>
            <button onclick="autoSum()">Œ£ AutoSum</button>
            <button onclick="calculateAverage()">üìà Average</button>
            <button onclick="formatCells()">üé® Format</button>
            <button onclick="saveExcel()">üíæ Save</button>
            <button onclick="showPracticeTask('excel')" class="btn btn-success">üìã Get Practice Task</button>
            <button onclick="conditionalFormat()">üé® Color by Value</button>
        </div>

        <!-- Spreadsheet Grid -->
        <div style="overflow: auto; max-height: 500px;">
            <table id="spreadsheet" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="background: #e0e0e0; padding: 5px; border: 1px solid #999;"></th>
                        <th style="background: #e0e0e0; padding: 5px; border: 1px solid #999;">A</th>
                        <th style="background: #e0e0e0; padding: 5px; border: 1px solid #999;">B</th>
                        <th style="background: #e0e0e0; padding: 5px; border: 1px solid #999;">C</th>
                        <th style="background: #e0e0e0; padding: 5px; border: 1px solid #999;">D</th>
                        <th style="background: #e0e0e0; padding: 5px; border: 1px solid #999;">E</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="background: #e0e0e0; padding: 5px; border: 1px solid #999;">1</td>
                        <td contenteditable="true" class="cell" data-cell="A1" style="padding: 5px; border: 1px solid #ccc;">Employee Name</td>
                        <td contenteditable="true" class="cell" data-cell="B1" style="padding: 5px; border: 1px solid #ccc;">Regular Hours</td>
                        <td contenteditable="true" class="cell" data-cell="C1" style="padding: 5px; border: 1px solid #ccc;">Overtime Hours</td>
                        <td contenteditable="true" class="cell" data-cell="D1" style="padding: 5px; border: 1px solid #ccc;">Total Hours</td>
                        <td contenteditable="true" class="cell" data-cell="E1" style="padding: 5px; border: 1px solid #ccc;">Pay Rate</td>
                    </tr>
                    <tr>
                        <td style="background: #e0e0e0; padding: 5px; border: 1px solid #999;">2</td>
                        <td contenteditable="true" class="cell" data-cell="A2" style="padding: 5px; border: 1px solid #ccc;">John Smith</td>
                        <td contenteditable="true" class="cell" data-cell="B2" style="padding: 5px; border: 1px solid #ccc;">40</td>
                        <td contenteditable="true" class="cell" data-cell="C2" style="padding: 5px; border: 1px solid #ccc;">5</td>
                        <td contenteditable="true" class="cell formula" data-cell="D2" style="padding: 5px; border: 1px solid #ccc;">=B2+C2</td>
                        <td contenteditable="true" class="cell" data-cell="E2" style="padding: 5px; border: 1px solid #ccc;">25.00</td>
                    </tr>
                    <!-- Add more rows as needed -->
                </tbody>
            </table>
        </div>

        <div style="margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
            <strong>Formula Bar:</strong> <input type="text" id="formulaBar" style="width: 100%; padding: 5px; font-family: monospace;">
            <br><br>
            <strong>Practice Tasks:</strong>
            <ol>
                <li>Enter employee hours data</li>
                <li>Use =B2+C2 to calculate total hours</li>
                <li>Use =SUM(B2:B10) to total a column</li>
                <li>Use =AVERAGE(D2:D10) for average hours</li>
                <li>Format cells with borders and shading</li>
            </ol>
        </div>
    </div>
</div>

      <!-- Tests Tab (Locked Initially) -->
<div id="tests" class="tab-content">
    <h2>‚è±Ô∏è Timed Typing Tests</h2>
    <p>Build your speed with practice tests. 3-minute tests count toward your final grade.</p>
    
    <!-- Test Selection Buttons -->
    <div class="lesson-grid">
        <div class="lesson-card" onclick="initTimedTest(1)">
            <h3>1 Minute Test</h3>
            <p>Quick practice</p>
        </div>
        <div class="lesson-card" onclick="initTimedTest(2)">
            <h3>2 Minute Test</h3>
            <p>Medium practice</p>
        </div>
        <div class="lesson-card" onclick="initTimedTest(3)">
            <h3>3 Minute Test</h3>
            <p>‚≠ê Counts for grade</p>
        </div>
    </div>
    
    <!-- Test Interface (Hidden initially) -->
          <div class="typing-area" id="timedTestArea" style="display: none;">
              <h3 id="timedTestTitle">Test Title</h3>
              <div class="prompt-text" id="timedTestPrompt">Test text will appear here</div>
              <textarea class="typing-input" id="timedTestInput" 
                        placeholder="Click Start Test to begin..." 
                        disabled style="width: 100%; min-height: 150px;"></textarea>
              
              <div class="stats-row">
                  <div class="stat-box">
                      <div class="stat-label">Time Left</div>
                      <div class="stat-value" id="timeRemaining">0:00</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label">WPM</div>
                      <div class="stat-value" id="timedWpm">0</div>
                  </div>
                  <div class="stat-box">
                      <div class="stat-label">Accuracy</div>
                      <div class="stat-value" id="timedAccuracy">100%</div>
                  </div>
              </div>
              
              <div class="control-buttons">
                  <button class="btn btn-success" id="startTimedBtn" onclick="startTimedTest()">Start Test</button>
                  <button class="btn btn-danger" onclick="cancelTimedTest()">Cancel</button>
              </div>
          </div>
          
          <!-- Test History -->
          <div id="testHistory" style="margin-top: 30px; display: none;">
              <h3>Your Test Results</h3>
              <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                      <tr style="background: #f5f5f5;">
                          <th style="padding: 10px;">Date</th>
                          <th style="padding: 10px;">Duration</th>
                          <th style="padding: 10px;">WPM</th>
                          <th style="padding: 10px;">Accuracy</th>
                          <th style="padding: 10px;">Grade</th>
                      </tr>
                  </thead>
                  <tbody id="testHistoryBody"></tbody>
              </table>
          </div>
      </div>
    </div>
  </div>

  <!-- Stage Practice Modal -->
  <div class="modal" id="practiceModal">
    <div class="modal-content" style="max-width: 900px;">
      <h2 id="modalTitle">Lesson Title</h2>
      <p id="stageInfo" style="margin-bottom: 20px; color: #666;">Stage 1 of 5</p>

      <div class="typing-area">
        <div class="prompt-text" id="promptText">
          Press "Start" when you're ready to begin
        </div>

        <input type="text" class="typing-input" id="typingInput"
               placeholder="Click Start, then type here..." disabled>

        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-label">WPM</div>
            <div class="stat-value" id="currentWpm">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Accuracy</div>
            <div class="stat-value" id="currentAccuracy">100%</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Backspaces</div>
            <div class="stat-value" id="backspaceCount">0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Time</div>
            <div class="stat-value" id="elapsedTime">0:00</div>
          </div>
        </div>

        <div class="control-buttons">
          <button class="btn btn-success" id="startBtn" onclick="startStage()">‚ñ∂Ô∏è Start</button>
          <button class="btn btn-danger" onclick="closeModal()">‚úñÔ∏è Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Modal -->
  <div class="modal" id="resultsModal">
    <div class="modal-content">
      <h2 id="resultTitle">Stage Complete!</h2>
      <div id="resultContent" style="margin: 20px 0;"></div>
      <div class="control-buttons">
        <button class="btn btn-primary" onclick="nextStage()">Next Stage ‚û°Ô∏è</button>
        <button class="btn btn-success" onclick="retryStage()">üîÑ Retry</button>
        <button class="btn btn-danger" onclick="closeResults()">Close</button>
      </div>
    </div>
  </div>


  <script>
    /***************
     * CONFIG / STATE
     ***************/
    const TEACHER_UID = "CVBEuoweirfSPLhjfm499puLrcn2";

    // Lessons & stages (unchanged)
    const lessons = [
      { id: 1, title: "Home Row", icon: "üè†", description: "Master the foundation: ASDF JKL;",
        stages: [
          { text: "fff jjj fff jjj ff jj ff jj fjfj fjfj", minWpm: 20, minAccuracy: 90 },
          { text: "ddd kkk ddd kkk dd kk dd kk dkdk dkdk", minWpm: 25, minAccuracy: 90 },
          { text: "aaa ;;; aaa ;;; aa ;; aa ;; a;a; a;a;", minWpm: 25, minAccuracy: 90 },
          { text: "asdf jkl; asdf jkl; fdsa ;lkj fdsa ;lkj", minWpm: 30, minAccuracy: 92 },
          { text: "sad flask jak lads fall salad flask dad", minWpm: 35, minAccuracy: 95 }
        ]
      },
      { id: 2, title: "Top Row", icon: "‚¨ÜÔ∏è", description: "Reach for QWERT YUIOP",
        stages: [
          { text: "qqq ppp qqq ppp qq pp qq pp qpqp qpqp", minWpm: 20, minAccuracy: 90 },
          { text: "www ooo www ooo ww oo ww oo wowo wowo", minWpm: 25, minAccuracy: 90 },
          { text: "eee iii eee iii ee ii ee ii eiei eiei", minWpm: 25, minAccuracy: 90 },
          { text: "qwert yuiop qwert yuiop werty uiop qwe", minWpm: 30, minAccuracy: 92 },
          { text: "power query write poetry tower quite proper", minWpm: 35, minAccuracy: 95 }
        ]
      },
      { id: 3, title: "Bottom Row", icon: "‚¨áÔ∏è", description: "Complete the alphabet: ZXCVB NM",
        stages: [
          { text: "zzz mmm zzz mmm zz mm zz mm zmzm zmzm", minWpm: 20, minAccuracy: 90 },
          { text: "xxx nnn xxx nnn xx nn xx nn xnxn xnxn", minWpm: 25, minAccuracy: 90 },
          { text: "ccc vvv bbb ccc vvv bbb cv vb cv vb", minWpm: 25, minAccuracy: 90 },
          { text: "zxcvb nm,. zxcvb nm,. xcvb nm,. zxc", minWpm: 30, minAccuracy: 92 },
          { text: "zebra venom combat maximum bronze exam", minWpm: 35, minAccuracy: 95 }
        ]
      },
      { id: 4, title: "Numbers", icon: "üî¢", description: "Master the number row: 1234567890",
        stages: [
          { text: "111 222 333 111 222 333 123 123 123", minWpm: 20, minAccuracy: 90 },
          { text: "444 555 666 444 555 666 456 456 456", minWpm: 25, minAccuracy: 90 },
          { text: "777 888 999 000 777 888 999 000 7890", minWpm: 25, minAccuracy: 90 },
          { text: "1234567890 0987654321 1357924680 2468", minWpm: 30, minAccuracy: 92 },
          { text: "My phone is 555-1234 and zip is 90210", minWpm: 35, minAccuracy: 95 }
        ]
      },
      { id: 5, title: "Shift Keys", icon: "‚¨ÜÔ∏è", description: "Capital letters with Shift",
        stages: [
          { text: "Aa Bb Cc Dd Ee Ff Gg Hh Ii Jj Kk", minWpm: 20, minAccuracy: 85 },
          { text: "The Quick Fox The Quick Fox The", minWpm: 25, minAccuracy: 88 },
          { text: "Hello World Hello World Hello World", minWpm: 30, minAccuracy: 90 },
          { text: "John Smith Lives In New York City Today", minWpm: 35, minAccuracy: 92 },
          { text: "The Quick Brown Fox Jumps Over The Lazy Dog", minWpm: 40, minAccuracy: 95 }
        ]
      },
      { id: 6, title: "Caps Lock", icon: "üî†", description: "Toggle CAPS LOCK efficiently",
        stages: [
          { text: "ABC DEF GHI JKL MNO PQR STU VWX YZ", minWpm: 20, minAccuracy: 85 },
          { text: "HELLO WORLD HELLO WORLD HELLO", minWpm: 25, minAccuracy: 88 },
          { text: "TYPE THIS IN ALL CAPS PLEASE OK", minWpm: 30, minAccuracy: 90 },
          { text: "WARNING: DO NOT ENTER THIS AREA", minWpm: 35, minAccuracy: 92 },
          { text: "IMPORTANT NOTICE: MEETING CANCELLED TODAY", minWpm: 40, minAccuracy: 95 }
        ]
      },
      { id: 7, title: "Symbols Level 1", icon: "‚ö°", description: "Basic punctuation and symbols",
        stages: [
          { text: "... ,,, ... ,,, ... ,,, .,., .,.,", minWpm: 20, minAccuracy: 85 },
          { text: "!!! ??? !!! ??? !?!? !?!? !? !? !?", minWpm: 20, minAccuracy: 85 },
          { text: ": ; : ; : ; :; :; :; ';' ';' ';'", minWpm: 25, minAccuracy: 88 },
          { text: "Hello! How are you? I'm fine, thanks.", minWpm: 30, minAccuracy: 90 },
          { text: "Wait! Don't go; I'm not done yet: okay?", minWpm: 35, minAccuracy: 92 }
        ]
      },
      { id: 8, title: "Symbols Level 2", icon: "üíé", description: "Advanced symbols and special characters",
        stages: [
          { text: "@@@ ### $$$ %%% @@@ ### $$$ %%%", minWpm: 20, minAccuracy: 85 },
          { text: "((( ))) [[[ ]]] {{{ }}} ((( )))", minWpm: 20, minAccuracy: 85 },
          { text: "+++ === --- ___ +++ === --- ___", minWpm: 25, minAccuracy: 88 },
          { text: "user@email.com costs $99.99 (50% off)", minWpm: 30, minAccuracy: 90 },
          { text: "Call (555) 123-4567 or visit www.site.com", minWpm: 35, minAccuracy: 92 }
        ]
      },
      { id: 9, title: "Mixed Practice", icon: "üéØ", description: "Combine all skills",
        stages: [
          { text: "abc 123 ABC !@# abc 123 ABC !@#", minWpm: 25, minAccuracy: 85 },
          { text: "The price is $50.00 (plus tax).", minWpm: 30, minAccuracy: 88 },
          { text: "Email me at: john@example.com NOW!", minWpm: 35, minAccuracy: 90 },
          { text: "Meeting at 3:30 PM in Room #204-B", minWpm: 40, minAccuracy: 92 },
          { text: "Save 25% TODAY! Visit www.sale.com or call (800) 555-DEAL", minWpm: 45, minAccuracy: 95 }
        ]
      },
      { id: 10, title: "Speed Builder", icon: "üöÄ", description: "Common words for speed",
        stages: [
          { text: "the the the and and and for for", minWpm: 40, minAccuracy: 95 },
          { text: "that with have this will your from", minWpm: 45, minAccuracy: 95 },
          { text: "they what about which their would", minWpm: 50, minAccuracy: 95 },
          { text: "the quick brown fox jumps over the lazy", minWpm: 55, minAccuracy: 95 },
          { text: "pack my box with five dozen liquor jugs now", minWpm: 60, minAccuracy: 95 }
        ]
      },
      { id: 11, title: "Accuracy Focus", icon: "üé™", description: "Precision over speed",
        stages: [
          { text: "Slow and steady wins the race.", minWpm: 20, minAccuracy: 100 },
          { text: "Precision is the key to success.", minWpm: 25, minAccuracy: 98 },
          { text: "Every keystroke must be perfect.", minWpm: 30, minAccuracy: 98 },
          { text: "Accuracy first, then speed will follow.", minWpm: 35, minAccuracy: 98 },
          { text: "Perfect practice makes perfect performance.", minWpm: 40, minAccuracy: 100 }
        ]
      },
      { id: 12, title: "Numeric Keypad", icon: "üîü", description: "Master the number pad",
        stages: [
          { text: "789 789 789 456 456 456 123 123", minWpm: 25, minAccuracy: 90 },
          { text: "741 852 963 741 852 963 741 852", minWpm: 30, minAccuracy: 90 },
          { text: "147 258 369 147 258 369 147 258", minWpm: 35, minAccuracy: 92 },
          { text: "7410 8520 9630 1470 2580 3690", minWpm: 40, minAccuracy: 95 },
          { text: "98765 43210 13579 24680 11235", minWpm: 45, minAccuracy: 95 }
        ]
      },
      { id: 13, title: "Common Word Patterns", icon: "üî§", description: "Master frequent combinations",
        stages: [
          { text: "the then them there these that than this their through", minWpm: 30, minAccuracy: 95 },
          { text: "ing going typing working thinking doing making taking having", minWpm: 35, minAccuracy: 95 },
          { text: "tion nation station motion action fraction education information", minWpm: 35, minAccuracy: 95 },
          { text: "er her were where never under over after better together", minWpm: 40, minAccuracy: 95 },
          { text: "ment moment movement government development management agreement", minWpm: 45, minAccuracy: 95 }
        ]
      },
      
      { id: 14, title: "Business Communication", icon: "üíº", description: "Professional typing practice",
        stages: [
          { text: "Thank you for your email regarding this matter.", minWpm: 35, minAccuracy: 95 },
          { text: "Please find attached the requested documents for your review.", minWpm: 40, minAccuracy: 95 },
          { text: "I will follow up with you by the end of business today.", minWpm: 45, minAccuracy: 95 },
          { text: "We appreciate your patience while we investigate this issue.", minWpm: 45, minAccuracy: 95 },
          { text: "Please let me know if you require any additional information or clarification.", minWpm: 50, minAccuracy: 95 }
        ]
      },
      
      { id: 15, title: "Weak Finger Training", icon: "‚úã", description: "Strengthen ring and pinky fingers",
        stages: [
          { text: "paw wax zap lap sap pal lax pox paz waz", minWpm: 25, minAccuracy: 90 },
          { text: "aqua plaza pizza puzzle quizzes zealous plaza", minWpm: 30, minAccuracy: 90 },
          { text: "pop lop kop hop yop top rop eop wop qop", minWpm: 30, minAccuracy: 90 },
          { text: "xylophone saxophone microphone telephone headphone", minWpm: 35, minAccuracy: 92 },
          { text: "zigzag xerox perplex complex apex reflex index", minWpm: 40, minAccuracy: 95 }
        ]
      },
      
      { id: 16, title: "Problem Words", icon: "‚ö†Ô∏è", description: "Commonly misspelled words",
        stages: [
          { text: "because people through just know should could would", minWpm: 35, minAccuracy: 98 },
          { text: "thought between government different business necessary", minWpm: 40, minAccuracy: 98 },
          { text: "definitely occurred tomorrow beginning immediately", minWpm: 40, minAccuracy: 98 },
          { text: "receive achieve believe weird conscience conscious", minWpm: 45, minAccuracy: 98 },
          { text: "accommodate embarrass occurrence privilege separate maintenance", minWpm: 45, minAccuracy: 98 }
        ]
      },
      
      { id: 17, title: "CAD Abbreviations Basic", icon: "üöî", description: "Common dispatch codes A-D",
        stages: [
          { text: "DOB DOB DOB DATE OF BIRTH DOB DATE OF BIRTH DOB", minWpm: 30, minAccuracy: 95 },
          { text: "ADV ADVISED AMB AMBULANCE ARR ARRIVE ASAP ASAP", minWpm: 35, minAccuracy: 95 },
          { text: "BOLO BE ON THE LOOKOUT BOLO CAD COMP COMPLAINANT", minWpm: 35, minAccuracy: 95 },
          { text: "DL DRIVERS LICENCE DOB DATE OF BIRTH DISP DISPATCH", minWpm: 40, minAccuracy: 95 },
          { text: "CPIC CST CONSTABLE CID CRIMINAL INVESTIGATIONS DEP DEPART", minWpm: 45, minAccuracy: 95 }
        ]
      },
      
      { id: 18, title: "CAD Abbreviations Advanced", icon: "üö®", description: "Emergency codes E-M",
        stages: [
          { text: "EMS EMERGENCY MEDICAL ER ENROUTE ETA ESTIMATED TIME", minWpm: 35, minAccuracy: 95 },
          { text: "FD FIRE DEPARTMENT FF FIREFIGHTER FEM FEMALE", minWpm: 35, minAccuracy: 95 },
          { text: "HQ HEADQUARTERS ID IDENTIFICATION INC INCIDENT INFO", minWpm: 40, minAccuracy: 95 },
          { text: "K9 CANINE UNIT LKA LAST KNOWN ADDRESS LIC LICENCE", minWpm: 40, minAccuracy: 95 },
          { text: "MVC MOTOR VEHICLE COLLISION MHA MENTAL HEALTH ACT", minWpm: 45, minAccuracy: 95 }
        ]
      },
      
      { id: 19, title: "CAD Directions & Locations", icon: "üß≠", description: "Directional codes",
        stages: [
          { text: "N NORTH S SOUTH E EAST W WEST NB NORTHBOUND", minWpm: 35, minAccuracy: 95 },
          { text: "SB SOUTHBOUND EB EASTBOUND WB WESTBOUND NE NORTHEAST", minWpm: 40, minAccuracy: 95 },
          { text: "NW NORTHWEST SE SOUTHEAST SW SOUTHWEST BT BETWEEN", minWpm: 40, minAccuracy: 95 },
          { text: "PL PARKING LOT STA STATION STN STATION HQ HEADQUARTERS", minWpm: 45, minAccuracy: 95 },
          { text: "N/B NORTHBOUND S/B SOUTHBOUND E/B EASTBOUND W/B WESTBOUND", minWpm: 50, minAccuracy: 95 }
        ]
      },
      
      { id: 20, title: "CAD Status Codes", icon: "üì°", description: "Status and response codes",
        stages: [
          { text: "ARR ARRIVED DEP DEPARTED ER ENROUTE BIS BACK IN STATION", minWpm: 35, minAccuracy: 95 },
          { text: "NEG NEGATIVE UNK UNKNOWN REQ REQUESTED REC'D RECEIVED", minWpm: 40, minAccuracy: 95 },
          { text: "VSA VITAL SIGNS ABSENT DOA DEAD ON ARRIVAL DNR DO NOT", minWpm: 40, minAccuracy: 95 },
          { text: "NFA NO FIXED ADDRESS FTA FAIL TO APPEAR FTR FAIL TO REMAIN", minWpm: 45, minAccuracy: 95 },
          { text: "ASAP AS SOON AS POSSIBLE ETA ESTIMATED TIME EOC EMERGENCY OPS", minWpm: 50, minAccuracy: 95 }
        ]
      },
      
      { id: 21, title: "CAD Vehicle Colors", icon: "üé®", description: "Color codes for vehicles",
        stages: [
          { text: "BLK BLACK WHI WHITE GRY GREY SIL SILVER RED RED", minWpm: 35, minAccuracy: 95 },
          { text: "BLU BLUE GRN GREEN YEL YELLOW ORG ORANGE BRN BROWN", minWpm: 35, minAccuracy: 95 },
          { text: "BGE BEIGE TAN TAN NVY NAVY PLE PURPLE PNK PINK", minWpm: 40, minAccuracy: 95 },
          { text: "BLK/WHI BLACK WHITE BLU/SIL BLUE SILVER RED/BLK RED BLACK", minWpm: 45, minAccuracy: 95 },
          { text: "BURG BURGUNDY CRM CREAM GRY/BLK GREY BLACK WHI/BLU WHITE BLUE", minWpm: 45, minAccuracy: 95 }
        ]
      },
      
      { id: 22, title: "CAD Full Scenarios", icon: "üéØ", description: "Complete dispatch entries",
        stages: [
          { text: "MVC AT HWY 401 E/B VSA REQ EMS ASAP", minWpm: 40, minAccuracy: 95 },
          { text: "BOLO WHI MALE 30 YO LSH N/B ON FOOT LKA 123 MAIN ST", minWpm: 45, minAccuracy: 95 },
          { text: "B&E IN PROGRESS COMP ON SCENE REQ K9 AND IDENT", minWpm: 45, minAccuracy: 95 },
          { text: "DV CALL FEM VIC REQ AMB AND CAS SUSP HBD LEFT S/B IN BLK P/U", minWpm: 50, minAccuracy: 95 },
          { text: "MVA WITH PI 3 VEH BLK SUV RED SED SIL P/U REQ FD EMS MTO VSA NEG", minWpm: 55, minAccuracy: 95 }
        ]
      },
      { id: 25, title: "Number Combinations", icon: "üî¢", description: "Numbers with text",
        stages: [
          { text: "Room 101 Building A Floor 3 Suite 250", minWpm: 30, minAccuracy: 95 },
          { text: "The year 2024 marks our 125th anniversary celebration", minWpm: 35, minAccuracy: 95 },
          { text: "Call 911 for emergencies or 311 for city services", minWpm: 35, minAccuracy: 95 },
          { text: "Highway 401 eastbound at exit 375 near kilometer 92", minWpm: 40, minAccuracy: 95 },
          { text: "Respond to 1234 Main Street Apartment 567 Unit B", minWpm: 45, minAccuracy: 95 }
        ]
      },
      
      { id: 26, title: "Punctuation Mastery", icon: "‚ö°", description: "Complex punctuation",
        stages: [
          { text: "Yes, no, maybe; these are your options: choose wisely.", minWpm: 30, minAccuracy: 95 },
          { text: "The suspect (male, 30s) was last seen at 10:45 p.m.", minWpm: 35, minAccuracy: 95 },
          { text: "Alert: All units respond! Code 3 - urgent; backup needed.", minWpm: 40, minAccuracy: 95 },
          { text: "Items needed: radio, badge, vest (bulletproof), and notebook.", minWpm: 40, minAccuracy: 95 },
          { text: "Question: Who, what, when, where, why, and how?", minWpm: 45, minAccuracy: 95 }
        ]
      }
      
    ];

    // State
    let currentLesson = null;
    let currentStage = 0; // 0-based index
    let startTime = null;
    let timerInterval = null;
    let backspaceCount = 0;

    // Aggregated client-side view of progress & activity (loaded from Firestore)
    const userProgress = {
      completedStages: {}, // { [lessonId]: Set<number> (0-based stages) }
      history: []          // recent attempts (from Firestore 'attempts')
    };

    /***************
     * AUTH GUARD + INITIAL LOAD
     ***************/
    auth.onAuthStateChanged(async (user) => {
      if (!user) { location.href = 'index.html'; return; }
      if (user.uid === TEACHER_UID) { location.href = 'teacher.html'; return; }

      // Ensure profile doc exists
      const profileRef = db.collection('users').doc(user.uid);
      const snap = await profileRef.get();
      if (!snap.exists) {
        await profileRef.set({
          email: user.email,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true });
      }

      // Set header name
      document.getElementById('userName').textContent = user.email;

      // Build UI
      renderLessons();

      // Load Firestore progress + recent attempts
      await Promise.all([loadProgressFromFirestore(user.uid), loadRecentAttempts(user.uid)]);

      // Update dashboard numbers & unlock tests if finished
      updateProgressDisplay();
      if (document.querySelector('.tab.active')?.id === 'progress') {
        updateProgressReport();
      }

      // Wire key listeners
      document.getElementById('typingInput').addEventListener('keydown', (e) => {
        if (e.key === 'Backspace') {
          backspaceCount++;
          document.getElementById('backspaceCount').textContent = backspaceCount;
        }
      });
      document.getElementById('typingInput').addEventListener('input', () => {
        if (timerInterval) updateStats();
      });
      const timedEl = document.getElementById('timedTestInput');
      if (timedEl) {
        timedEl.addEventListener('input', () => {
          if (timedTest && timedTest.timer) updateTimedStats();
        });
      }
    });

    async function loadProgressFromFirestore(uid) {
      // Read all stage progress docs
      const coll = db.collection('users').doc(uid).collection('progress');
      const snap = await coll.get();

      // Reset
      userProgress.completedStages = {};

      snap.forEach(doc => {
        // doc.id format: lesson-{lessonId}-stage-{stageNumber}
        const id = doc.id;
        const m = id.match(/^lesson-(\d+)-stage-(\d+)$/);
        if (!m) return;
        const lessonId = parseInt(m[1], 10);
        const stageNumber = parseInt(m[2], 10); // 1-based
        const data = doc.data();
        if (data.status === 'completed') {
          if (!userProgress.completedStages[lessonId]) userProgress.completedStages[lessonId] = new Set();
          userProgress.completedStages[lessonId].add(stageNumber - 1); // store 0-based
        }
      });

      // Re-render lesson cards with fresh counts
      renderLessons();
    }

    async function loadRecentAttempts(uid) {
      // Pull the 20 most recent attempts
      const attemptsRef = db.collection('users').doc(uid).collection('attempts')
        .orderBy('timestamp', 'desc').limit(20);
      const snap = await attemptsRef.get();

      userProgress.history = snap.docs.map(d => d.data());
      // If you're on the progress tab, refresh the table
      // (We also refresh on switchTab('progress'))
    }

    /***************
     * UI RENDERING
     ***************/
    function renderLessons() {
      const grid = document.getElementById('lessonGrid');
      grid.innerHTML = '';

      lessons.forEach(lesson => {
        const totalStages = lesson.stages.length;
        const completedSet = userProgress.completedStages[lesson.id] || new Set();
        const completedCount = completedSet.size;
        const isComplete = completedCount === totalStages;

        const card = document.createElement('div');
        card.className = 'lesson-card' + (isComplete ? ' completed' : '');
        card.innerHTML = `
          <div class="status-icon">${isComplete ? '‚úÖ' : lesson.icon}</div>
          <h3>${lesson.title}</h3>
          <p>${lesson.description}</p>
          <p style="margin-top: 10px; font-weight: bold;">
            Progress: ${completedCount}/${totalStages} stages
          </p>
          <div style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 8px;">
            <div style="background: #4CAF50; height: 100%; border-radius: 4px; width: ${(completedCount/totalStages)*100}%"></div>
          </div>
        `;
        card.onclick = () => openLesson(lesson);
        grid.appendChild(card);
      });
    }

    function switchTab(tabName, tabElement) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      tabElement.classList.add('active');

      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');

      if (tabName === 'progress') updateProgressReport();
    }

    function updateProgressDisplay() {
      let totalStages = 0;
      let completedStagesTotal = 0;

      lessons.forEach(lesson => {
        totalStages += lesson.stages.length;
        const set = userProgress.completedStages[lesson.id] || new Set();
        completedStagesTotal += set.size;
      });

      document.getElementById('userProgress').textContent = `${completedStagesTotal}/${totalStages} Stages`;

      // Unlock tests if all complete
      const allLessonsComplete = lessons.every(lesson => {
        const set = userProgress.completedStages[lesson.id] || new Set();
        return set.size === lesson.stages.length;
      });
      if (allLessonsComplete) {
        const tab = document.getElementById('testsTab');
        tab.disabled = false;
        tab.textContent = '‚è±Ô∏è Timed Tests';
      }
    }

    function updateProgressReport() {
      if (userProgress.history.length > 0) {
        const avgWpm = Math.round(userProgress.history.reduce((s, h) => s + (h.wpm || 0), 0) / userProgress.history.length);
        const avgAcc = Math.round(userProgress.history.reduce((s, h) => s + (h.accuracy || 0), 0) / userProgress.history.length);
        const totalBackspaces = userProgress.history.reduce((s, h) => s + (h.backspaces || 0), 0);

        document.getElementById('avgWpm').textContent = avgWpm;
        document.getElementById('avgAccuracy').textContent = `${avgAcc}%`;
        document.getElementById('totalBackspaces').textContent = totalBackspaces;
      } else {
        document.getElementById('avgWpm').textContent = 0;
        document.getElementById('avgAccuracy').textContent = '0%';
        document.getElementById('totalBackspaces').textContent = 0;
      }

      let stagesComplete = 0;
      Object.values(userProgress.completedStages).forEach(set => { stagesComplete += set.size; });
      document.getElementById('stagesComplete').textContent = stagesComplete;

      // Table of recent activity
      const tbody = document.getElementById('historyTable');
      tbody.innerHTML = '';
      userProgress.history.forEach(entry => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding: 12px;">${new Date(entry.timestamp?.toDate ? entry.timestamp.toDate() : entry.timeMs || Date.now()).toLocaleString()}</td>
          <td style="padding: 12px;">${entry.lesson}</td>
          <td style="padding: 12px;">${entry.stage}</td>
          <td style="padding: 12px;">${entry.wpm}</td>
          <td style="padding: 12px;">${entry.accuracy}%</td>
          <td style="padding: 12px;">${entry.backspaces}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /***************
     * LESSON/STAGE FLOW
     ***************/
function openLesson(lesson) {
    currentLesson = lesson;
    const completedSet = userProgress.completedStages[lesson.id] || new Set();
    
    // If they've completed some stages, show a selection menu
    if (completedSet.size > 0) {
        showStageSelection(lesson, completedSet);
    } else {
        // Start at stage 1 for new lessons
        currentStage = 0;
        showPracticeModal();
    }
}

function showStageSelection(lesson, completedSet) {
    // Create a simple modal for stage selection
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>${lesson.title} - Select Stage</h2>
            <p>Choose a stage to practice:</p>
            <div style="margin: 20px 0;">
                ${lesson.stages.map((stage, index) => {
                    const isCompleted = completedSet.has(index);
                    const isLocked = index > 0 && !completedSet.has(index - 1);
                    const status = isCompleted ? '‚úÖ' : isLocked ? 'üîí' : '‚≠ï';
                    const disabled = isLocked ? 'disabled' : '';
                    
                    return `
                        <button class="btn btn-primary" style="display: block; width: 100%; margin: 10px 0; text-align: left;" 
                                onclick="selectStage(${index})" ${disabled}>
                            ${status} Stage ${index + 1}: ${stage.minWpm} WPM @ ${stage.minAccuracy}% 
                            ${isCompleted ? '(Completed - Click to retry)' : isLocked ? '(Locked)' : '(Available)'}
                        </button>
                    `;
                }).join('')}
            </div>
            <button class="btn btn-danger" onclick="this.parentElement.parentElement.remove()">Cancel</button>
        </div>
    `;
    document.body.appendChild(modal);
}

function selectStage(stageIndex) {
    currentStage = stageIndex;
    // Remove the selection modal
    document.querySelector('.modal.active').remove();
    showPracticeModal();
    document.getElementById('startBtn').disabled = false;
}

function showPracticeModal() {
    const stage = currentLesson.stages[currentStage];

    document.getElementById('modalTitle').textContent = currentLesson.title;
    document.getElementById('stageInfo').textContent = `Stage ${currentStage + 1} of ${currentLesson.stages.length} | Goal: ${stage.minWpm} WPM @ ${stage.minAccuracy}% accuracy`;
    document.getElementById('promptText').textContent = 'Press "Start" when you\'re ready to begin';

    // Reset UI
    const input = document.getElementById('typingInput');
    input.value = '';
    input.disabled = true;
    document.getElementById('currentWpm').textContent = '0';
    document.getElementById('currentAccuracy').textContent = '100%';
    document.getElementById('backspaceCount').textContent = '0';
    document.getElementById('elapsedTime').textContent = '0:00';
    backspaceCount = 0;
    
    // ALWAYS enable the start button
    document.getElementById('startBtn').disabled = false;

    document.getElementById('practiceModal').classList.add('active');
}

    function startStage() {
      const stage = currentLesson.stages[currentStage];
      const input = document.getElementById('typingInput');

      document.getElementById('promptText').textContent = stage.text;
      input.value = '';
      input.disabled = false;
      input.focus();
      document.getElementById('startBtn').disabled = true;

      startTime = new Date();
      backspaceCount = 0;
      timerInterval = setInterval(updateTimer, 100);
    }

    function updateTimer() {
      const elapsed = Math.floor((new Date() - startTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById('elapsedTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      updateStats();
    }

    function updateStats() {
      const typed = document.getElementById('typingInput').value;
      const prompt = currentLesson.stages[currentStage].text;
      if (typed.length === 0) return;

      // WPM (5 chars = 1 word)
      const timeInMinutes = (new Date() - startTime) / 60000;
      const wpm = Math.round((typed.length / 5) / timeInMinutes) || 0;

      // Accuracy
      let correct = 0;
      const compareLength = Math.min(typed.length, prompt.length);
      for (let i = 0; i < compareLength; i++) {
        if (typed[i] === prompt[i]) correct++;
      }
      const accuracy = compareLength > 0 ? Math.round((correct / compareLength) * 100) : 0;

      document.getElementById('currentWpm').textContent = wpm;
      document.getElementById('currentAccuracy').textContent = `${accuracy}%`;

      updatePromptDisplay(typed, prompt);

      if (typed.length === prompt.length) {
        completeStage(wpm, accuracy);
      }
    }

    function updatePromptDisplay(typed, prompt) {
      let html = '';
      for (let i = 0; i < prompt.length; i++) {
        if (i < typed.length) {
          html += (typed[i] === prompt[i])
            ? `<span class="correct">${prompt[i]}</span>`
            : `<span class="incorrect">${prompt[i]}</span>`;
        } else if (i === typed.length) {
          html += `<span class="current">${prompt[i]}</span>`;
        } else {
          html += prompt[i];
        }
      }
      document.getElementById('promptText').innerHTML = html;
    }

    function updateTimedPromptDisplay(typed, prompt) {
      let html = '';
      for (let i = 0; i < prompt.length; i++) {
        if (i < typed.length) {
          html += (typed[i] === prompt[i])
            ? `<span class="correct">${prompt[i]}</span>`
            : `<span class="incorrect">${prompt[i]}</span>`;
        } else if (i === typed.length) {
          html += `<span class="current">${prompt[i]}</span>`;
        } else {
          html += prompt[i];
        }
      }
      document.getElementById('timedTestPrompt').innerHTML = html;
    }

    async function completeStage(wpm, accuracy) {
      clearInterval(timerInterval);
      document.getElementById('typingInput').disabled = true;

      const stage = currentLesson.stages[currentStage];
      const passed = wpm >= stage.minWpm && accuracy >= stage.minAccuracy;

      // Save attempt & progress to Firestore
      await saveAttemptAndProgress({
        lessonId: currentLesson.id,
        lessonTitle: currentLesson.title,
        stageNumber: currentStage + 1, // 1-based
        wpm, accuracy, backspaces: backspaceCount, passed
      });

      // Update in-memory progress
      if (passed) {
        if (!userProgress.completedStages[currentLesson.id]) userProgress.completedStages[currentLesson.id] = new Set();
        userProgress.completedStages[currentLesson.id].add(currentStage);
      }

      // Reload recent attempts for the progress tab
      const uid = auth.currentUser.uid;
      await loadRecentAttempts(uid);

      // Update UI bits
      updateProgressDisplay();
      renderLessons();
      showResults(passed, wpm, accuracy);
    }

    function showResults(passed, wpm, accuracy) {
      const stage = currentLesson.stages[currentStage];
      document.getElementById('practiceModal').classList.remove('active');
      document.getElementById('resultsModal').classList.add('active');

      document.getElementById('resultTitle').textContent = passed ? 'üéâ Stage Complete!' : 'üí™ Keep Practicing!';
      document.getElementById('resultContent').innerHTML = `
        <div style="text-align: center;">
          <p style="font-size: 24px; margin: 10px 0;">
            <strong>${wpm}</strong> WPM | <strong>${accuracy}%</strong> Accuracy
          </p>
          <p style="color: #666; margin: 10px 0;">
            Backspaces used: ${backspaceCount}
          </p>
          <p style="margin: 20px 0;">
            Goal: ${stage.minWpm} WPM @ ${stage.minAccuracy}% accuracy
          </p>
          <p style="font-size: 18px; color: ${passed ? '#4CAF50' : '#ff9800'};">
            ${passed ? 'Great job! You passed this stage!' : 'Almost there! Try again to meet the goal.'}
          </p>
        </div>
      `;
    }

function nextStage() {
    // Check if user actually passed the current stage
    const completedSet = userProgress.completedStages[currentLesson.id] || new Set();
    
    if (!completedSet.has(currentStage)) {
        // They didn't pass this stage, don't let them advance
        alert('You must pass this stage before moving to the next one!');
        document.getElementById('resultsModal').classList.remove('active');
        showPracticeModal();
        document.getElementById('startBtn').disabled = false;
        return;
    }
    
    if (currentStage < currentLesson.stages.length - 1) {
        currentStage++;
        document.getElementById('resultsModal').classList.remove('active');
        showPracticeModal();
        document.getElementById('startBtn').disabled = false;
    } else {
        closeResults();
    }
}

    function retryStage() {
      document.getElementById('resultsModal').classList.remove('active');
      showPracticeModal();
      document.getElementById('startBtn').disabled = false;
    }

    function closeResults() {
      document.getElementById('resultsModal').classList.remove('active');
      renderLessons();
      updateProgressDisplay();
    }

    function closeModal() {
      clearInterval(timerInterval);
      document.getElementById('practiceModal').classList.remove('active');
      document.getElementById('startBtn').disabled = false;
    }

    /***************
     * FIRESTORE WRITES
     ***************/
    async function saveAttemptAndProgress({ lessonId, lessonTitle, stageNumber, wpm, accuracy, backspaces, passed }) {
      const u = auth.currentUser;
      if (!u) return;
      const userDoc = db.collection('users').doc(u.uid);

      // 1) Log attempt (for the "Recent Activity" table)
      await userDoc.collection('attempts').add({
        lessonId,
        lesson: lessonTitle,
        stage: stageNumber,
        wpm,
        accuracy,
        backspaces,
        passed,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // 2) Upsert stage progress doc with best scores & attempts count
      const progId = `lesson-${lessonId}-stage-${stageNumber}`; // deterministic
      const progRef = userDoc.collection('progress').doc(progId);

      await db.runTransaction(async (tx) => {
        const snap = await tx.get(progRef);
        const prev = snap.exists ? snap.data() : {};
        const bestWPM = Math.max(prev.bestWPM || 0, Number(wpm || 0));
        const bestAccuracy = Math.max(prev.bestAccuracy || 0, Number(accuracy || 0));
        const attempts = (prev.attempts || 0) + 1;

        tx.set(progRef, {
          lessonId,
          stageNumber,
          status: passed ? 'completed' : (prev.status || 'in_progress'),
          bestWPM,
          bestAccuracy,
          attempts,
          lastAttemptAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      });
    }

    /***************
     * EXPORT & SIGN-OUT
     ***************/
    async function exportProgress() {
      const u = auth.currentUser;
      if (!u) return;

      // Compute summary from current in-memory state
      const avgWpm = document.getElementById('avgWpm').textContent;
      const avgAcc = document.getElementById('avgAccuracy').textContent;
      const totalBackspaces = document.getElementById('totalBackspaces').textContent;
      const stagesComplete = document.getElementById('stagesComplete').textContent;

      const lines = userProgress.history.map(h =>
        `${(h.timestamp?.toDate ? h.timestamp.toDate() : new Date()).toLocaleString()} | ${h.lesson} | Stage ${h.stage} | ${h.wpm} WPM | ${h.accuracy}% | ${h.backspaces} backspaces`
      );

      const report = `TYPING PROGRESS REPORT
==============================
Student: ${auth.currentUser.email}
Course: KBD1100 - Computer Keyboarding Skills
Date: ${new Date().toLocaleDateString()}

SUMMARY
-------
Average WPM: ${avgWpm}
Average Accuracy: ${avgAcc}
Total Backspaces: ${totalBackspaces}
Stages Completed: ${stagesComplete}

RECENT ACTIVITY
---------------
${lines.join('\n')}
`;

      const blob = new Blob([report], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `KBD1100_Progress_${auth.currentUser.uid}_${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('Progress report downloaded!');
    }

    function signOut() {
      auth.signOut().then(() => location.href = 'index.html');
    }

    // Office Tools Functions
function showOfficeTool(tool) {
    document.getElementById('wordTool').style.display = tool === 'word' ? 'block' : 'none';
    document.getElementById('excelTool').style.display = tool === 'excel' ? 'block' : 'none';
}

// Word Functions
function formatText(command) {
    document.execCommand(command, false, null);
    document.getElementById('wordDocument').focus();
}

function insertTable() {
    const table = `
        <table border="1" style="width: 100%; border-collapse: collapse; margin: 10px 0;">
            <tr>
                <th style="padding: 8px;">Shift</th>
                <th style="padding: 8px;">Employee</th>
                <th style="padding: 8px;">Time</th>
                <th style="padding: 8px;">Position</th>
            </tr>
            <tr>
                <td style="padding: 8px;">Day</td>
                <td style="padding: 8px;">Edit here</td>
                <td style="padding: 8px;">07:00-15:00</td>
                <td style="padding: 8px;">Dispatcher</td>
            </tr>
        </table>`;
    document.execCommand('insertHTML', false, table);
}

function saveWordDoc() {
    const content = document.getElementById('wordDocument').innerHTML;
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dispatch-memo.html';
    a.click();
    alert('Document saved! In real Word, you would use File > Save or Ctrl+S');
}

// Excel Functions
function calculateFormulas() {
    document.querySelectorAll('.cell').forEach(cell => {
        const content = cell.textContent;
        if (content.startsWith('=')) {
            try {
                // Simple formula parser
                let formula = content.substring(1);
                
                // Handle SUM
                if (formula.includes('SUM')) {
                    const range = formula.match(/([A-Z]\d+):([A-Z]\d+)/);
                    if (range) {
                        // Calculate sum (simplified)
                        cell.textContent = '45'; // Placeholder
                    }
                }
                // Handle basic math
                else if (formula.includes('+')) {
                    const parts = formula.split('+');
                    let sum = 0;
                    parts.forEach(part => {
                        const cellRef = document.querySelector(`[data-cell="${part.trim()}"]`);
                        if (cellRef) {
                            sum += parseFloat(cellRef.textContent) || 0;
                        }
                    });
                    cell.textContent = sum;
                }
            } catch (e) {
                console.log('Formula error');
            }
        }
    });
}

function autoSum() {
    alert('Click a cell, then select the range you want to sum. In real Excel, this would insert =SUM() automatically.');
}

function saveExcel() {
    alert('Spreadsheet saved! In real Excel, you would use File > Save or Ctrl+S');
}

// Word count feature
function wordCount() {
    const content = document.getElementById('wordDocument').innerText;
    const words = content.trim().split(/\s+/).length;
    const chars = content.length;
    alert(`Word Count: ${words}\nCharacter Count: ${chars}\nTypical dispatch report: 150-300 words`);
}

// Find and Replace
function findReplace() {
    const find = prompt('Find what:');
    if (!find) return;
    const replace = prompt('Replace with:');
    if (replace === null) return;
    
    const doc = document.getElementById('wordDocument');
    const content = doc.innerHTML;
    const newContent = content.replaceAll(find, `<mark style="background: yellow;">${replace}</mark>`);
    doc.innerHTML = newContent;
    
    setTimeout(() => {
        doc.innerHTML = doc.innerHTML.replaceAll('<mark style="background: yellow;">', '').replaceAll('</mark>', '');
    }, 2000);
}

// Insert current date/time (useful for dispatch logs)
function insertDateTime() {
    const now = new Date();
    const dateTime = now.toLocaleString('en-CA');
    document.execCommand('insertText', false, dateTime);
}

// Text to uppercase (for codes/alerts)
function toUpperCase() {
    const selection = window.getSelection().toString();
    if (selection) {
        document.execCommand('insertText', false, selection.toUpperCase());
    }
}
    
// Initialize
document.getElementById('currentDate').textContent = new Date().toLocaleDateString();

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey) {
        switch(e.key) {
            case 'b': e.preventDefault(); formatText('bold'); break;
            case 'i': e.preventDefault(); formatText('italic'); break;
            case 's': e.preventDefault(); saveWordDoc(); break;
            case 'z': e.preventDefault(); document.execCommand('undo'); break;
        }
    }
});

// Calculate Excel formulas on blur
document.addEventListener('blur', function(e) {
    if (e.target.classList.contains('cell')) {
        calculateFormulas();
    }
}, true);

    // function to track when they complete office tasks
async function saveOfficeProgress(activity) {
    const u = auth.currentUser;
    if (!u) return;
    
    const userDoc = db.collection('users').doc(u.uid);
    await userDoc.collection('officeProgress').add({
        activity: activity, // e.g., "Saved Word document", "Created Excel formula"
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    alert('Progress saved!');
}

// Modify the save functions to track progress:
function saveWordDoc() {
    const content = document.getElementById('wordDocument').innerHTML;
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dispatch-memo.html';
    a.click();
    
    // Track this activity
    saveOfficeProgress('Completed Word document practice');
}

function saveExcel() {
    // Track this activity
    saveOfficeProgress('Completed Excel spreadsheet practice');
    alert('Spreadsheet practice completed!');
}

function addRow() {
    const table = document.getElementById('spreadsheet').getElementsByTagName('tbody')[0];
    const rowCount = table.rows.length + 1;
    const newRow = table.insertRow();
    
    // Row number cell
    const cellNum = newRow.insertCell(0);
    cellNum.style = "background: #e0e0e0; padding: 5px; border: 1px solid #999;";
    cellNum.textContent = rowCount;
    
    // Data cells A-E
    for (let i = 0; i < 5; i++) {
        const cell = newRow.insertCell(i + 1);
        cell.contentEditable = true;
        cell.className = "cell";
        cell.dataset.cell = String.fromCharCode(65 + i) + rowCount;
        cell.style = "padding: 5px; border: 1px solid #ccc;";
    }
    alert('Row added!');
}

function addColumn() {
    alert('In a real spreadsheet, this would add a new column. For this practice, we have columns A-E available.');
}

function autoSum() {
    const selection = prompt('Enter the range to sum (e.g., B2:B5):');
    if (selection) {
        alert(`In Excel, this would create =SUM(${selection}). Type this formula in a cell to practice!`);
    }
}

function calculateAverage() {
    const selection = prompt('Enter the range to average (e.g., C2:C5):');
    if (selection) {
        alert(`In Excel, this would create =AVERAGE(${selection}). Type this formula in a cell to practice!`);
    }
}

function formatCells() {
    alert('Select cells and use these shortcuts:\nCtrl+B for Bold\nCtrl+I for Italic\nIn real Excel, you would right-click and choose Format Cells');
}

function conditionalFormat() {
    document.querySelectorAll('.cell').forEach(cell => {
        const value = parseFloat(cell.textContent);
        if (!isNaN(value)) {
            if (value > 40) {
                cell.style.backgroundColor = '#ffcccc'; // Red for overtime
            } else if (value === 40) {
                cell.style.backgroundColor = '#ccffcc'; // Green for normal
            } else if (value < 40 && value > 0) {
                cell.style.backgroundColor = '#ffffcc'; // Yellow for under
            }
        }
    });
    alert('Cells formatted! Red = Overtime, Green = Normal hours, Yellow = Under hours');
}

// Sort column
function sortColumn() {
    const col = prompt('Which column to sort? (A, B, C, D, or E)');
    if (!col || !'ABCDE'.includes(col.toUpperCase())) return;
    
    alert(`In Excel, this would sort column ${col}. Click Data > Sort to practice!`);
}

// Quick fill series (like Excel's drag fill)
function fillSeries() {
    const start = prompt('Enter starting value:');
    const increment = prompt('Enter increment (e.g., 1 for 1,2,3...):');
    
    if (start && increment) {
        let val = parseFloat(start);
        const inc = parseFloat(increment);
        
        document.querySelectorAll('.cell[data-cell^="A"]').forEach((cell, index) => {
            if (index > 0 && index < 6) {
                cell.textContent = val;
                val += inc;
            }
        });
    }
}

const practiceTasks = {
    word: [
        {
            title: "Incident Report",
            instruction: "Create an incident report with: Date/Time, Location, Units Responding, Description",
            check: "Does your report include all required fields?"
        },
        {
            title: "Shift Schedule",
            instruction: "Create a table showing: Employee Name, Shift Time, Position, Badge Number",
            check: "Is your table properly formatted with headers?"
        },
        {
            title: "Emergency Bulletin",
            instruction: "Format an urgent notice: Use CAPS for 'URGENT', bold the main message, add timestamp",
            check: "Is the urgency clear at first glance?"
        }
    ],
    excel: [
        {
            title: "Overtime Calculator",
            instruction: "Enter hours for 5 employees. Use =B2+C2 to calculate total hours",
            check: "Do your formulas calculate correctly?"
        },
        {
            title: "Shift Coverage",
            instruction: "Create a weekly schedule grid showing who covers each shift",
            check: "Can you see at a glance who works when?"
        },
        {
            title: "Response Time Tracker",
            instruction: "Track call times and use =AVERAGE to find average response time",
            check: "What's the average response time?"
        }
    ]
};

function showPracticeTask(type) {
    const tasks = practiceTasks[type];
    const task = tasks[Math.floor(Math.random() * tasks.length)];
    
    const taskDiv = document.createElement('div');
    taskDiv.style = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #fff3cd;
        border: 2px solid #ffc107;
        padding: 20px;
        border-radius: 10px;
        max-width: 300px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
    `;
    
    taskDiv.innerHTML = `
        <h4 style="margin-top: 0;">üìã Practice Task</h4>
        <strong>${task.title}</strong>
        <p>${task.instruction}</p>
        <p style="font-style: italic;">${task.check}</p>
        <button onclick="this.parentElement.remove()">Close</button>
        <button onclick="completePracticeTask('${type}', '${task.title}')">Mark Complete</button>
    `;
    
    document.body.appendChild(taskDiv);
}

function completePracticeTask(type, title) {
    saveOfficeProgress(`Completed ${type} task: ${title}`);
    document.querySelector('[onclick*="completePracticeTask"]').parentElement.remove();
}

// Timed Test System
let timedTest = {
    duration: 0,
    timeLeft: 0,
    timer: null,
    startTime: null,
    testType: 0
};

// Test text library - mix of dispatch-relevant content
const testTexts = [
    "Emergency dispatchers play a crucial role in public safety. They are the first point of contact for people calling for help. Quick thinking and accurate typing are essential skills for this position. Every call must be handled with professionalism and care.",
    
    "When receiving an emergency call, dispatchers must quickly gather essential information including the nature of the emergency, the exact location, and any immediate dangers. This information is then relayed to the appropriate emergency services.",
    
    "The computer aided dispatch system helps emergency operators track and coordinate resources efficiently. Units are dispatched based on proximity and availability. Response times are carefully monitored to ensure optimal service delivery.",
    
    "Professional communication is vital in emergency services. Clear and concise messages prevent misunderstandings that could delay response times. Dispatchers must remain calm even in the most stressful situations.",
    
    "Shift schedules in dispatch centers ensure twenty four hour coverage seven days a week. Staff rotations are carefully planned to maintain alertness and prevent fatigue. Backup dispatchers are always available for high volume periods."
];

function initTimedTest(minutes) {
   // Reset any previous timer/state
  if (timedTest.timer) clearInterval(timedTest.timer);
  timedTest = { duration: minutes * 60, timeLeft: 0, timer: null, startTime: null, testType: minutes };
    
    // Show test interface
    document.getElementById('timedTestArea').style.display = 'block';
    document.getElementById('timedTestTitle').textContent = `${minutes} Minute Typing Test`;
    
    // Select random text(s) based on duration
    let testContent = "";
    const textCount = minutes; // Use more texts for longer tests
    for (let i = 0; i < textCount; i++) {
        testContent += testTexts[Math.floor(Math.random() * testTexts.length)] + " ";
    }
    
    document.getElementById('timedTestPrompt').textContent = testContent;
    document.getElementById('timedTestInput').value = '';
    document.getElementById('timeRemaining').textContent = `${minutes}:00`;
    document.getElementById('startTimedBtn').disabled = false;
}

function startTimedTest() {
  // Clear any old timer just in case
  if (timedTest.timer) clearInterval(timedTest.timer);

  const input = document.getElementById('timedTestInput');
  input.value = '';                 // <- make sure nothing lingers
  input.disabled = false;
  input.focus();

  document.getElementById('timedWpm').textContent = '0';
  document.getElementById('timedAccuracy').textContent = '100%';

  document.getElementById('startTimedBtn').disabled = true;

  timedTest.startTime = new Date();
  timedTest.timeLeft = timedTest.duration;

  // Kick off an immediate stats render so the first "current" caret shows
  updateTimedStats();

  // Start countdown
  timedTest.timer = setInterval(() => {
    timedTest.timeLeft--;
    const minutes = Math.floor(timedTest.timeLeft / 60);
    const seconds = timedTest.timeLeft % 60;
    document.getElementById('timeRemaining').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

    updateTimedStats();

    if (timedTest.timeLeft <= 0) finishTimedTest();
  }, 1000);
}

function maybeExtendTimedPrompt(currentTypedLen) {
  const promptEl = document.getElementById('timedTestPrompt');
  // Work from the underlying text (strip tags if any)
  const temp = document.createElement('div');
  temp.innerHTML = promptEl.innerHTML;
  const currentPrompt = temp.textContent || temp.innerText || '';

  // If they are within 80 chars of the end, append another random test text
  if (currentPrompt.length - currentTypedLen < 80) {
    const extra = testTexts[Math.floor(Math.random() * testTexts.length)] + ' ';
    const extended = currentPrompt + extra;
    // Re-render highlighted view against the new extended text
    updateTimedPromptDisplay(document.getElementById('timedTestInput').value, extended);
  }
}
    
function updateTimedStats() {
    const typed = document.getElementById('timedTestInput').value;
    const original = document.getElementById('timedTestPrompt').textContent;
    
    if (typed.length === 0) return;
    
    // Calculate WPM
    const timeElapsed = (new Date() - timedTest.startTime) / 60000; // in minutes
    const words = typed.trim().split(/\s+/).length;
    const wpm = Math.round(words / timeElapsed) || 0;
    
    // Calculate accuracy
    let correct = 0;
    const checkLength = Math.min(typed.length, original.length);
    for (let i = 0; i < checkLength; i++) {
        if (typed[i] === original[i]) correct++;
    }
    const accuracy = Math.round((correct / checkLength) * 100) || 100;
    
    document.getElementById('timedWpm').textContent = wpm;
    document.getElementById('timedAccuracy').textContent = accuracy + '%';

    // Live highlight + on-demand extension
    updateTimedPromptDisplay(typed, original);
    maybeExtendTimedPrompt(typed.length);
}

function finishTimedTest() {
    clearInterval(timedTest.timer);
    timedTest.timer = null;
    document.getElementById('timedTestInput').disabled = true;
    
    const wpm = document.getElementById('timedWpm').textContent;
    const accuracy = document.getElementById('timedAccuracy').textContent;
    
    // Save result
    const result = {
        date: new Date().toLocaleDateString(),
        time: new Date().toLocaleTimeString(),
        duration: timedTest.testType,
        wpm: parseInt(wpm),
        accuracy: parseInt(accuracy),
        forGrade: timedTest.testType === 3
    };
    
    // Save to Firebase
    if (auth.currentUser) {
        db.collection('users').doc(auth.currentUser.uid)
          .collection('timedTests').add({
            ...result,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
    
    // Show result
    alert(`Test Complete!\nWPM: ${wpm}\nAccuracy: ${accuracy}\n${result.forGrade ? 'This test counts toward your grade.' : 'Practice test - not graded.'}`);
    
    // Add to history table
    addToTestHistory(result);
    
    // Reset
    document.getElementById('startTimedBtn').disabled = false;
}

function cancelTimedTest() {
  if (timedTest.timer) clearInterval(timedTest.timer);
  timedTest.timer = null;

  document.getElementById('timedTestArea').style.display = 'none';

  const input = document.getElementById('timedTestInput');
  input.disabled = true;
  input.value = '';

  document.getElementById('timedWpm').textContent = '0';
  document.getElementById('timedAccuracy').textContent = '100%';
}

function addToTestHistory(result) {
    document.getElementById('testHistory').style.display = 'block';
    const tbody = document.getElementById('testHistoryBody');
    const row = tbody.insertRow(0); // Add at top
    
    row.innerHTML = `
        <td style="padding: 10px;">${result.date} ${result.time}</td>
        <td style="padding: 10px;">${result.duration} min</td>
        <td style="padding: 10px;">${result.wpm}</td>
        <td style="padding: 10px;">${result.accuracy}%</td>
        <td style="padding: 10px;">${result.forGrade ? '‚≠ê Graded' : 'Practice'}</td>
    `;
}
  </script>
</body>
</html>






