<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBD1100 - Typing Practice | Cambrian College</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="app-header">
            <div class="app-title">
                <h1>‚å®Ô∏è KBD1100 - Computer Keyboarding Skills</h1>
                <p>Cambrian College | Instructor: Charles Mapletoft</p>
            </div>
            <div class="user-info">
                <span>üë§ <strong id="userName">Student Name</strong></span>
                <span>üìä <strong id="userProgress">0/12 Complete</strong></span>
                <button class="logout-btn" onclick="logout()">Sign Out</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab active" onclick="switchTab('lessons', this)">üìö Skill Building</button>
            <button class="tab" onclick="switchTab('progress', this)">üìä My Progress</button>
            <button class="tab" onclick="switchTab('tests', this)" id="testsTab" disabled>üîí Timed Tests</button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            
            <!-- Lessons Tab -->
            <div id="lessons" class="tab-content active">
                <h2>Skill Building Lessons</h2>
                <p>Complete all stages in each skill to unlock the next level. Focus on accuracy first, speed will follow!</p>
                
                <div class="lesson-grid" id="lessonGrid">
                    <!-- Lessons will be generated here by JavaScript -->
                </div>
            </div>

            <!-- Progress Tab -->
            <div id="progress" class="tab-content">
                <h2>Your Progress Report</h2>
                
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">Average WPM</div>
                        <div class="stat-value" id="avgWpm">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Average Accuracy</div>
                        <div class="stat-value" id="avgAccuracy">0%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Total Backspaces</div>
                        <div class="stat-value" id="totalBackspaces">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Stages Complete</div>
                        <div class="stat-value" id="stagesComplete">0</div>
                    </div>
                </div>

                <h3 style="margin-top: 30px;">Recent Activity</h3>
                <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th style="padding: 12px; text-align: left;">Date</th>
                            <th style="padding: 12px; text-align: left;">Lesson</th>
                            <th style="padding: 12px; text-align: left;">Stage</th>
                            <th style="padding: 12px; text-align: left;">WPM</th>
                            <th style="padding: 12px; text-align: left;">Accuracy</th>
                            <th style="padding: 12px; text-align: left;">Backspaces</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        <!-- History will be populated here -->
                    </tbody>
                </table>

                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="exportProgress()">üì• Export Report</button>
                </div>
            </div>

            <!-- Tests Tab (Locked Initially) -->
            <div id="tests" class="tab-content">
                <h2>üîí Timed Tests - Locked</h2>
                <p>Complete all skill building lessons to unlock timed tests!</p>
            </div>
        </div>
    </div>

    <!-- Stage Practice Modal -->
    <div class="modal" id="practiceModal">
        <div class="modal-content" style="max-width: 900px;">
            <h2 id="modalTitle">Lesson Title</h2>
            <p id="stageInfo" style="margin-bottom: 20px; color: #666;">Stage 1 of 5</p>
            
            <div class="typing-area">
                <div class="prompt-text" id="promptText">
                    Press "Start" when you're ready to begin
                </div>
                
                <input type="text" class="typing-input" id="typingInput" 
                       placeholder="Click Start, then type here..." disabled>
                
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">WPM</div>
                        <div class="stat-value" id="currentWpm">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Accuracy</div>
                        <div class="stat-value" id="currentAccuracy">100%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Backspaces</div>
                        <div class="stat-value" id="backspaceCount">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Time</div>
                        <div class="stat-value" id="elapsedTime">0:00</div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-success" id="startBtn" onclick="startStage()">‚ñ∂Ô∏è Start</button>
                    <button class="btn btn-danger" onclick="closeModal()">‚úñÔ∏è Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal" id="resultsModal">
        <div class="modal-content">
            <h2 id="resultTitle">Stage Complete!</h2>
            <div id="resultContent" style="margin: 20px 0;">
                <!-- Results will be shown here -->
            </div>
            <div class="control-buttons">
                <button class="btn btn-primary" onclick="nextStage()">Next Stage ‚û°Ô∏è</button>
                <button class="btn btn-success" onclick="retryStage()">üîÑ Retry</button>
                <button class="btn btn-danger" onclick="closeResults()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Lesson Definitions with Multiple Stages
        const lessons = [
            {
                id: 1,
                title: "Home Row",
                icon: "üè†",
                description: "Master the foundation: ASDF JKL;",
                stages: [
                    { text: "fff jjj fff jjj ff jj ff jj fjfj fjfj", minWpm: 20, minAccuracy: 90 },
                    { text: "ddd kkk ddd kkk dd kk dd kk dkdk dkdk", minWpm: 25, minAccuracy: 90 },
                    { text: "aaa ;;; aaa ;;; aa ;; aa ;; a;a; a;a;", minWpm: 25, minAccuracy: 90 },
                    { text: "asdf jkl; asdf jkl; fdsa ;lkj fdsa ;lkj", minWpm: 30, minAccuracy: 92 },
                    { text: "sad flask jak lads fall salad flask dad", minWpm: 35, minAccuracy: 95 }
                ]
            },
            {
                id: 2,
                title: "Top Row",
                icon: "‚¨ÜÔ∏è",
                description: "Reach for QWERT YUIOP",
                stages: [
                    { text: "qqq ppp qqq ppp qq pp qq pp qpqp qpqp", minWpm: 20, minAccuracy: 90 },
                    { text: "www ooo www ooo ww oo ww oo wowo wowo", minWpm: 25, minAccuracy: 90 },
                    { text: "eee iii eee iii ee ii ee ii eiei eiei", minWpm: 25, minAccuracy: 90 },
                    { text: "qwert yuiop qwert yuiop werty uiop qwe", minWpm: 30, minAccuracy: 92 },
                    { text: "power query write poetry tower quite proper", minWpm: 35, minAccuracy: 95 }
                ]
            },
            {
                id: 3,
                title: "Bottom Row",
                icon: "‚¨áÔ∏è",
                description: "Complete the alphabet: ZXCVB NM",
                stages: [
                    { text: "zzz mmm zzz mmm zz mm zz mm zmzm zmzm", minWpm: 20, minAccuracy: 90 },
                    { text: "xxx nnn xxx nnn xx nn xx nn xnxn xnxn", minWpm: 25, minAccuracy: 90 },
                    { text: "ccc vvv bbb ccc vvv bbb cv vb cv vb", minWpm: 25, minAccuracy: 90 },
                    { text: "zxcvb nm,. zxcvb nm,. xcvb nm,. zxc", minWpm: 30, minAccuracy: 92 },
                    { text: "zebra venom combat maximum bronze exam", minWpm: 35, minAccuracy: 95 }
                ]
            },
            {
                id: 4,
                title: "Numbers",
                icon: "üî¢",
                description: "Master the number row: 1234567890",
                stages: [
                    { text: "111 222 333 111 222 333 123 123 123", minWpm: 20, minAccuracy: 90 },
                    { text: "444 555 666 444 555 666 456 456 456", minWpm: 25, minAccuracy: 90 },
                    { text: "777 888 999 000 777 888 999 000 7890", minWpm: 25, minAccuracy: 90 },
                    { text: "1234567890 0987654321 1357924680 2468", minWpm: 30, minAccuracy: 92 },
                    { text: "My phone is 555-1234 and zip is 90210", minWpm: 35, minAccuracy: 95 }
                ]
            },
            {
                id: 5,
                title: "Shift Keys",
                icon: "‚¨ÜÔ∏è",
                description: "Capital letters with Shift",
                stages: [
                    { text: "Aa Bb Cc Dd Ee Ff Gg Hh Ii Jj Kk", minWpm: 20, minAccuracy: 85 },
                    { text: "The Quick Fox The Quick Fox The", minWpm: 25, minAccuracy: 88 },
                    { text: "Hello World Hello World Hello World", minWpm: 30, minAccuracy: 90 },
                    { text: "John Smith Lives In New York City Today", minWpm: 35, minAccuracy: 92 },
                    { text: "The Quick Brown Fox Jumps Over The Lazy Dog", minWpm: 40, minAccuracy: 95 }
                ]
            },
            {
                id: 6,
                title: "Caps Lock",
                icon: "üî†",
                description: "Toggle CAPS LOCK efficiently",
                stages: [
                    { text: "ABC DEF GHI JKL MNO PQR STU VWX YZ", minWpm: 20, minAccuracy: 85 },
                    { text: "HELLO WORLD HELLO WORLD HELLO", minWpm: 25, minAccuracy: 88 },
                    { text: "TYPE THIS IN ALL CAPS PLEASE OK", minWpm: 30, minAccuracy: 90 },
                    { text: "WARNING: DO NOT ENTER THIS AREA", minWpm: 35, minAccuracy: 92 },
                    { text: "IMPORTANT NOTICE: MEETING CANCELLED TODAY", minWpm: 40, minAccuracy: 95 }
                ]
            },
            {
                id: 7,
                title: "Symbols Level 1",
                icon: "‚ö°",
                description: "Basic punctuation and symbols",
                stages: [
                    { text: "... ,,, ... ,,, ... ,,, .,., .,.,", minWpm: 20, minAccuracy: 85 },
                    { text: "!!! ??? !!! ??? !?!? !?!? !? !? !?", minWpm: 20, minAccuracy: 85 },
                    { text: ": ; : ; : ; :; :; :; ';' ';' ';'", minWpm: 25, minAccuracy: 88 },
                    { text: "Hello! How are you? I'm fine, thanks.", minWpm: 30, minAccuracy: 90 },
                    { text: "Wait! Don't go; I'm not done yet: okay?", minWpm: 35, minAccuracy: 92 }
                ]
            },
            {
                id: 8,
                title: "Symbols Level 2",
                icon: "üíé",
                description: "Advanced symbols and special characters",
                stages: [
                    { text: "@@@ ### $$$ %%% @@@ ### $$$ %%%", minWpm: 20, minAccuracy: 85 },
                    { text: "((( ))) [[[ ]]] {{{ }}} ((( )))", minWpm: 20, minAccuracy: 85 },
                    { text: "+++ === --- ___ +++ === --- ___", minWpm: 25, minAccuracy: 88 },
                    { text: "user@email.com costs $99.99 (50% off)", minWpm: 30, minAccuracy: 90 },
                    { text: "Call (555) 123-4567 or visit www.site.com", minWpm: 35, minAccuracy: 92 }
                ]
            },
            {
                id: 9,
                title: "Mixed Practice",
                icon: "üéØ",
                description: "Combine all skills",
                stages: [
                    { text: "abc 123 ABC !@# abc 123 ABC !@#", minWpm: 25, minAccuracy: 85 },
                    { text: "The price is $50.00 (plus tax).", minWpm: 30, minAccuracy: 88 },
                    { text: "Email me at: john@example.com NOW!", minWpm: 35, minAccuracy: 90 },
                    { text: "Meeting at 3:30 PM in Room #204-B", minWpm: 40, minAccuracy: 92 },
                    { text: "Save 25% TODAY! Visit www.sale.com or call (800) 555-DEAL", minWpm: 45, minAccuracy: 95 }
                ]
            },
            {
                id: 10,
                title: "Speed Builder",
                icon: "üöÄ",
                description: "Common words for speed",
                stages: [
                    { text: "the the the and and and for for", minWpm: 40, minAccuracy: 95 },
                    { text: "that with have this will your from", minWpm: 45, minAccuracy: 95 },
                    { text: "they what about which their would", minWpm: 50, minAccuracy: 95 },
                    { text: "the quick brown fox jumps over the lazy", minWpm: 55, minAccuracy: 95 },
                    { text: "pack my box with five dozen liquor jugs now", minWpm: 60, minAccuracy: 95 }
                ]
            },
            {
                id: 11,
                title: "Accuracy Focus",
                icon: "üé™",
                description: "Precision over speed",
                stages: [
                    { text: "Slow and steady wins the race.", minWpm: 20, minAccuracy: 100 },
                    { text: "Precision is the key to success.", minWpm: 25, minAccuracy: 98 },
                    { text: "Every keystroke must be perfect.", minWpm: 30, minAccuracy: 98 },
                    { text: "Accuracy first, then speed will follow.", minWpm: 35, minAccuracy: 98 },
                    { text: "Perfect practice makes perfect performance.", minWpm: 40, minAccuracy: 100 }
                ]
            },
            {
                id: 12,
                title: "Numeric Keypad",
                icon: "üîü",
                description: "Master the number pad",
                stages: [
                    { text: "789 789 789 456 456 456 123 123", minWpm: 25, minAccuracy: 90 },
                    { text: "741 852 963 741 852 963 741 852", minWpm: 30, minAccuracy: 90 },
                    { text: "147 258 369 147 258 369 147 258", minWpm: 35, minAccuracy: 92 },
                    { text: "7410 8520 9630 1470 2580 3690", minWpm: 40, minAccuracy: 95 },
                    { text: "98765 43210 13579 24680 11235", minWpm: 45, minAccuracy: 95 }
                ]
            }
        ];

        // Global variables
        let currentUser = null;
        let currentLesson = null;
        let currentStage = 0;
        let startTime = null;
        let timerInterval = null;
        let backspaceCount = 0;
        let userProgress = {
            completedStages: {}, // {lessonId: [stageNumbers]}
            history: []
        };

        // Load user data on page load
        window.onload = function() {
            loadUserData();
            renderLessons();
            updateProgressDisplay();
        };

        function loadUserData() {
            // Get user from sessionStorage (set by login page)
            const userData = sessionStorage.getItem('currentUser');
            if (!userData) {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = JSON.parse(userData);
            document.getElementById('userName').textContent = 
                `${currentUser.firstName} ${currentUser.lastName}`;
            
            // Load progress from localStorage
            const savedProgress = localStorage.getItem(`progress_${currentUser.username}`);
            if (savedProgress) {
                userProgress = JSON.parse(savedProgress);
            }
        }

        function renderLessons() {
            const grid = document.getElementById('lessonGrid');
            grid.innerHTML = '';
            
            lessons.forEach(lesson => {
                const card = document.createElement('div');
                card.className = 'lesson-card';
                
                const completedStages = userProgress.completedStages[lesson.id] || [];
                const totalStages = lesson.stages.length;
                const isComplete = completedStages.length === totalStages;
                
                if (isComplete) {
                    card.className += ' completed';
                }
                
                card.innerHTML = `
                    <div class="status-icon">${isComplete ? '‚úÖ' : lesson.icon}</div>
                    <h3>${lesson.title}</h3>
                    <p>${lesson.description}</p>
                    <p style="margin-top: 10px; font-weight: bold;">
                        Progress: ${completedStages.length}/${totalStages} stages
                    </p>
                    <div style="background: #e0e0e0; height: 8px; border-radius: 4px; margin-top: 8px;">
                        <div style="background: #4CAF50; height: 100%; border-radius: 4px; width: ${(completedStages.length/totalStages)*100}%"></div>
                    </div>
                `;
                
                card.onclick = () => openLesson(lesson);
                grid.appendChild(card);
            });
        }

        function openLesson(lesson) {
            currentLesson = lesson;
            const completedStages = userProgress.completedStages[lesson.id] || [];
            
            // Find next uncompleted stage or start at stage 1
            currentStage = 0;
            for (let i = 0; i < lesson.stages.length; i++) {
                if (!completedStages.includes(i)) {
                    currentStage = i;
                    break;
                }
            }
            
            // If all stages complete, start at last stage
            if (currentStage === 0 && completedStages.length === lesson.stages.length) {
                currentStage = lesson.stages.length - 1;
            }
            
            showPracticeModal();
        }

        function showPracticeModal() {
            const modal = document.getElementById('practiceModal');
            const stage = currentLesson.stages[currentStage];
            
            document.getElementById('modalTitle').textContent = currentLesson.title;
            document.getElementById('stageInfo').textContent = 
                `Stage ${currentStage + 1} of ${currentLesson.stages.length} | Goal: ${stage.minWpm} WPM @ ${stage.minAccuracy}% accuracy`;
            document.getElementById('promptText').textContent = 'Press "Start" when you\'re ready to begin';
            
            // Reset everything
            document.getElementById('typingInput').value = '';
            document.getElementById('typingInput').disabled = true;
            document.getElementById('currentWpm').textContent = '0';
            document.getElementById('currentAccuracy').textContent = '100%';
            document.getElementById('backspaceCount').textContent = '0';
            document.getElementById('elapsedTime').textContent = '0:00';
            backspaceCount = 0;
            
            modal.classList.add('active');
        }

        function startStage() {
            const stage = currentLesson.stages[currentStage];
            document.getElementById('promptText').textContent = stage.text;
            document.getElementById('typingInput').value = '';
            document.getElementById('typingInput').disabled = false;
            document.getElementById('typingInput').focus();
            document.getElementById('startBtn').disabled = true;
            
            startTime = new Date();
            backspaceCount = 0;
            
            // Start timer
            timerInterval = setInterval(updateTimer, 100);
        }

        function updateTimer() {
            const elapsed = Math.floor((new Date() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('elapsedTime').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            updateStats();
        }

        function updateStats() {
            const typed = document.getElementById('typingInput').value;
            const prompt = currentLesson.stages[currentStage].text;
            
            if (typed.length === 0) return;
            
            // Calculate WPM (count every 5 characters as a word, standard typing test method)
            const timeInMinutes = (new Date() - startTime) / 60000;
            const characterCount = typed.length;
            const wpm = Math.round((characterCount / 5) / timeInMinutes) || 0;
            
            // Calculate accuracy properly
            let correct = 0;
            const compareLength = Math.min(typed.length, prompt.length);
            
            for (let i = 0; i < compareLength; i++) {
                if (typed[i] === prompt[i]) correct++;
            }
            
            // Accuracy based on what should have been typed so far
            const accuracy = compareLength > 0 ? Math.round((correct / compareLength) * 100) : 0;
            
            // Update display
            document.getElementById('currentWpm').textContent = wpm;
            document.getElementById('currentAccuracy').textContent = accuracy + '%';
            
            // Update prompt display with color coding
            updatePromptDisplay(typed, prompt);
            
            // Check if complete
            if (typed.length === prompt.length) {
                completeStage(wpm, accuracy);
            }
        }

    

        function updatePromptDisplay(typed, prompt) {
            let html = '';
            for (let i = 0; i < prompt.length; i++) {
                if (i < typed.length) {
                    if (typed[i] === prompt[i]) {
                        html += `<span class="correct">${prompt[i]}</span>`;
                    } else {
                        html += `<span class="incorrect">${prompt[i]}</span>`;
                    }
                } else if (i === typed.length) {
                    html += `<span class="current">${prompt[i]}</span>`;
                } else {
                    html += prompt[i];
                }
            }
            document.getElementById('promptText').innerHTML = html;
        }

        function completeStage(wpm, accuracy) {
            clearInterval(timerInterval);
            document.getElementById('typingInput').disabled = true;
            
            const stage = currentLesson.stages[currentStage];
            const passed = wpm >= stage.minWpm && accuracy >= stage.minAccuracy;
            
            // Save to history
            const result = {
                date: new Date().toLocaleDateString(),
                lesson: currentLesson.title,
                stage: currentStage + 1,
                wpm: wpm,
                accuracy: accuracy,
                backspaces: backspaceCount
            };
            userProgress.history.unshift(result);
            if (userProgress.history.length > 50) userProgress.history.pop();
            
            // Mark as complete if passed
            if (passed) {
                if (!userProgress.completedStages[currentLesson.id]) {
                    userProgress.completedStages[currentLesson.id] = [];
                }
                if (!userProgress.completedStages[currentLesson.id].includes(currentStage)) {
                    userProgress.completedStages[currentLesson.id].push(currentStage);
                }
            }
            
            saveProgress();
            showResults(passed, wpm, accuracy);
        }

        function showResults(passed, wpm, accuracy) {
            const stage = currentLesson.stages[currentStage];
            document.getElementById('practiceModal').classList.remove('active');
            document.getElementById('resultsModal').classList.add('active');
            
            document.getElementById('resultTitle').textContent = passed ? 'üéâ Stage Complete!' : 'üí™ Keep Practicing!';
            document.getElementById('resultContent').innerHTML = `
                <div style="text-align: center;">
                    <p style="font-size: 24px; margin: 10px 0;">
                        <strong>${wpm}</strong> WPM | <strong>${accuracy}%</strong> Accuracy
                    </p>
                    <p style="color: #666; margin: 10px 0;">
                        Backspaces used: ${backspaceCount}
                    </p>
                    <p style="margin: 20px 0;">
                        Goal: ${stage.minWpm} WPM @ ${stage.minAccuracy}% accuracy
                    </p>
                    <p style="font-size: 18px; color: ${passed ? '#4CAF50' : '#ff9800'};">
                        ${passed ? 'Great job! You passed this stage!' : 'Almost there! Try again to meet the goal.'}
                    </p>
                </div>
            `;
            renderLessons();
        }

        function nextStage() {
            if (currentStage < currentLesson.stages.length - 1) {
                currentStage++;
                document.getElementById('resultsModal').classList.remove('active');
                showPracticeModal();
            } else {
                closeResults();
            }
        }

        function retryStage() {
            document.getElementById('resultsModal').classList.remove('active');
            showPracticeModal();
        }

        function closeResults() {
            document.getElementById('resultsModal').classList.remove('active');
            renderLessons();
            updateProgressDisplay();
        }

        function closeModal() {
            clearInterval(timerInterval);
            document.getElementById('practiceModal').classList.remove('active');
            document.getElementById('startBtn').disabled = false;
        }

        function switchTab(tabName, tabElement) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
            
            // Show correct content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'progress') {
                updateProgressReport();
            }
        }

        function updateProgressDisplay() {
            let totalStages = 0;
            let completedStages = 0;
            
            lessons.forEach(lesson => {
                totalStages += lesson.stages.length;
                completedStages += (userProgress.completedStages[lesson.id] || []).length;
            });
            
            document.getElementById('userProgress').textContent = 
                `${completedStages}/${totalStages} Stages`;
            
            // Check if all lessons complete to unlock tests
            const allLessonsComplete = lessons.every(lesson => {
                const completed = userProgress.completedStages[lesson.id] || [];
                return completed.length === lesson.stages.length;
            });
            
            if (allLessonsComplete) {
                document.getElementById('testsTab').disabled = false;
                document.getElementById('testsTab').textContent = '‚è±Ô∏è Timed Tests';
            }
        }

        function updateProgressReport() {
            // Calculate averages
            if (userProgress.history.length > 0) {
                const avgWpm = Math.round(
                    userProgress.history.reduce((sum, h) => sum + h.wpm, 0) / userProgress.history.length
                );
                const avgAccuracy = Math.round(
                    userProgress.history.reduce((sum, h) => sum + h.accuracy, 0) / userProgress.history.length
                );
                const totalBackspaces = userProgress.history.reduce((sum, h) => sum + h.backspaces, 0);
                
                document.getElementById('avgWpm').textContent = avgWpm;
                document.getElementById('avgAccuracy').textContent = avgAccuracy + '%';
                document.getElementById('totalBackspaces').textContent = totalBackspaces;
            }
            
            // Count total stages complete
            let stagesComplete = 0;
            Object.values(userProgress.completedStages).forEach(stages => {
                stagesComplete += stages.length;
            });
            document.getElementById('stagesComplete').textContent = stagesComplete;
            
            // Update history table
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';
            
            userProgress.history.slice(0, 20).forEach(entry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="padding: 12px;">${entry.date}</td>
                    <td style="padding: 12px;">${entry.lesson}</td>
                    <td style="padding: 12px;">${entry.stage}</td>
                    <td style="padding: 12px;">${entry.wpm}</td>
                    <td style="padding: 12px;">${entry.accuracy}%</td>
                    <td style="padding: 12px;">${entry.backspaces}</td>
                `;
            });
        }

        function saveProgress() {
            localStorage.setItem(`progress_${currentUser.username}`, JSON.stringify(userProgress));
        }

        function exportProgress() {
            const report = `TYPING PROGRESS REPORT
==============================
Student: ${currentUser.firstName} ${currentUser.lastName}
Student ID: ${currentUser.studentId}
Course: KBD1100 - Computer Keyboarding Skills
Date: ${new Date().toLocaleDateString()}

SUMMARY
-------
Average WPM: ${document.getElementById('avgWpm').textContent}
Average Accuracy: ${document.getElementById('avgAccuracy').textContent}
Total Backspaces: ${document.getElementById('totalBackspaces').textContent}
Stages Completed: ${document.getElementById('stagesComplete').textContent}

RECENT ACTIVITY
---------------
${userProgress.history.slice(0, 20).map(h => 
    `${h.date} | ${h.lesson} | Stage ${h.stage} | ${h.wpm} WPM | ${h.accuracy}% | ${h.backspaces} backspaces`
).join('\n')}`;

            // Create download
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `KBD1100_Progress_${currentUser.firstName}_${currentUser.lastName}_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('Progress report downloaded!');
        }

        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }

        // Track backspaces
        document.getElementById('typingInput').addEventListener('keydown', function(e) {
            if (e.key === 'Backspace') {
                backspaceCount++;
                document.getElementById('backspaceCount').textContent = backspaceCount;
            }
        });

        // Track typing for live updates
        document.getElementById('typingInput').addEventListener('input', function() {
            if (timerInterval) {
                updateStats();
            }
        });
    </script>
</body>
</html>